(function(){"use strict";const _e="0.4.0",x=1e3/60,oe=250,d=800,y=800,He=3,ne=100,Ye=300,se=2e3,j=14,je=200,X=500,le=50,re=3e3,ae=4,ce=50,Xe=100,Ue=14,fe=100,$e=200,Ge=16,ue=50,We=150,ze=12,U=60,K=48,q=40,Ke=1.5,qe=20,he=200,Ve=50,Qe=3e3,Ze=3,Je=500,et=2e3,tt=100,it=30;class ot{constructor(e,i){this.animationFrameId=0,this.lastTimestamp=0,this.accumulator=0,this.running=!1,this.tickCount=0,this.frameCount=0,this.fpsTimer=0,this.engineFps=0,this.renderFps=0,this.updateFn=e,this.renderFn=i}start(){this.running||(this.running=!0,this.lastTimestamp=0,this.accumulator=0,this.tickCount=0,this.frameCount=0,this.fpsTimer=0,this.animationFrameId=requestAnimationFrame(e=>this.tick(e)))}stop(){this.running=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=0)}isRunning(){return this.running}tick(e){if(!this.running)return;if(this.lastTimestamp===0){this.lastTimestamp=e,this.fpsTimer=e,this.animationFrameId=requestAnimationFrame(n=>this.tick(n));return}let i=e-this.lastTimestamp;for(this.lastTimestamp=e,i>oe&&(i=oe),this.accumulator+=i;this.accumulator>=x;)this.updateFn(x),this.accumulator-=x,this.tickCount++;const o=this.accumulator/x;this.renderFn(o),this.frameCount++,this.fpsTimer=this.fpsTimer||e,e-this.fpsTimer>=1e3&&(this.engineFps=this.tickCount,this.renderFps=this.frameCount,this.tickCount=0,this.frameCount=0,this.fpsTimer=e),this.animationFrameId=requestAnimationFrame(n=>this.tick(n))}tickHeadless(e){for(let i=0;i<e;i++)this.updateFn(x),this.tickCount++}}class nt{constructor(){this.bufferA=$(),this.bufferB=$(),this.currentState=this.bufferA,this.previousState=this.bufferB}swapBuffers(){const e=this.previousState;this.previousState=this.currentState,this.currentState=e,lt(this.currentState,this.previousState)}reset(){this.bufferA=$(),this.bufferB=$(),this.currentState=this.bufferA,this.previousState=this.bufferB}}function $(){return{currentTime:0,deltaTime:0,gameMode:"single",gameStatus:"menu",currentLevel:1,currentWave:1,waveStatus:"transition",players:[],enemies:[],projectiles:[],powerups:[],background:{stars:[],scrollSpeed:0},formation:st(),menu:{type:"start",selectedOption:0,options:["1 Player","2 Players"]}}}function st(){return{rows:0,cols:0,direction:1,speed:U,baseSpeed:U,offsetX:0,offsetY:0,cellWidth:K,cellHeight:q,standoffY:0}}function lt(t,e){t.currentTime=e.currentTime,t.deltaTime=e.deltaTime,t.gameMode=e.gameMode,t.gameStatus=e.gameStatus,t.currentLevel=e.currentLevel,t.currentWave=e.currentWave,t.waveStatus=e.waveStatus,t.players=e.players,t.enemies=e.enemies,t.projectiles=e.projectiles,t.powerups=e.powerups,t.background=e.background,t.formation=e.formation,t.menu=e.menu}function V(t){return{id:t,shipColor:t==="player1"?"red":"blue",position:{x:d/2,y:y-60},velocity:{x:0,y:0},rotation:0,isAlive:!0,isInvulnerable:!0,invulnerabilityTimer:2e3,lives:He,score:0,health:ne,maxHealth:ne,fireMode:"normal",fireCooldown:0,isThrusting:!1,isFiring:!1,collisionState:"none",input:{left:!1,right:!1,up:!1,down:!1,fire:!1},deathSequence:null}}const de=new Set(["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Space","Enter","Escape","KeyW","KeyA","KeyS","KeyD","KeyQ","KeyM"]);class rt{constructor(e=!1){this.keyState={},this.handleKeyDown=i=>{de.has(i.code)&&i.preventDefault(),this.keyState[i.code]=!0},this.handleKeyUp=i=>{de.has(i.code)&&i.preventDefault(),this.keyState[i.code]=!1},this.headless=e,!e&&typeof window<"u"&&(window.addEventListener("keydown",this.handleKeyDown),window.addEventListener("keyup",this.handleKeyUp))}getPlayerInput(){return{left:!!this.keyState.ArrowLeft,right:!!this.keyState.ArrowRight,up:!!this.keyState.ArrowUp,down:!!this.keyState.ArrowDown,fire:!!this.keyState.Space}}getPlayer2Input(){return{left:!!this.keyState.KeyA,right:!!this.keyState.KeyD,up:!!this.keyState.KeyW,down:!!this.keyState.KeyS,fire:!!this.keyState.KeyQ}}getMenuInput(){const e={up:!!this.keyState.ArrowUp,down:!!this.keyState.ArrowDown,confirm:!!this.keyState.Enter||!!this.keyState.Space,back:!!this.keyState.Escape};return e.up&&(this.keyState.ArrowUp=!1),e.down&&(this.keyState.ArrowDown=!1),e.confirm&&(this.keyState.Enter=!1,this.keyState.Space=!1),e.back&&(this.keyState.Escape=!1),e}getPauseToggle(){const e=!!this.keyState.Escape;return e&&(this.keyState.Escape=!1),e}getMuteToggle(){const e=!!this.keyState.KeyM;return e&&(this.keyState.KeyM=!1),e}injectPlayerInput(e){e.left!==void 0&&(this.keyState.ArrowLeft=e.left),e.right!==void 0&&(this.keyState.ArrowRight=e.right),e.up!==void 0&&(this.keyState.ArrowUp=e.up),e.down!==void 0&&(this.keyState.ArrowDown=e.down),e.fire!==void 0&&(this.keyState.Space=e.fire)}injectMenuInput(e){e.up&&(this.keyState.ArrowUp=!0),e.down&&(this.keyState.ArrowDown=!0),e.confirm&&(this.keyState.Enter=!0),e.back&&(this.keyState.Escape=!0)}clearAll(){this.keyState={}}destroy(){!this.headless&&typeof window<"u"&&(window.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("keyup",this.handleKeyUp))}}const G=j+2;function at(t,e){t.isAlive&&(ct(t,e),ft(t,e),ut(t,e),ht(t))}function ct(t,e){const i=t.input,o=Ye*e;if(t.velocity.x=0,t.velocity.y=0,i.left&&(t.velocity.x=-o),i.right&&(t.velocity.x=o),i.up&&(t.velocity.y=-o),i.down&&(t.velocity.y=o),t.velocity.x!==0&&t.velocity.y!==0){const n=1/Math.SQRT2;t.velocity.x*=n,t.velocity.y*=n}t.position.x+=t.velocity.x,t.position.y+=t.velocity.y,t.position.x=Math.max(G,Math.min(d-G,t.position.x)),t.position.y=Math.max(G,Math.min(y-G,t.position.y)),t.isThrusting=t.velocity.x!==0||t.velocity.y!==0}function ft(t,e){t.isInvulnerable&&(t.invulnerabilityTimer-=e*1e3,t.invulnerabilityTimer<=0&&(t.isInvulnerable=!1,t.invulnerabilityTimer=0))}function ut(t,e){t.fireCooldown>0&&(t.fireCooldown-=e*1e3,t.fireCooldown<0&&(t.fireCooldown=0))}function ht(t){t.isFiring=t.input.fire&&t.fireCooldown<=0,t.isFiring&&(t.fireCooldown=je)}function dt(t){t.lives<=0||(t.isAlive=!0,t.health=t.maxHealth,t.position={x:d/2,y:y-60},t.velocity={x:0,y:0},t.isInvulnerable=!0,t.invulnerabilityTimer=se,t.collisionState="none",t.deathSequence=null)}function pe(t,e,i=0){return t.isInvulnerable||!t.isAlive?!1:(t.health-=e,t.health<=0?(t.health=0,t.isAlive=!1,t.lives--,t.collisionState="destroyed",t.deathSequence={active:!0,startTime:i,duration:et,position:{x:t.position.x,y:t.position.y}},!0):(t.collisionState="colliding",t.isInvulnerable=!0,t.invulnerabilityTimer=se,!1))}let me=0;function pt(t,e){return{id:`laser-${me++}`,type:"laser",owner:e,position:{x:t.x,y:t.y},velocity:{x:0,y:-X},rotation:0,speed:X,damage:le,isActive:!0,lifetime:0,maxLifetime:re,collisionRadius:ae,hasCollided:!1}}function mt(t,e){return{id:`laser-${me++}`,type:"laser",owner:e,position:{x:t.x,y:t.y},velocity:{x:0,y:X},rotation:Math.PI,speed:X,damage:le,isActive:!0,lifetime:0,maxLifetime:re,collisionRadius:ae,hasCollided:!1}}function yt(t,e){t.isActive&&(t.position.x+=t.velocity.x*e,t.position.y+=t.velocity.y*e,t.lifetime+=e*1e3,(t.position.y<-20||t.position.y>y+20||t.lifetime>=t.maxLifetime||t.hasCollided)&&(t.isActive=!1))}function vt(t,e){for(const i of t.projectiles)yt(i,e);t.projectiles=t.projectiles.filter(i=>i.isActive)}function gt(t){for(const e of t.players)if(e.isFiring&&e.isAlive){const i=pt({x:e.position.x,y:e.position.y-16},{type:"player",id:e.id});t.projectiles=[...t.projectiles,i]}}const St=50;function ye(t,e){const i=e*K,o=(d-i)/2;return{rows:t,cols:e,direction:1,speed:U,baseSpeed:U,offsetX:o,offsetY:-t*q,cellWidth:K,cellHeight:q,standoffY:y-St-j}}function wt(t,e){const i=t.formation,o=t.enemies.filter(f=>f.isAlive);if(o.length===0)return;if(t.enemies.some(f=>f.isAlive&&f.flightPathState)){Q(t);return}const s=i.rows*i.cols,l=o.length;if(s>0&&l>0){const f=1-l/s;i.speed=i.baseSpeed*(1+f*Ke)}if(i.offsetY<20){i.offsetY+=i.speed*e*2,Q(t);return}const r=i.direction*i.speed*e;i.offsetX+=r;const{minCol:c,maxCol:u}=Mt(o),a=i.offsetX+c*i.cellWidth;if(i.offsetX+(u+1)*i.cellWidth>d||a<0){i.direction*=-1,i.offsetX-=r;const f=At(o);i.offsetY+(f+1)*i.cellHeight<i.standoffY&&(i.offsetY+=qe)}Q(t)}function Q(t){const e=t.formation;for(const i of t.enemies)i.isAlive&&(i.diveState||i.flightPathState||(i.position.x=e.offsetX+(i.formationCol+.5)*e.cellWidth,i.position.y=e.offsetY+(i.formationRow+.5)*e.cellHeight))}function Mt(t){let e=1/0,i=-1/0;for(const o of t)o.formationCol<e&&(e=o.formationCol),o.formationCol>i&&(i=o.formationCol);return{minCol:e,maxCol:i}}function At(t){let e=0;for(const i of t)i.formationRow>e&&(e=i.formationRow);return e}function _(){const t=[];for(let e=0;e<tt;e++)t.push(Et());return{stars:t,scrollSpeed:it}}function Et(){const t=Math.random()*.8+.2;return{position:{x:Math.random()*d,y:Math.random()*y},depth:t,size:t*2+.5,brightness:t*.6+.4}}function Pt(t,e){for(const i of t.stars)i.position.y+=t.scrollSpeed*i.depth*e,i.position.y>y&&(i.position.y-=y,i.position.x=Math.random()*d)}let Rt=0;function Z(t,e){return{id:`enemyA-${Rt++}`,type:"A",position:{x:0,y:0},velocity:{x:0,y:0},rotation:Math.PI,isAlive:!0,health:ce,maxHealth:ce,fireMode:"none",fireCooldown:0,fireRate:0,isThrusting:!1,isFiring:!1,collisionState:"none",scoreValue:Xe,collisionRadius:Ue,formationRow:t,formationCol:e,diveState:null,flightPathState:null}}function ve(t,e){return t.isAlive?(t.health-=e,t.health<=0?(t.health=0,t.isAlive=!1,t.collisionState="destroyed",!0):(t.collisionState="colliding",!1)):!1}function J(t,e){const i=t.x-e.x,o=t.y-e.y;return Math.sqrt(i*i+o*o)}function Ct(t){Tt(t),Lt(t),bt(t)}function Tt(t){for(const e of t.players)if(!(!e.isAlive||e.isInvulnerable))for(const i of t.enemies){if(!i.isAlive)continue;J(e.position,i.position)<j+i.collisionRadius&&(pe(e,e.maxHealth,t.currentTime),ve(i,i.maxHealth))}}function Lt(t){for(const e of t.projectiles)if(!(!e.isActive||e.hasCollided)&&e.owner.type==="player")for(const i of t.enemies){if(!i.isAlive)continue;if(J(e.position,i.position)<e.collisionRadius+i.collisionRadius){if(e.hasCollided=!0,e.isActive=!1,ve(i,e.damage)){const s=t.players.find(l=>l.id===e.owner.id);s&&(s.score+=i.scoreValue)}break}}}function bt(t){for(const e of t.projectiles)if(!(!e.isActive||e.hasCollided)&&e.owner.type==="enemy")for(const i of t.players){if(!i.isAlive||i.isInvulnerable)continue;if(J(e.position,i.position)<e.collisionRadius+j){e.hasCollided=!0,e.isActive=!1,pe(i,e.damage,t.currentTime);break}}}let kt=0;function Ot(t,e){return{id:`enemyB-${kt++}`,type:"B",position:{x:0,y:0},velocity:{x:0,y:0},rotation:Math.PI,isAlive:!0,health:fe,maxHealth:fe,fireMode:"laser",fireCooldown:0,fireRate:3e3,isThrusting:!1,isFiring:!1,collisionState:"none",scoreValue:$e,collisionRadius:Ge,formationRow:t,formationCol:e,diveState:null,flightPathState:null}}let It=0;function Dt(t,e){return{id:`enemyC-${It++}`,type:"C",position:{x:0,y:0},velocity:{x:0,y:0},rotation:Math.PI,isAlive:!0,health:ue,maxHealth:ue,fireMode:"bullet",fireCooldown:0,fireRate:2e3,isThrusting:!1,isFiring:!1,collisionState:"none",scoreValue:We,collisionRadius:ze,formationRow:t,formationCol:e,diveState:null,flightPathState:null}}const Ft=250,Nt={A:1,B:.8,C:1.3};function Bt(t,e){if(t.length===2)return{x:t[0].x+(t[1].x-t[0].x)*e,y:t[0].y+(t[1].y-t[0].y)*e};if(t.length===3){const r=1-e;return{x:r*r*t[0].x+2*r*e*t[1].x+e*e*t[2].x,y:r*r*t[0].y+2*r*e*t[1].y+e*e*t[2].y}}const i=1-e,o=i*i,n=o*i,s=e*e,l=s*e;return{x:n*t[0].x+3*o*e*t[1].x+3*i*s*t[2].x+l*t[3].x,y:n*t[0].y+3*o*e*t[1].y+3*i*s*t[2].y+l*t[3].y}}function L(t,e){return{x:e.offsetX+(t.formationCol+.5)*e.cellWidth,y:e.offsetY+(t.formationRow+.5)*e.cellHeight}}function xt(t,e,i){if(t==="grid")return;const n={"w-curve":Ht,chiral:Yt,diagonal:jt,"side-wave":Xt,"m-shape":Ut,"inverted-v":$t}[t];n&&n(e,i)}function _t(t,e){for(const i of t.enemies){if(!i.isAlive||!i.flightPathState)continue;const o=i.flightPathState,n=o.speed,s=o.controlPoints[0],l=o.controlPoints[o.controlPoints.length-1],r=l.x-s.x,c=l.y-s.y,u=Math.sqrt(r*r+c*c)*1.5,a=u>0?n*e/u:1;o.progress=Math.min(1,o.progress+a);const h=Bt(o.controlPoints,o.progress);if(i.position.x=h.x,i.position.y=h.y,o.progress>=1){const f=t.formation;i.position.x=f.offsetX+(i.formationCol+.5)*f.cellWidth,i.position.y=f.offsetY+(i.formationRow+.5)*f.cellHeight,i.flightPathState=null}}}function O(t,e,i){const o=L(t,i),n=[...e];n[n.length-1]=o,t.flightPathState={progress:0,controlPoints:n,targetSlot:o,speed:Ft*(Nt[t.type]??1)},t.position.x=n[0].x,t.position.y=n[0].y}function Ht(t,e){const i=d/2,o=t.length;for(let n=0;n<o;n++){const s=t[n],l=L(s,e),r=Math.floor(n/o*5),u=r%2===0?-150:150,h=[{x:i+(n-o/2)*10,y:-20},{x:i+u,y:200+r*30},{x:l.x+u*.2,y:l.y-40},l];O(s,h,e)}}function Yt(t,e){const i=d/2,o=y*.4,n=t.length;for(let s=0;s<n;s++){const l=t[s],r=L(l,e),c=s%4;let u,a;c===0?(u=20,a=20):c===1?(u=d-20,a=20):c===2?(u=d-20,a=y*.5):(u=20,a=y*.5);const h=c*Math.PI/2+Math.PI*.6,f=120,m=i+Math.cos(h)*f,v=o+Math.sin(h)*f*.5,k=[{x:u,y:a},{x:m,y:v},{x:r.x+(u>i?30:-30),y:r.y-30},r];O(l,k,e)}}function jt(t,e){const i=t.length;for(let o=0;o<i;o++){const n=t[o],s=L(n,e),l=d+20,r=30+o*15,c=[{x:l,y:r},{x:d*.65,y:y*.25+o*5},{x:s.x+50,y:s.y-30},s];O(n,c,e)}}function Xt(t,e){const i=t.length,o=d/2;for(let n=0;n<i;n++){const s=t[n],l=L(s,e),r=n%2===0,c=r?-20:d+20,u=60+n%8*40,a=100,h=r?o+a:o-a,f=[{x:c,y:u},{x:h,y:y*.3+n%5*20},{x:l.x+(r?-40:40),y:l.y-30},l];O(s,f,e)}}function Ut(t,e){const i=d/2,o=t.length;for(let n=0;n<o;n++){const s=t[n],l=L(s,e),r=o>1?n/(o-1):.5,c=Math.abs(Math.sin(r*Math.PI*2))*120,u=i+(r-.5)*d*.7,a=[{x:u,y:-15},{x:u,y:80+c},{x:l.x,y:l.y-30},l];O(s,a,e)}}function $t(t,e){const i=d/2,o=t.length;for(let n=0;n<o;n++){const s=t[n],l=L(s,e),r=Math.floor(o/2),c=n<r,u=c?n:n-r,a=c?-15:d+15,h=40+u*20,f=y*.25,m=i+(c?-20:20),v=[{x:a,y:h},{x:m,y:f},{x:l.x+(c?-30:30),y:l.y-40},l];O(s,v,e)}}const Gt=3e3,ge={A:Z,B:Ot,C:Dt};class Wt{constructor(){this.levels=new Map,this.waveTransitionTimer=0}registerLevel(e){this.levels.set(e.levelNumber,e)}startLevel(e,i){const o=this.levels.get(i);o&&(e.currentLevel=i,e.currentWave=1,e.waveStatus="transition",this.waveTransitionTimer=0,this.spawnWave(e,o.waves[0]))}update(e){if(e.waveStatus==="transition"){this.waveTransitionTimer+=e.deltaTime,(this.waveTransitionTimer>=Gt||e.currentWave===1)&&(e.waveStatus="active",this.waveTransitionTimer=0);return}if(e.waveStatus!=="active")return;if(e.enemies.filter(o=>o.isAlive).length===0&&e.enemies.length>0){e.waveStatus="complete";const o=this.levels.get(e.currentLevel);o&&e.currentWave<o.waves.length&&(e.currentWave++,e.waveStatus="transition",this.waveTransitionTimer=0,this.spawnWave(e,o.waves[e.currentWave-1]))}}getTotalWaves(e){const i=this.levels.get(e);return i?i.waves.length:0}hasLevel(e){return this.levels.has(e)}spawnWave(e,i){if(e.enemies=[],e.projectiles=[],i.slots&&i.slots.length>0){let n=0,s=0;for(const l of i.slots)l.row>n&&(n=l.row),l.col>s&&(s=l.col);e.formation=ye(n+1,s+1);for(const l of i.slots){const r=ge[l.type]??Z;e.enemies.push(r(l.row,l.col))}}else{let n=0,s=0;for(const r of i.enemies)n+=r.rows,r.cols>s&&(s=r.cols);e.formation=ye(n,s);let l=0;for(const r of i.enemies){const c=ge[r.type]??Z;for(let u=0;u<r.rows;u++)for(let a=0;a<r.cols;a++)e.enemies.push(c(l+u,a));l+=r.rows}}const o=i.formation??i.enemies[0]?.formation??"grid";o!=="grid"&&(e.formation.offsetY=40,xt(o,e.enemies,e.formation))}}let zt=0;function Kt(t,e){return{id:`bullet-${zt++}`,type:"bullet",owner:e,position:{x:t.x,y:t.y},velocity:{x:0,y:he},rotation:Math.PI,speed:he,damage:Ve,isActive:!0,lifetime:0,maxLifetime:Qe,collisionRadius:Ze,hasCollided:!1}}const qt={laser:{base:3e3,jitter:500},bullet:{base:2e3,jitter:500}};class Vt{constructor(){this.cooldowns=new Map}update(e,i){const o=e.enemies.filter(s=>s.isAlive);if(o.length===0)return;const n=this.getFrontRowEnemyIds(o);for(const s of o){if(s.fireMode==="none"||!n.has(s.id))continue;this.cooldowns.has(s.id)||this.cooldowns.set(s.id,this.randomCooldown(s.fireMode));let l=this.cooldowns.get(s.id);l-=i*1e3,l<=0&&(this.fireProjectile(e,s),l=this.randomCooldown(s.fireMode)),this.cooldowns.set(s.id,l)}for(const[s]of this.cooldowns)o.some(l=>l.id===s)||this.cooldowns.delete(s)}getFrontRowEnemyIds(e){const i=new Map;for(const o of e){const n=i.get(o.formationCol);(!n||o.position.y>n.y)&&i.set(o.formationCol,{id:o.id,y:o.position.y})}return new Set([...i.values()].map(o=>o.id))}fireProjectile(e,i){const o={type:"enemy",id:i.id},n={x:i.position.x,y:i.position.y+16};let s;i.fireMode==="laser"?s=mt(n,o):s=Kt(n,o),e.projectiles=[...e.projectiles,s]}randomCooldown(e){const i=qt[e];return i?i.base+(Math.random()*2-1)*i.jitter:5e3}reset(){this.cooldowns.clear()}}const Qt=2,ee=3,Zt=300,Jt={A:1,B:.7,C:1.5},ei=40,I=.2,W=.5;class ti{constructor(){this.activeDivers=new Set,this.cooldownTimer=ee}update(e,i){const o=e.enemies.filter(n=>n.isAlive);if(o.length!==0){this.cooldownTimer-=i,this.activeDivers.size<Qt&&this.cooldownTimer<=0&&this.initiateDive(e,o);for(const n of o)n.diveState&&this.updateDivingEnemy(n,e,i);for(const n of this.activeDivers)o.some(s=>s.id===n)||this.activeDivers.delete(n)}}initiateDive(e,i){const o=i.filter(r=>!r.diveState&&!r.flightPathState&&!this.activeDivers.has(r.id));if(o.length===0)return;const n=o[Math.floor(Math.random()*o.length)],s=e.players.filter(r=>r.isAlive),l=s.length>0?s[Math.floor(Math.random()*s.length)].position.x:d/2;n.diveState={phase:"break",progress:0,targetX:l,startPos:{x:n.position.x,y:n.position.y}},this.activeDivers.add(n.id),this.cooldownTimer=ee}updateDivingEnemy(e,i,o){const n=e.diveState,l=Zt*(Jt[e.type]??1)*o/y;if(n.progress+=l,n.progress<=I){const r=n.progress/I;e.position.x=n.startPos.x+(n.targetX-n.startPos.x)*r*.5,e.position.y=n.startPos.y+r*100}else if(n.progress<=I+W){const r=(n.progress-I)/W,c=n.startPos.x+(n.targetX-n.startPos.x)*.5,u=n.startPos.y+100;e.position.x=c+(n.targetX-c)*r,e.position.y=u+r*(y*.6)}else{n.phase="sweep";const r=(n.progress-I-W)/(1-I-W),c=n.startPos.y+100+y*.6;e.position.x=n.targetX,e.position.y=c+r*y*.4}e.position.y>y+ei&&this.returnToFormation(e,i)}returnToFormation(e,i){const o=i.formation;e.position.x=o.offsetX+(e.formationCol+.5)*o.cellWidth,e.position.y=o.offsetY+(e.formationRow+.5)*o.cellHeight,e.diveState=null,this.activeDivers.delete(e.id)}getActiveDiverCount(){return this.activeDivers.size}isDiving(e){return this.activeDivers.has(e)}reset(){this.activeDivers.clear(),this.cooldownTimer=ee}}let b,ii=.3;function oi(...t){return Se(we(...t))}function Se(t){if(!b)try{b=new AudioContext}catch{return}const e=b.createBuffer(1,t.length,b.sampleRate),i=e.getChannelData(0);for(let s=0;s<t.length;s++)i[s]=t[s];const o=b.createBufferSource(),n=b.createGain();return n.gain.value=ii,o.buffer=e,o.connect(n),n.connect(b.destination),o.start(),o}function we(t=1,e=.05,i=220,o=0,n=0,s=.1,l=0,r=1,c=0,u=0,a=0,h=0,f=0,m=0,v=0,k=0,T=0,C=1,P=0,D=0){const w=Math.PI*2;let De=c*=500*w/44100/44100,N=i*=(1+e*2*Math.random()-e)*w/44100,B=[],M=0,Fe=0,R=0,z=1,vi=0,Ne=0,H=0,Y;o=o*44100+9,P=P*44100+9,n=n*44100,s=s*44100,T=T*44100,u*=500*w/44100**3,v*=w/44100,a*=w/44100,h*=44100,f=f*44100|0;const Be=o+P+n+s+T|0;for(;R<Be;B[R++]=H*t){++Ne>=100&&(Ne=0,H=0),f&&!(++vi%f)&&(i=N,c=De,z=z||1),h&&!(z%h)&&(i+=a,N+=a,z=0),i+=c+=u,M+=i-i*m*(Math.sin(R)**2+.5);const xe=R<o?R/o:R<o+P?1+(C-1)*((R-o)/P):R<o+P+n?C:R<Be-T?C*(1-(R-o-P-n)/s):0;Y=l===0?Math.sin(M):l===1?Math.sin(M)**3:l===2?Math.sin(M%w>Math.PI?-1:1):l===3?(M%w/w*2-1+(M%w/w*2-1>0?-1:1))*.7:0,Y*=1-D+D*Math.sin(w*R/44100/(1/(D*10|0))),v&&(Fe+=v,Y*=Math.sin(Fe)),k?H+=Y*xe-H:H=Y*xe}return B}const Me={playerFire:[.5,.01,800,0,.02,.04,2,1,20,0,0,0,0,0,0,0,0,.5,.02,0],enemyFire:[.4,.02,400,0,.02,.06,2,1,-10,0,0,0,0,0,0,0,0,.5,.02,0],explosion:[.6,.05,200,0,.06,.2,3,1,0,0,0,0,0,1,0,0,0,.3,.1,0],playerDeath:[.8,.05,150,.01,.15,.4,3,1,-5,0,0,0,0,1,0,0,.1,.2,.15,0],menuSelect:[.3,0,600,0,.01,.02,0,1,0,0,200,.01,0,0,0,0,0,.8,0,0],hitA:[.5,.02,600,0,.03,.06,3,1,15,0,0,0,0,.3,0,0,0,.4,.04,0],hitB:[.7,.04,300,0,.06,.15,3,1,-8,-2,0,0,0,.8,0,0,0,.3,.1,0],hitC:[.6,.03,500,0,.04,.08,3,1,25,3,100,.02,0,.5,0,0,0,.4,.05,0]},S=class S{static init(){S.initialized=!0}static play(e){if(S.muted)return;const i=Me[e];if(i)try{oi(...i)}catch{}}static setMuted(e){S.muted=e}static isMuted(){return S.muted}static toggleMute(){return S.muted=!S.muted,S.muted}static reset(){S.muted=!1,S.initialized=!1}static getPreset(e){return Me[e]}};S.muted=!1,S.initialized=!1;let A=S;function ni(t){const[e,i,o,n]=t,s=n/60*44100/4|0,l=o[0].length,r=i[0]?.length??0,c=[];for(let h=0;h<r;h++)c.push([]);for(let h=0;h<l;h++)for(let f=0;f<r;f++){const m=o[f][h],v=i[m];if(!v||!v[f])continue;const k=v[f],T=k.length/3|0;for(let C=0;C<T;C++){const P=k[C*3],D=k[C*3+1];if(P!==void 0&&P>0&&D!==void 0){const F=[...e[D]||[]],w=F[2]||220;F[2]=w*2**((P-60)/12);const N=we(...F).slice(0,s);c[f].length;const B=(h*T+C)*s;for(;c[f].length<B;)c[f].push(0);for(let M=0;M<N.length;M++)c[f].length<=B+M?c[f].push(N[M]):c[f][B+M]+=N[M]}else{const F=(h*T+C+1)*s;for(;c[f].length<F;)c[f].push(0)}}}const u=Math.max(...c.map(h=>h.length),0),a=new Array(u).fill(0);for(const h of c)for(let f=0;f<h.length;f++)a[f]+=h[f];if(r>1){const h=1/r;for(let f=0;f<a.length;f++)a[f]*=h}return a}const si={menu:[[[.3,0,220,.1,.3,.2,0,1,0,0,0,0,0,0,0,0,0,.7,.05,0],[.25,0,110,0,.15,.1,2,1,0,0,0,0,0,0,0,0,0,.5,.02,0]],[[[60,0,0,64,0,0,67,0,0,64,0,0,60,0,0,62,0,0,65,0,0,62,0,0],[48,1,0,0,void 0,0,48,1,0,0,void 0,0,45,1,0,0,void 0,0,45,1,0,0,void 0,0]],[[65,0,0,67,0,0,69,0,0,67,0,0,65,0,0,64,0,0,62,0,0,60,0,0],[41,1,0,0,void 0,0,41,1,0,0,void 0,0,43,1,0,0,void 0,0,48,1,0,0,void 0,0]]],[[0,1,0,1],[0,1,0,1]],90],gameplay:[[[.25,0,220,.12,.35,.25,0,1,0,0,0,0,0,0,0,0,0,.6,.08,0],[.2,0,55,.02,.2,.15,0,1,0,0,0,0,0,0,0,0,0,.5,.04,0],[.15,0,440,.01,.1,.12,1,1,0,0,0,0,0,0,0,0,0,.4,.03,.3]],[[[60,0,0,0,void 0,0,64,0,0,0,void 0,0,67,0,0,0,void 0,0,64,0,0,0,void 0,0],[48,1,0,0,void 0,0,48,1,0,0,void 0,0,43,1,0,0,void 0,0,45,1,0,0,void 0,0],[72,2,0,0,void 0,0,76,2,0,0,void 0,0,79,2,0,0,void 0,0,76,2,0,0,void 0,0]],[[64,0,0,0,void 0,0,67,0,0,0,void 0,0,69,0,0,0,void 0,0,67,0,0,0,void 0,0],[45,1,0,0,void 0,0,43,1,0,0,void 0,0,48,1,0,0,void 0,0,45,1,0,0,void 0,0],[79,2,0,0,void 0,0,81,2,0,0,void 0,0,84,2,0,0,void 0,0,79,2,0,0,void 0,0]],[[60,0,0,0,void 0,0,0,void 0,0,0,void 0,0,62,0,0,0,void 0,0,0,void 0,0,0,void 0,0],[36,1,0,0,void 0,0,0,void 0,0,0,void 0,0,40,1,0,0,void 0,0,0,void 0,0,0,void 0,0],[72,2,0,0,void 0,0,0,void 0,0,0,void 0,0,74,2,0,0,void 0,0,0,void 0,0,0,void 0,0]]],[[0,0,1,2,0,1],[0,0,1,2,0,1],[0,0,1,2,0,1]],105]},p=class p{static play(e){if(p.currentTrack!==e||!p.playing)p.stop();else return;if(p.currentTrack=e,A.isMuted()){p.playing=!0;return}p.startPlayback(e)}static stop(){if(p.sourceNode){try{p.sourceNode.stop()}catch{}p.sourceNode=null}p.currentTrack=null,p.playing=!1}static getCurrentTrack(){return p.currentTrack}static isPlaying(){return p.playing}static onMuteChanged(e){if(e){if(p.sourceNode){try{p.sourceNode.stop()}catch{}p.sourceNode=null}}else p.currentTrack&&p.playing&&p.startPlayback(p.currentTrack)}static reset(){p.stop()}static startPlayback(e){const i=si[e];if(i)try{const o=ni(i),n=Se(o);n&&(n.loop=!0,p.sourceNode=n,p.playing=!0)}catch{p.playing=!0}}};p.currentTrack=null,p.sourceNode=null,p.playing=!1;let E=p;const li={levelNumber:1,name:"First Contact",waves:[{waveNumber:1,delay:0,enemies:[{type:"A",count:20,formation:"grid",rows:5,cols:4,spawnDelay:0}]},{waveNumber:2,delay:3e3,enemies:[{type:"A",count:16,formation:"grid",rows:4,cols:4,spawnDelay:0},{type:"B",count:4,formation:"grid",rows:1,cols:4,spawnDelay:0}]},{waveNumber:3,delay:3e3,enemies:[{type:"A",count:12,formation:"grid",rows:3,cols:4,spawnDelay:0},{type:"B",count:4,formation:"grid",rows:1,cols:4,spawnDelay:0},{type:"C",count:4,formation:"grid",rows:1,cols:4,spawnDelay:0}]},{waveNumber:4,delay:3e3,enemies:[{type:"A",count:8,formation:"grid",rows:2,cols:4,spawnDelay:0},{type:"B",count:8,formation:"grid",rows:2,cols:4,spawnDelay:0},{type:"C",count:4,formation:"grid",rows:1,cols:4,spawnDelay:0}]},{waveNumber:5,delay:3e3,enemies:[{type:"A",count:4,formation:"grid",rows:1,cols:4,spawnDelay:0},{type:"B",count:8,formation:"grid",rows:2,cols:4,spawnDelay:0},{type:"C",count:8,formation:"grid",rows:2,cols:4,spawnDelay:0}]}]};function g(t,e){return e.map(([i,o])=>({type:t,row:i,col:o}))}const ri={levelNumber:2,name:"Escalation",waves:[{waveNumber:1,delay:0,enemies:[],formation:"w-curve",slots:[...g("A",[[0,0],[0,1],[0,7],[0,8],[1,1],[1,2],[1,6],[1,7],[2,2],[2,3],[2,5],[2,6]]),...g("B",[[3,3],[3,4],[3,5],[4,4]])]},{waveNumber:2,delay:3e3,enemies:[],formation:"chiral",slots:[...g("A",[[0,3],[0,4],[1,2],[1,5],[2,1],[2,6],[3,2],[3,5],[4,3],[4,4]]),...g("B",[[1,3],[1,4],[2,2],[2,3],[2,4],[2,5],[3,3],[3,4]])]},{waveNumber:3,delay:3e3,enemies:[],formation:"diagonal",slots:[...g("B",[[0,0],[0,1],[0,2],[1,2],[1,3],[1,4],[2,4],[2,5],[2,6]]),...g("C",[[3,6],[3,7],[3,8]])]},{waveNumber:4,delay:3e3,enemies:[],formation:"side-wave",slots:[...g("A",[[0,0],[0,1],[0,2],[1,0],[1,1],[1,2],[2,0],[2,1],[2,2]]),...g("B",[[0,6],[0,7],[0,8],[1,6],[1,7],[1,8],[2,6],[2,7],[2,8]]),...g("C",[[3,4],[4,4]])]},{waveNumber:5,delay:3e3,enemies:[],formation:"m-shape",slots:[...g("B",[[0,3],[0,4],[1,2],[1,3],[1,4],[1,5],[2,1],[2,6]]),...g("C",[[2,2],[2,5],[3,3],[3,4],[4,3],[4,4],[5,3],[5,4]])]},{waveNumber:6,delay:3e3,enemies:[],formation:"inverted-v",slots:[...g("A",[[0,3],[0,4],[0,5],[4,3],[4,4],[4,5]]),...g("B",[[0,2],[0,6],[1,1],[1,7],[2,0],[2,8],[3,1],[3,7],[4,2],[4,6]]),...g("C",[[1,2],[1,6],[3,2],[3,6]])]}]};class ai{constructor(e={}){this.headless=e.headless??!1,this.renderer=e.renderer??null,this.stateManager=new nt,this.inputHandler=new rt(this.headless),this.gameLoop=new ot(i=>this.update(i),i=>this.render(i)),this.levelManager=new Wt,this.levelManager.registerLevel(li),this.levelManager.registerLevel(ri),this.enemyFiringManager=new Vt,this.diveManager=new ti,this.stateManager.currentState.background=_(),E.play("menu")}start(){this.headless||this.gameLoop.start()}stop(){this.gameLoop.stop()}tickHeadless(e){this.gameLoop.tickHeadless(e)}getState(){return this.stateManager.currentState}getPreviousState(){return this.stateManager.previousState}update(e){this.stateManager.swapBuffers();const i=this.stateManager.currentState,o=e/1e3;switch(i.deltaTime=e,i.currentTime+=e,i.gameStatus){case"menu":this.updateMenu(i);break;case"playing":this.updatePlaying(i,o);break;case"paused":this.updatePaused(i);break;case"gameover":this.updateGameOver(i);break;case"levelcomplete":this.updateLevelComplete(i);break}}updateMenu(e){const i=this.inputHandler.getMenuInput();if(e.menu&&(i.down&&(e.menu={...e.menu,selectedOption:Math.min(e.menu.selectedOption+1,e.menu.options.length-1)}),i.up&&(e.menu={...e.menu,selectedOption:Math.max(e.menu.selectedOption-1,0)}),i.confirm)){A.play("menuSelect");const o=e.menu.options[e.menu.selectedOption];o==="1 Player"?(e.gameMode="single",this.startGame(e)):o==="2 Players"&&(e.gameMode="co-op",this.startGame(e))}}startGame(e){if(e.gameStatus="playing",e.menu=null,e.projectiles=[],E.play("gameplay"),e.gameMode==="co-op"){const i=V("player1");i.position.x=d*.33;const o=V("player2");o.position.x=d*.66,e.players=[i,o]}else e.players=[V("player1")];this.enemyFiringManager.reset(),this.diveManager.reset(),this.levelManager.startLevel(e,1)}updatePlaying(e,i){if(this.inputHandler.getPauseToggle()){e.gameStatus="paused",e.menu={type:"pause",selectedOption:0,options:["Resume","Main Menu"]};return}if(this.inputHandler.getMuteToggle()){const a=A.toggleMute();E.onMuteChanged(a)}for(const a of e.players)a.deathSequence?.active||(a.id==="player1"?a.input=this.inputHandler.getPlayerInput():a.id==="player2"&&(a.input=this.inputHandler.getPlayer2Input()));for(const a of e.players)a.deathSequence?.active||at(a,i);const o=e.projectiles.length;gt(e),e.projectiles.length-o>0&&A.play("playerFire"),vt(e,i),e.formation&&e.enemies.length>0&&wt(e,i),_t(e,i),this.diveManager.update(e,i);const s=e.projectiles.length;this.enemyFiringManager.update(e,i),e.projectiles.length>s&&A.play("enemyFire"),e.background&&Pt(e.background,i),e.currentWave;const l=e.waveStatus;if(this.levelManager.update(e),l==="active"&&e.waveStatus!=="active"){for(const a of e.players)a.isAlive&&(a.score+=Je);if(e.waveStatus==="complete"){e.gameStatus="levelcomplete",E.stop();const a=e.players.reduce((f,m)=>f+m.score,0),h=this.levelManager.hasLevel(e.currentLevel+1);e.menu={type:"levelcomplete",selectedOption:0,options:h?["Next Level","Main Menu"]:["Main Menu"],data:{finalScore:a,wave:e.currentWave,level:e.currentLevel}};return}}const r=new Map(e.enemies.map(a=>[a.id,{alive:a.isAlive,type:a.type}])),c=e.players.filter(a=>a.isAlive).length;Ct(e);for(const a of e.enemies)if(r.get(a.id)?.alive&&!a.isAlive){const f=`hit${a.type}`;A.play(f)}e.players.filter(a=>a.isAlive).length<c&&A.play("playerDeath");for(const a of e.players)a.deathSequence?.active&&e.currentTime-a.deathSequence.startTime>=a.deathSequence.duration&&(a.deathSequence.active=!1,a.lives>0&&dt(a));this.checkGameOver(e)}updatePaused(e){const i=this.inputHandler.getMenuInput();if(e.menu){if(i.back){e.gameStatus="playing",e.menu=null;return}if(i.down&&(e.menu={...e.menu,selectedOption:Math.min(e.menu.selectedOption+1,e.menu.options.length-1)}),i.up&&(e.menu={...e.menu,selectedOption:Math.max(e.menu.selectedOption-1,0)}),i.confirm){A.play("menuSelect");const o=e.menu.options[e.menu.selectedOption];o==="Resume"?(e.gameStatus="playing",e.menu=null):o==="Main Menu"&&(this.stateManager.reset(),this.stateManager.currentState.background=_(),E.play("menu"))}}}updateGameOver(e){const i=this.inputHandler.getMenuInput();if(e.menu&&(i.down&&(e.menu={...e.menu,selectedOption:Math.min(e.menu.selectedOption+1,e.menu.options.length-1)}),i.up&&(e.menu={...e.menu,selectedOption:Math.max(e.menu.selectedOption-1,0)}),i.confirm)){A.play("menuSelect");const o=e.menu.options[e.menu.selectedOption];o==="Restart"?(this.stateManager.reset(),this.stateManager.currentState.background=_(),this.startGame(this.stateManager.currentState)):o==="Main Menu"&&(this.stateManager.reset(),this.stateManager.currentState.background=_(),E.play("menu"))}}updateLevelComplete(e){const i=this.inputHandler.getMenuInput();if(e.menu&&(i.down&&(e.menu={...e.menu,selectedOption:Math.min(e.menu.selectedOption+1,e.menu.options.length-1)}),i.up&&(e.menu={...e.menu,selectedOption:Math.max(e.menu.selectedOption-1,0)}),i.confirm)){A.play("menuSelect");const o=e.menu.options[e.menu.selectedOption];if(o==="Next Level"){const n=e.currentLevel+1;e.enemies=[],e.projectiles=[],e.gameStatus="playing",e.menu=null,this.enemyFiringManager.reset(),this.diveManager.reset(),E.play("gameplay"),this.levelManager.startLevel(e,n)}else o==="Main Menu"&&(this.stateManager.reset(),this.stateManager.currentState.background=_(),E.play("menu"))}}checkGameOver(e){if(e.players.some(n=>n.deathSequence?.active))return;const o=e.players.filter(n=>n.isAlive||n.lives>0);if(e.players.length>0&&o.length===0){e.gameStatus="gameover",E.play("menu");const n=e.players.find(r=>r.id==="player1"),s=e.players.find(r=>r.id==="player2"),l=n?.score??0;e.menu={type:"gameover",selectedOption:0,options:["Restart","Main Menu"],data:{finalScore:l,...s?{p2Score:s.score}:{}}}}}render(e){this.renderer&&this.renderer.render(this.stateManager.currentState,this.stateManager.previousState,e)}destroy(){this.stop(),E.stop(),this.inputHandler.destroy(),this.renderer&&this.renderer.destroy()}}const ci=`
  .menu-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: rgba(0, 0, 0, 0.85);
    font-family: 'Courier New', monospace;
    color: #fff;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 1000;
  }

  .menu-overlay.visible {
    opacity: 1;
  }

  .menu-title {
    font-size: 52px;
    font-weight: bold;
    color: #ffff00;
    margin-bottom: 12px;
  }

  .menu-title.gameover {
    color: #ff4444;
  }

  .menu-title.levelcomplete {
    color: #44ff44;
  }

  .menu-subtitle {
    font-size: 16px;
    color: #88aacc;
    margin-bottom: 30px;
  }

  .menu-controls {
    font-size: 14px;
    color: #888;
    margin-bottom: 8px;
  }

  .menu-controls-group {
    margin-bottom: 24px;
  }

  .menu-score {
    font-size: 24px;
    color: #fff;
    margin-bottom: 8px;
  }

  .menu-p2score {
    font-size: 18px;
    color: #4488ff;
    margin-bottom: 16px;
  }

  .menu-options {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .menu-option {
    font-size: 22px;
    color: #666;
    padding: 6px 0;
    transition: color 0.15s;
  }

  .menu-option.selected {
    color: #ffff00;
  }

  .menu-option.selected::before {
    content: '> ';
  }

  .menu-version {
    position: absolute;
    bottom: 12px;
    font-size: 12px;
    color: #444;
  }
`;class fi{constructor(e,i=_e){this.lastMenuType=null,this.lastSelectedOption=-1,this.lastMenuDataHash="",this.container=e,this.version=i,this.styleEl=document.createElement("style"),this.styleEl.textContent=ci,document.head.appendChild(this.styleEl),this.overlay=document.createElement("div"),this.overlay.className="menu-overlay",this.container.appendChild(this.overlay)}update(e){const i=e.menu;if(!(e.gameStatus==="menu"||e.gameStatus==="paused"||e.gameStatus==="gameover"||e.gameStatus==="levelcomplete")||!i){this.hide();return}const n=JSON.stringify(i.data||{});(i.type!==this.lastMenuType||n!==this.lastMenuDataHash)&&(this.buildMenu(i.type,i.options,i.data),this.lastMenuType=i.type,this.lastMenuDataHash=n),i.selectedOption!==this.lastSelectedOption&&(this.updateSelection(i.selectedOption),this.lastSelectedOption=i.selectedOption),this.show()}buildMenu(e,i,o){if(this.overlay.innerHTML="",e==="start")this.overlay.innerHTML=`
        <div class="menu-title">PB-GALAGA</div>
        <div class="menu-subtitle">A Space Shooter</div>
        <div class="menu-controls-group">
          <div class="menu-controls">Arrow Keys: Move Ship</div>
          <div class="menu-controls">Spacebar: Fire Laser</div>
        </div>
        ${this.buildOptions(i)}
        <div class="menu-version">v${this.version}</div>
      `;else if(e==="pause")this.overlay.innerHTML=`
        <div class="menu-title">PAUSED</div>
        <div class="menu-controls-group">
          <div class="menu-controls">Press ESC to resume</div>
        </div>
        ${this.buildOptions(i)}
      `;else if(e==="gameover"){let n="";o?.finalScore!==void 0&&(n+=`<div class="menu-score">Final Score: ${o.finalScore}</div>`),o?.p2Score!==void 0&&(n+=`<div class="menu-p2score">P2 Score: ${o.p2Score}</div>`),this.overlay.innerHTML=`
        <div class="menu-title gameover">GAME OVER</div>
        ${n}
        ${this.buildOptions(i)}
      `}else if(e==="levelcomplete"){let n="";o?.finalScore!==void 0&&(n+=`<div class="menu-score">Total Score: ${o.finalScore}</div>`);const s=o?.level?`LEVEL ${o.level} COMPLETE!`:"LEVEL COMPLETE!";this.overlay.innerHTML=`
        <div class="menu-title levelcomplete">${s}</div>
        ${n}
        ${this.buildOptions(i)}
      `}}buildOptions(e){return`<ul class="menu-options">${e.map((o,n)=>`<li class="menu-option" data-index="${n}">${o}</li>`).join("")}</ul>`}updateSelection(e){this.overlay.querySelectorAll(".menu-option").forEach((o,n)=>{o.classList.toggle("selected",n===e)})}show(){this.overlay.classList.add("visible")}hide(){this.overlay.classList.contains("visible")&&(this.overlay.classList.remove("visible"),this.lastMenuType=null,this.lastSelectedOption=-1,this.lastMenuDataHash="")}destroy(){this.overlay.remove(),this.styleEl.remove()}}function te(t,e){for(const i of e){const o=Math.floor(i.brightness*255);t.fillStyle=`rgb(${o},${o},${o})`,i.brightness>.7&&(t.shadowBlur=2,t.shadowColor=`rgba(180, 200, 255, ${i.brightness*.5})`),t.fillRect(Math.floor(i.position.x),Math.floor(i.position.y),Math.ceil(i.size),Math.ceil(i.size)),i.brightness>.7&&(t.shadowBlur=0)}}function Ae(t,e,i){return t+(e-t)*i}function ie(t,e,i){return{x:Ae(t.x,e.x,i),y:Ae(t.y,e.y,i)}}const Ee={red:{fill:"#ff3344",glow:"#ff3344",cockpit:"#2244aa"},blue:{fill:"#0099ff",glow:"#0099ff",cockpit:"#aa2244"}};function Pe(t,e,i,o,n){for(const s of e){if(!s.isAlive||s.deathSequence?.active)continue;const l=i.get(s.id),r=l?ie(l.position,s.position,o):s.position,c=Ee[s.shipColor]||Ee.red;if(t.save(),s.isInvulnerable){const u=Math.floor(n/100)%2===0;t.globalAlpha=u?1:.3}t.shadowBlur=12,t.shadowColor=c.glow,t.fillStyle=c.fill,t.beginPath(),t.moveTo(r.x,r.y-14),t.lineTo(r.x-12,r.y+12),t.lineTo(r.x+12,r.y+12),t.closePath(),t.fill(),t.shadowBlur=0,t.fillStyle=c.cockpit,t.fillRect(r.x-2,r.y-2,4,6),t.shadowBlur=6,t.shadowColor="#ffaa22",t.fillStyle="#ffff44",t.fillRect(r.x-5,r.y+10,3,3),t.fillRect(r.x+2,r.y+10,3,3),t.shadowBlur=0,t.restore()}}const Re={A:{fill:"#00ff44",glow:"#00ff44",accent:"#44ee66"},B:{fill:"#00ccff",glow:"#00ccff",accent:"#44bbee"},C:{fill:"#ff5500",glow:"#ff5500",accent:"#ff8822"}};function Ce(t,e,i,o){for(const n of e){if(!n.isAlive)continue;const s=i.get(n.id),l=s?ie(s.position,n.position,o):n.position,r=Re[n.type]||Re.A;t.save(),t.shadowBlur=10,t.shadowColor=r.glow,n.type==="A"?ui(t,l.x,l.y,r):n.type==="B"?hi(t,l.x,l.y,r):di(t,l.x,l.y,r),t.restore()}}function ui(t,e,i,o){t.fillStyle=o.fill,t.fillRect(e-4,i-12,8,4),t.fillRect(e-8,i-8,16,10),t.fillRect(e-6,i+2,12,4),t.fillRect(e-10,i+6,4,5),t.fillRect(e+6,i+6,4,5),t.fillRect(e-2,i+6,4,5),t.fillStyle=o.accent,t.fillRect(e-2,i-10,4,2),t.shadowBlur=0,t.fillStyle="#ff2222",t.fillRect(e-5,i-5,3,3),t.fillRect(e+2,i-5,3,3),t.fillStyle="#ffffff",t.fillRect(e-4,i-4,1,1),t.fillRect(e+3,i-4,1,1)}function hi(t,e,i,o){t.fillStyle=o.fill,t.fillRect(e-8,i-12,16,4),t.fillRect(e-10,i-8,20,6),t.fillRect(e-12,i-2,24,8),t.fillRect(e-8,i+6,16,4),t.fillStyle="#006699",t.fillRect(e-10,i-2,4,4),t.fillRect(e+6,i-2,4,4),t.shadowBlur=0,t.fillStyle="#ffaa22",t.fillRect(e-6,i-6,4,3),t.fillRect(e+2,i-6,4,3),t.fillStyle="#ffffff",t.fillRect(e-5,i-5,2,1),t.fillRect(e+3,i-5,2,1),t.fillStyle=o.accent,t.fillRect(e-4,i+2,8,2)}function di(t,e,i,o){t.fillStyle=o.fill,t.beginPath(),t.moveTo(e,i-12),t.lineTo(e-6,i-4),t.lineTo(e+6,i-4),t.closePath(),t.fill(),t.fillRect(e-8,i-4,16,6),t.fillRect(e-14,i+2,28,4),t.fillRect(e-4,i+6,8,4),t.fillStyle=o.accent,t.fillRect(e-14,i+4,4,2),t.fillRect(e+10,i+4,4,2),t.shadowBlur=0,t.fillStyle="#44ff44",t.fillRect(e-4,i-2,3,2),t.fillRect(e+1,i-2,3,2)}const Te=[.35,.2,.1,.04],pi=8;function Le(t,e,i,o){for(const n of e){if(!n.isActive)continue;const s=i.get(n.id),l=s?ie(s.position,n.position,o):n.position,r=n.velocity.x,c=n.velocity.y,u=Math.sqrt(r*r+c*c),a=u>0?r/u:0,h=u>0?c/u:-1;if(n.type==="laser")be(t,l.x,l.y,a,h,"#00ffff",4,12);else{const m=n.owner.type==="player"?"#00ffff":"#ff8800";be(t,l.x,l.y,a,h,m,4,6)}if(t.save(),n.type==="laser")t.shadowBlur=8,t.shadowColor="#00ffff",t.fillStyle="#00ffff",t.fillRect(l.x-2,l.y-6,4,12),t.shadowBlur=0,t.fillStyle="#ffffff",t.fillRect(l.x-1,l.y-5,2,10);else{const f=n.owner.type==="player",m=f?"#00ffff":"#ffff00",v=f?"#00ffff":"#ff8800";t.shadowBlur=6,t.shadowColor=v,t.fillStyle=m,t.fillRect(l.x-2,l.y-3,4,6),t.shadowBlur=0,t.fillStyle="#ffffff",t.fillRect(l.x-1,l.y-2,2,4)}t.restore()}}function be(t,e,i,o,n,s,l,r){t.save(),t.globalCompositeOperation="lighter";for(let c=0;c<Te.length;c++){const u=(c+1)*pi,a=e-o*u,h=i-n*u,f=1-(c+1)*.15;t.globalAlpha=Te[c],t.fillStyle=s;const m=l*f,v=r*f;t.fillRect(a-m/2,h-v/2,m,v)}t.restore()}function ke(t,e,i,o){t.save(),t.font="16px monospace";const n=e.players.find(l=>l.id==="player1");if(n){const l=e.gameMode==="co-op"?"P1 ":"";t.fillStyle="#ffffff",t.textAlign="right",t.fillText(`${l}Score: ${n.score}`,d-10,24),t.fillText(`${l}Lives: ${n.lives}`,d-10,44)}const s=e.players.find(l=>l.id==="player2");s&&(t.fillStyle="#4488ff",t.textAlign="right",t.fillText(`P2 Score: ${s.score}`,d-10,68),t.fillText(`P2 Lives: ${s.lives}`,d-10,88)),t.font="14px monospace",t.fillStyle="#aaaaaa",t.textAlign="center",t.fillText(`Level ${e.currentLevel} - Wave ${e.currentWave}`,d/2,24),t.font="12px monospace",t.fillStyle="#88ff88",t.textAlign="left",t.fillText(`Engine: ${i} | Render: ${o}`,10,20),t.restore()}const Oe={A:["#00ff44","#66ff88","#ffffff"],B:["#00ccff","#55ddff","#ffffff"],C:["#ff5500","#ff9933","#ffffff"],player:["#ff3344","#ff7755","#ffffff"],default:["#ffcc00","#ff5500","#ffffff"]};class mi{constructor(){this.particles=[],this.flashes=[],this.explodedEntities=new Set,this.impactedProjectiles=new Set,this.shakeOffsetX=0,this.shakeOffsetY=0,this.shakeTimer=0,this.shakeDuration=0,this.shakeIntensity=0}emit(e,i,o,n){if(this.explodedEntities.has(o))return;this.explodedEntities.add(o);const s=Oe[n]||Oe.default,l=n==="player",r=l?35:20,c=l?200:150,u=l?600:400;for(let a=0;a<r;a++){const h=Math.random()*Math.PI*2,f=30+Math.random()*c,m=s[Math.floor(Math.random()*s.length)];this.particles.push({x:e,y:i,vx:Math.cos(h)*f,vy:Math.sin(h)*f,color:m,life:u,maxLife:u,size:2+Math.random()*3})}l&&(this.shakeTimer=0,this.shakeDuration=150,this.shakeIntensity=4)}emitImpactFlash(e,i,o,n="#ffffff"){this.impactedProjectiles.has(o)||(this.impactedProjectiles.add(o),this.flashes.push({x:e,y:i,radius:20,color:n,life:60,maxLife:60,isScreenFlash:!1}))}update(e){for(let i=this.particles.length-1;i>=0;i--){const o=this.particles[i],n=e/1e3;o.x+=o.vx*n,o.y+=o.vy*n,o.vy+=50*n,o.vx*=.99,o.vy*=.99,o.life-=e,o.life<=0&&this.particles.splice(i,1)}for(let i=this.flashes.length-1;i>=0;i--)this.flashes[i].life-=e,this.flashes[i].life<=0&&this.flashes.splice(i,1);if(this.shakeTimer<this.shakeDuration){this.shakeTimer+=e;const i=1-this.shakeTimer/this.shakeDuration;this.shakeOffsetX=(Math.random()-.5)*2*this.shakeIntensity*i,this.shakeOffsetY=(Math.random()-.5)*2*this.shakeIntensity*i}else this.shakeOffsetX=0,this.shakeOffsetY=0}draw(e){for(const i of this.flashes){const o=Math.max(0,i.life/i.maxLife);if(e.save(),i.isScreenFlash)e.globalCompositeOperation="lighter",e.globalAlpha=o*.12,e.fillStyle=i.color,e.fillRect(0,0,d,y);else{e.globalCompositeOperation="lighter";const n=e.createRadialGradient(i.x,i.y,0,i.x,i.y,i.radius);n.addColorStop(0,i.color),n.addColorStop(1,"transparent"),e.globalAlpha=o*.6,e.fillStyle=n,e.beginPath(),e.arc(i.x,i.y,i.radius,0,Math.PI*2),e.fill()}e.restore()}for(const i of this.particles){const o=Math.max(0,i.life/i.maxLife);e.save(),e.globalAlpha=o,e.fillStyle=i.color,o>.5&&(e.shadowBlur=6,e.shadowColor=i.color),e.fillRect(Math.floor(i.x-i.size/2),Math.floor(i.y-i.size/2),Math.ceil(i.size),Math.ceil(i.size)),e.restore()}}clearTracking(){this.explodedEntities.clear(),this.impactedProjectiles.clear(),this.particles=[],this.flashes=[],this.shakeTimer=0,this.shakeDuration=0,this.shakeOffsetX=0,this.shakeOffsetY=0}get activeCount(){return this.particles.length}get flashCount(){return this.flashes.length}}class yi{constructor(e){this.engineFps=0,this.renderFps=0,this.lastRenderTime=0,this.lastGameStatus="";const i=document.getElementById(e);if(!i)throw new Error(`Container #${e} not found`);i.style.position="relative",this.canvas=document.createElement("canvas"),this.canvas.width=d,this.canvas.height=y,this.canvas.style.display="block",i.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this.particleSystem=new mi,this.menuOverlay=new fi(i)}setFpsCounters(e,i){this.engineFps=e,this.renderFps=i}render(e,i,o){const n=this.ctx,s=performance.now(),l=this.lastRenderTime>0?s-this.lastRenderTime:16.667;if(this.lastRenderTime=s,e.gameStatus==="playing"&&this.lastGameStatus!=="playing"&&this.particleSystem.clearTracking(),this.lastGameStatus=e.gameStatus,n.fillStyle="#000",n.fillRect(0,0,d,y),this.particleSystem.update(l),e.gameStatus==="menu"||e.gameStatus==="gameover"||e.gameStatus==="levelcomplete"){e.background&&te(n,e.background.stars),this.particleSystem.draw(n),this.menuOverlay.update(e);return}if(e.gameStatus==="paused"){const a=new Map(i.players.map(m=>[m.id,m])),h=new Map(i.enemies.map(m=>[m.id,m])),f=new Map(i.projectiles.map(m=>[m.id,m]));e.background&&te(n,e.background.stars),Ce(n,e.enemies,h,1),Le(n,e.projectiles,f,1),Pe(n,e.players,a,1,e.currentTime),this.particleSystem.draw(n),ke(n,e,this.engineFps,this.renderFps),this.menuOverlay.update(e);return}n.save(),n.translate(this.particleSystem.shakeOffsetX,this.particleSystem.shakeOffsetY);const r=new Map(i.players.map(a=>[a.id,a])),c=new Map(i.enemies.map(a=>[a.id,a])),u=new Map(i.projectiles.map(a=>[a.id,a]));this.detectDeaths(e),e.background&&te(n,e.background.stars),Ce(n,e.enemies,c,o),Le(n,e.projectiles,u,o),Pe(n,e.players,r,o,e.currentTime),this.particleSystem.draw(n),n.restore(),ke(n,e,this.engineFps,this.renderFps),this.menuOverlay.update(e)}detectDeaths(e){for(const i of e.enemies)!i.isAlive&&i.collisionState==="destroyed"&&this.particleSystem.emit(i.position.x,i.position.y,i.id,i.type);for(const i of e.players)i.isAlive||this.particleSystem.emit(i.position.x,i.position.y,i.id,"player");for(const i of e.projectiles)if(i.hasCollided&&!i.isActive){const o=i.owner.type==="player"?"#00ffff":"#ff8800";this.particleSystem.emitImpactFlash(i.position.x,i.position.y,i.id,o)}}destroy(){this.menuOverlay.destroy(),this.canvas.remove()}}function Ie(){const t=new yi("game-container"),e=new ai({renderer:t}),i=t.render.bind(t);t.render=(o,n,s)=>{t.setFpsCounters(e.gameLoop.engineFps,e.gameLoop.renderFps),i(o,n,s)},e.start(),window.__game=e}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ie):Ie()})();
//# sourceMappingURL=index-C2iCD3MG.js.map
