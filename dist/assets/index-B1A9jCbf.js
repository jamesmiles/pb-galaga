(function(){"use strict";const Ci="0.8.0",V=1e3/60,Te=250,p=800,g=800,bi=3,Pe=100,Ii=300,Re=2e3,N=14,ki=200,B=500,Le=50,Ce=3e3,be=4,Ie=50,Oi=100,_i=14,ke=100,Di=200,Ni=16,Oe=50,Bi=150,Hi=12,_e=75,Fi=250,Ui=14,De=150,Yi=300,Wi=18,Ne=125,$i=350,Xi=16,Be=200,Gi=2.5,xi=40,Ki=5e3,Vi=4,Q=60,fe=48,ce=40,zi=1.5,qi=20,Z=260,ji=50,He=3e3,Fe=3,Ue=550,Qi=25,Ye=180,Zi=75,Ji=3e3,et=9,J=200,We=420,$e=400,Xe=40,Ge=3e3,xe=5,it=500,he=150,tt=350,ot=350,st=10,nt=4e3,lt=3,at=3,rt=800,ft=200,Ke=400,ct=75,ht=3e3,dt=8,ut=2,Ve=100,ze=300,pt=12,mt=24,yt=50,vt=150,de=3e3,gt=1e3,qe=40,St=80,wt=50,Et=.15,je=5e3,At=60,Mt=1e4,Tt=12,Qe=15e3,ee=720,_=200,Ze=1e3,Je=400,Pt=600,ue=20,Rt=5e3,Lt=500,Ct=800,ie=300,ei=1200,bt=30,It=1333,kt=.5,Ot=50,_t=12e3,Dt=10,Nt=3e3,Bt=500,Ht=2e3,Ft=100,Ut=30;class Yt{constructor(e,t){this.animationFrameId=0,this.lastTimestamp=0,this.accumulator=0,this.running=!1,this.tickCount=0,this.frameCount=0,this.fpsTimer=0,this.engineFps=0,this.renderFps=0,this.updateFn=e,this.renderFn=t}start(){this.running||(this.running=!0,this.lastTimestamp=0,this.accumulator=0,this.tickCount=0,this.frameCount=0,this.fpsTimer=0,this.animationFrameId=requestAnimationFrame(e=>this.tick(e)))}stop(){this.running=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=0)}isRunning(){return this.running}tick(e){if(!this.running)return;if(this.lastTimestamp===0){this.lastTimestamp=e,this.fpsTimer=e,this.animationFrameId=requestAnimationFrame(o=>this.tick(o));return}let t=e-this.lastTimestamp;for(this.lastTimestamp=e,t>Te&&(t=Te),this.accumulator+=t;this.accumulator>=V;)this.updateFn(V),this.accumulator-=V,this.tickCount++;const s=this.accumulator/V;this.renderFn(s),this.frameCount++,this.fpsTimer=this.fpsTimer||e,e-this.fpsTimer>=1e3&&(this.engineFps=this.tickCount,this.renderFps=this.frameCount,this.tickCount=0,this.frameCount=0,this.fpsTimer=e),this.animationFrameId=requestAnimationFrame(o=>this.tick(o))}tickHeadless(e){for(let t=0;t<e;t++)this.updateFn(V),this.tickCount++}}class Wt{constructor(){this.bufferA=te(),this.bufferB=te(),this.currentState=this.bufferA,this.previousState=this.bufferB}swapBuffers(){const e=this.previousState;this.previousState=this.currentState,this.currentState=e,Xt(this.currentState,this.previousState)}reset(){this.bufferA=te(),this.bufferB=te(),this.currentState=this.bufferA,this.previousState=this.bufferB}}function te(){return{currentTime:0,deltaTime:0,gameMode:"single",gameStatus:"menu",currentLevel:1,currentWave:1,waveStatus:"transition",players:[],enemies:[],projectiles:[],powerups:[],weaponPickups:[],asteroids:[],background:{stars:[],scrollSpeed:0},formation:$t(),menu:{type:"start",selectedOption:0,options:["1 Player","2 Players","Test Mode"]},boss:null,lifePickups:[]}}function $t(){return{rows:0,cols:0,direction:1,speed:Q,baseSpeed:Q,offsetX:0,offsetY:0,cellWidth:fe,cellHeight:ce,standoffY:0}}function Xt(i,e){i.currentTime=e.currentTime,i.deltaTime=e.deltaTime,i.gameMode=e.gameMode,i.gameStatus=e.gameStatus,i.currentLevel=e.currentLevel,i.currentWave=e.currentWave,i.waveStatus=e.waveStatus,i.players=e.players,i.enemies=e.enemies,i.projectiles=e.projectiles,i.powerups=e.powerups,i.weaponPickups=e.weaponPickups,i.asteroids=e.asteroids,i.background=e.background,i.formation=e.formation,i.menu=e.menu,i.boss=e.boss,i.lifePickups=e.lifePickups}function pe(i){return{id:i,shipColor:i==="player1"?"red":"blue",position:{x:p/2,y:g-60},velocity:{x:0,y:0},rotation:0,isAlive:!0,isInvulnerable:!0,invulnerabilityTimer:2e3,lives:bi,score:0,health:Pe,maxHealth:Pe,primaryWeapon:"laser",primaryLevel:1,secondaryWeapon:null,secondaryTimer:0,secondaryCooldown:0,fireCooldown:0,isThrusting:!1,isFiring:!1,collisionState:"none",input:{left:!1,right:!1,up:!1,down:!1,fire:!1},deathSequence:null}}const ii=new Set(["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Space","Enter","Escape","KeyW","KeyA","KeyS","KeyD","KeyQ","KeyM"]);class Gt{constructor(e=!1){this.keyState={},this.handleKeyDown=t=>{ii.has(t.code)&&t.preventDefault(),this.keyState[t.code]=!0},this.handleKeyUp=t=>{ii.has(t.code)&&t.preventDefault(),this.keyState[t.code]=!1},this.headless=e,!e&&typeof window<"u"&&(window.addEventListener("keydown",this.handleKeyDown),window.addEventListener("keyup",this.handleKeyUp))}getPlayerInput(){return{left:!!this.keyState.ArrowLeft,right:!!this.keyState.ArrowRight,up:!!this.keyState.ArrowUp,down:!!this.keyState.ArrowDown,fire:!!this.keyState.Space}}getPlayer2Input(){return{left:!!this.keyState.KeyA,right:!!this.keyState.KeyD,up:!!this.keyState.KeyW,down:!!this.keyState.KeyS,fire:!!this.keyState.KeyQ}}getMenuInput(){const e={up:!!this.keyState.ArrowUp,down:!!this.keyState.ArrowDown,confirm:!!this.keyState.Enter||!!this.keyState.Space,back:!!this.keyState.Escape};return e.up&&(this.keyState.ArrowUp=!1),e.down&&(this.keyState.ArrowDown=!1),e.confirm&&(this.keyState.Enter=!1,this.keyState.Space=!1),e.back&&(this.keyState.Escape=!1),e}getPauseToggle(){const e=!!this.keyState.Escape;return e&&(this.keyState.Escape=!1),e}getMuteToggle(){const e=!!this.keyState.KeyM;return e&&(this.keyState.KeyM=!1),e}injectPlayerInput(e){e.left!==void 0&&(this.keyState.ArrowLeft=e.left),e.right!==void 0&&(this.keyState.ArrowRight=e.right),e.up!==void 0&&(this.keyState.ArrowUp=e.up),e.down!==void 0&&(this.keyState.ArrowDown=e.down),e.fire!==void 0&&(this.keyState.Space=e.fire)}injectMenuInput(e){e.up&&(this.keyState.ArrowUp=!0),e.down&&(this.keyState.ArrowDown=!0),e.confirm&&(this.keyState.Enter=!0),e.back&&(this.keyState.Escape=!0)}clearAll(){this.keyState={}}destroy(){!this.headless&&typeof window<"u"&&(window.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("keyup",this.handleKeyUp))}}const oe=N+2;function xt(i,e){i.isAlive&&(Kt(i,e),Vt(i,e),zt(i,e),qt(i))}function Kt(i,e){const t=i.input,s=Ii*e;if(i.velocity.x=0,i.velocity.y=0,t.left&&(i.velocity.x=-s),t.right&&(i.velocity.x=s),t.up&&(i.velocity.y=-s),t.down&&(i.velocity.y=s),i.velocity.x!==0&&i.velocity.y!==0){const o=1/Math.SQRT2;i.velocity.x*=o,i.velocity.y*=o}i.position.x+=i.velocity.x,i.position.y+=i.velocity.y,i.position.x=Math.max(oe,Math.min(p-oe,i.position.x)),i.position.y=Math.max(oe,Math.min(g-oe,i.position.y)),i.isThrusting=i.velocity.x!==0||i.velocity.y!==0}function Vt(i,e){i.isInvulnerable&&(i.invulnerabilityTimer-=e*1e3,i.invulnerabilityTimer<=0&&(i.isInvulnerable=!1,i.invulnerabilityTimer=0))}function zt(i,e){i.fireCooldown>0&&(i.fireCooldown-=e*1e3,i.fireCooldown<0&&(i.fireCooldown=0))}function qt(i){i.isFiring=i.input.fire&&i.fireCooldown<=0,i.isFiring&&(i.fireCooldown=ki)}function jt(i){i.lives<=0||(i.isAlive=!0,i.health=i.maxHealth,i.position={x:p/2,y:g-60},i.velocity={x:0,y:0},i.isInvulnerable=!0,i.invulnerabilityTimer=Re,i.collisionState="none",i.deathSequence=null)}function se(i,e,t=0){return i.isInvulnerable||!i.isAlive?!1:(i.health-=e,i.health<=0?(i.health=0,i.isAlive=!1,i.lives--,i.collisionState="destroyed",i.deathSequence={active:!0,startTime:t,duration:Ht,position:{x:i.position.x,y:i.position.y}},!0):(i.collisionState="colliding",i.isInvulnerable=!0,i.invulnerabilityTimer=Re,!1))}let ti=0;function me(i,e){return{id:`bullet-${ti++}`,type:"bullet",owner:e,position:{x:i.x,y:i.y},velocity:{x:0,y:Z},rotation:Math.PI,speed:Z,damage:ji,isActive:!0,lifetime:0,maxLifetime:He,collisionRadius:Fe,hasCollided:!1}}function z(i,e){return{id:`bullet-${ti++}`,type:"bullet",owner:e,position:{x:i.x,y:i.y},velocity:{x:0,y:-Ue},rotation:0,speed:Ue,damage:Qi,isActive:!0,lifetime:0,maxLifetime:He,collisionRadius:Fe,hasCollided:!1}}let Qt=0;function oi(i,e,t){const s=t==="left"?-20:20;return{id:`rocket-${Qt++}`,type:"rocket",owner:e,position:{x:i.x+s,y:i.y},velocity:{x:0,y:-J},rotation:0,speed:J,damage:Xe,isActive:!0,lifetime:0,maxLifetime:Ge,collisionRadius:xe,hasCollided:!1,acceleration:$e,maxSpeed:We}}let Zt=0;function Jt(i,e,t){const s=Math.sin(t)*he,o=-Math.cos(t)*he;return{id:`missile-${Zt++}`,type:"missile",owner:e,position:{x:i.x,y:i.y},velocity:{x:s,y:o},rotation:t,speed:he,damage:st,isActive:!0,lifetime:0,maxLifetime:nt,collisionRadius:lt,hasCollided:!1,acceleration:ot,maxSpeed:tt,turnRate:at,isHoming:!0,homingDelay:ft}}let eo=0;function io(i,e){return{id:`snake-${eo++}`,type:"snake",owner:e,position:{x:i.x,y:i.y},velocity:{x:0,y:-Ke},rotation:0,speed:Ke,damage:ct,isActive:!0,lifetime:0,maxLifetime:ht,collisionRadius:dt,hasCollided:!1,turnRate:ut,isHoming:!0}}let si=0;function W(i,e){return{id:`laser-${si++}`,type:"laser",owner:e,position:{x:i.x,y:i.y},velocity:{x:0,y:-B},rotation:0,speed:B,damage:Le,isActive:!0,lifetime:0,maxLifetime:Ce,collisionRadius:be,hasCollided:!1}}function to(i,e){return{id:`laser-${si++}`,type:"laser",owner:e,position:{x:i.x,y:i.y},velocity:{x:0,y:B},rotation:Math.PI,speed:B,damage:Le,isActive:!0,lifetime:0,maxLifetime:Ce,collisionRadius:be,hasCollided:!1}}function oo(i,e,t){if(!i.isActive)return;const s=e*1e3;if(i.acceleration&&i.maxSpeed&&i.speed<i.maxSpeed){i.speed=Math.min(i.speed+i.acceleration*e,i.maxSpeed);const o=Math.atan2(i.velocity.y,i.velocity.x);i.velocity.x=Math.cos(o)*i.speed,i.velocity.y=Math.sin(o)*i.speed}if(i.homingDelay!==void 0&&i.homingDelay>0&&(i.homingDelay-=s),i.isHoming&&i.turnRate&&t&&(i.homingDelay===void 0||i.homingDelay<=0)){let o;if(i.owner.type==="enemy"?o=t.players.filter(n=>n.isAlive):(o=[...t.enemies.filter(n=>n.isAlive)],t.boss?.isAlive&&o.push(...t.boss.turrets.filter(n=>n.isAlive))),o.length>0){let n=o[0],l=1/0;for(const h of o){const E=h.position.x-i.position.x,M=h.position.y-i.position.y,A=E*E+M*M;A<l&&(l=A,n=h)}const a=n.position.x-i.position.x,r=n.position.y-i.position.y,f=Math.atan2(r,a),d=Math.atan2(i.velocity.y,i.velocity.x);let c=f-d;for(;c>Math.PI;)c-=2*Math.PI;for(;c<-Math.PI;)c+=2*Math.PI;const u=i.turnRate*e,v=Math.max(-u,Math.min(u,c)),m=d+v;i.velocity.x=Math.cos(m)*i.speed,i.velocity.y=Math.sin(m)*i.speed}}i.position.x+=i.velocity.x*e,i.position.y+=i.velocity.y*e,i.lifetime+=s,(i.position.y<-20||i.position.y>g+20||i.position.x<-20||i.position.x>p+20||i.lifetime>=i.maxLifetime||i.hasCollided)&&(i.isActive=!1)}function so(i,e){for(const t of i.projectiles)oo(t,e,i);i.projectiles=i.projectiles.filter(t=>t.isActive)}function no(i){for(const e of i.players){if(!e.isFiring||!e.isAlive)continue;const t={type:"player",id:e.id},s={x:e.position.x,y:e.position.y-16},o=[];if(e.primaryWeapon==="laser")switch(e.primaryLevel){case 1:o.push(W(s,t));break;case 2:o.push(W({x:s.x-8,y:s.y},t)),o.push(W({x:s.x+8,y:s.y},t));break;case 3:{o.push(W(s,t));const n=5*Math.PI/180,l=W({x:s.x-8,y:s.y},t);l.velocity.x=-Math.sin(n)*B,l.velocity.y=-Math.cos(n)*B;const a=W({x:s.x+8,y:s.y},t);a.velocity.x=Math.sin(n)*B,a.velocity.y=-Math.cos(n)*B,o.push(l,a);break}case 4:o.push(io(s,t));break}else switch(e.primaryLevel){case 1:o.push(z(s,t));break;case 2:o.push(z({x:s.x-8,y:s.y},t)),o.push(z({x:s.x+8,y:s.y},t));break;case 3:{const n=[0,-10,10];for(const l of n){const a=l*Math.PI/180,r=z(s,t);l!==0&&(r.velocity.x=Math.sin(a)*r.speed,r.velocity.y=-Math.cos(a)*r.speed),o.push(r)}break}case 4:{const n=[0,-8,8,-16,16];for(const l of n){const a=l*Math.PI/180,r=z(s,t);l!==0&&(r.velocity.x=Math.sin(a)*r.speed,r.velocity.y=-Math.cos(a)*r.speed),o.push(r)}break}}if(e.secondaryWeapon&&e.secondaryCooldown<=0){if(e.secondaryWeapon==="rocket")o.push(oi(s,t,"left")),o.push(oi(s,t,"right")),e.secondaryCooldown=it;else if(e.secondaryWeapon==="missile"){const n=[-15,0,15];for(const l of n)o.push(Jt(s,t,l*Math.PI/180));e.secondaryCooldown=rt}}o.length>0&&(i.projectiles=[...i.projectiles,...o])}}const lo=50;function ni(i,e){const t=e*fe,s=(p-t)/2;return{rows:i,cols:e,direction:1,speed:Q,baseSpeed:Q,offsetX:s,offsetY:-i*ce,cellWidth:fe,cellHeight:ce,standoffY:g-lo-N}}function ao(i,e){const t=i.formation,s=i.enemies.filter(u=>u.isAlive);if(s.length===0)return;if(i.enemies.some(u=>u.isAlive&&u.flightPathState)){ye(i);return}const n=t.rows*t.cols,l=s.length;if(n>0&&l>0){const u=1-l/n;t.speed=t.baseSpeed*(1+u*zi)}if(t.offsetY<20){t.offsetY+=t.speed*e*2,ye(i);return}const a=t.direction*t.speed*e;t.offsetX+=a;const{minCol:r,maxCol:f}=ro(s),d=t.offsetX+r*t.cellWidth;if(t.offsetX+(f+1)*t.cellWidth>p||d<0){t.direction*=-1,t.offsetX-=a;const u=fo(s);t.offsetY+(u+1)*t.cellHeight<t.standoffY&&(t.offsetY+=qi)}ye(i)}function ye(i){const e=i.formation;for(const t of i.enemies)t.isAlive&&(t.diveState||t.flightPathState||(t.position.x=e.offsetX+(t.formationCol+.5)*e.cellWidth,t.position.y=e.offsetY+(t.formationRow+.5)*e.cellHeight))}function ro(i){let e=1/0,t=-1/0;for(const s of i)s.formationCol<e&&(e=s.formationCol),s.formationCol>t&&(t=s.formationCol);return{minCol:e,maxCol:t}}function fo(i){let e=0;for(const t of i)t.formationRow>e&&(e=t.formationRow);return e}function $(){const i=[];for(let e=0;e<Ft;e++)i.push(co());return{stars:i,scrollSpeed:Ut}}function co(){const i=Math.random()*.8+.2;return{position:{x:Math.random()*p,y:Math.random()*g},depth:i,size:i*2+.5,brightness:i*.6+.4}}function ve(i,e){for(const t of i.stars)t.position.y+=i.scrollSpeed*t.depth*e,t.position.y>g&&(t.position.y-=g,t.position.x=Math.random()*p)}let ho=0;function ge(i,e){return{id:`enemyA-${ho++}`,type:"A",position:{x:0,y:0},velocity:{x:0,y:0},rotation:Math.PI,isAlive:!0,health:Ie,maxHealth:Ie,fireMode:"none",fireCooldown:0,fireRate:0,isThrusting:!1,isFiring:!1,collisionState:"none",scoreValue:Oi,collisionRadius:_i,formationRow:i,formationCol:e,diveState:null,flightPathState:null}}function li(i,e){return i.isAlive?(i.health-=e,i.health<=0?(i.health=0,i.isAlive=!1,i.collisionState="destroyed",!0):(i.collisionState="colliding",!1)):!1}function uo(i,e){if(e.category==="primary"){const t=e.currentWeapon;t===i.primaryWeapon?i.primaryLevel<4&&(i.primaryLevel=i.primaryLevel+1):(i.primaryWeapon=t,i.primaryLevel=1)}else{const t=e.currentWeapon;i.secondaryWeapon=t,i.secondaryTimer=Qe,i.secondaryCooldown=0}}function po(i,e){i.secondaryWeapon!==null&&(i.secondaryTimer-=e,i.secondaryTimer<=0&&(i.secondaryWeapon=null,i.secondaryTimer=0,i.secondaryCooldown=0))}function D(i,e){const t=i.x-e.x,s=i.y-e.y;return Math.sqrt(t*t+s*s)}function mo(i){yo(i),vo(i),go(i),So(i),wo(i),Eo(i),Ao(i),i.boss&&(Mo(i),To(i),Po(i))}function yo(i){for(const e of i.players)if(!(!e.isAlive||e.isInvulnerable))for(const t of i.enemies){if(!t.isAlive)continue;D(e.position,t.position)<N+t.collisionRadius&&(se(e,e.maxHealth,i.currentTime),li(t,t.maxHealth))}}function vo(i){for(const e of i.projectiles)if(!(!e.isActive||e.hasCollided)&&e.owner.type==="player")for(const t of i.enemies){if(!t.isAlive)continue;if(D(e.position,t.position)<e.collisionRadius+t.collisionRadius){if(e.hasCollided=!0,e.isActive=!1,li(t,e.damage)){const n=i.players.find(l=>l.id===e.owner.id);n&&(n.score+=t.scoreValue)}break}}}function go(i){for(const e of i.projectiles)if(!(!e.isActive||e.hasCollided)&&e.owner.type==="enemy")for(const t of i.players){if(!t.isAlive||t.isInvulnerable)continue;if(D(e.position,t.position)<e.collisionRadius+N){e.hasCollided=!0,e.isActive=!1,se(t,e.damage,i.currentTime);break}}}function So(i){for(const e of i.weaponPickups)if(e.isActive)for(const t of i.players){if(!t.isAlive)continue;if(D(t.position,e.position)<N+Tt){e.isActive=!1,uo(t,e);break}}}function wo(i){for(const e of i.players)if(!(!e.isAlive||e.isInvulnerable))for(const t of i.asteroids){if(!t.isAlive)continue;if(D(e.position,t.position)<N+t.collisionRadius){se(e,wt,i.currentTime),t.isAlive=!1;break}}}function Eo(i){for(const e of i.projectiles)if(!(!e.isActive||e.hasCollided)&&e.owner.type==="player")for(const t of i.asteroids){if(!t.isAlive)continue;if(D(e.position,t.position)<e.collisionRadius+t.collisionRadius){if(e.hasCollided=!0,e.isActive=!1,t.health-=e.damage,t.health<=0){t.isAlive=!1;const o=i.players.find(n=>n.id===e.owner.id);o&&(o.score+=t.scoreValue)}break}}}function Ao(i){for(const e of i.lifePickups)if(e.isActive)for(const t of i.players){if(!t.isAlive)continue;if(D(t.position,e.position)<N+Dt){e.isActive=!1,t.lives++;break}}}function Mo(i){const e=i.boss;if(!(!e||!e.isAlive||e.layer==="entering")){for(const t of i.projectiles)if(!(!t.isActive||t.hasCollided)&&t.owner.type==="player")for(const s of e.turrets){if(!s.isAlive)continue;if(D(t.position,s.position)<t.collisionRadius+s.collisionRadius){if(t.hasCollided=!0,t.isActive=!1,s.health-=t.damage,s.health<=0){s.health=0,s.isAlive=!1;const n=i.players.find(l=>l.id===t.owner.id);n&&(n.score+=Lt)}break}}}}function To(i){const e=i.boss;if(!e||!e.isAlive||e.layer!=="active"||!e.turrets.every(a=>!a.isAlive))return;const s=e.width*.09,o=e.height*.2,n=e.position.x,l=e.position.y;for(const a of i.projectiles)!a.isActive||a.hasCollided||a.owner.type==="player"&&a.position.x>=n-s&&a.position.x<=n+s&&a.position.y>=l-o&&a.position.y<=l+o&&(a.hasCollided=!0,a.isActive=!1,e.health-=a.damage,e.health<=0&&(e.health=0))}function Po(i){const e=i.boss;if(!(!e||!e.isAlive||e.layer==="entering")){for(const t of i.players)if(!(!t.isAlive||t.isInvulnerable))for(const s of e.upperCollisionZones){const o=e.position.x+s.offsetX,n=e.position.y+s.offsetY,l=s.width/2,a=s.height/2,r=Math.max(o-l,Math.min(t.position.x,o+l)),f=Math.max(n-a,Math.min(t.position.y,n+a));if(D(t.position,{x:r,y:f})<N){se(t,t.maxHealth,i.currentTime);break}}}}let Ro=0;function Lo(i,e){return{id:`enemyB-${Ro++}`,type:"B",position:{x:0,y:0},velocity:{x:0,y:0},rotation:Math.PI,isAlive:!0,health:ke,maxHealth:ke,fireMode:"laser",fireCooldown:0,fireRate:3e3,isThrusting:!1,isFiring:!1,collisionState:"none",scoreValue:Di,collisionRadius:Ni,formationRow:i,formationCol:e,diveState:null,flightPathState:null}}let Co=0;function ai(i,e){return{id:`enemyC-${Co++}`,type:"C",position:{x:0,y:0},velocity:{x:0,y:0},rotation:Math.PI,isAlive:!0,health:Oe,maxHealth:Oe,fireMode:"bullet",fireCooldown:0,fireRate:2e3,isThrusting:!1,isFiring:!1,collisionState:"none",scoreValue:Bi,collisionRadius:Hi,formationRow:i,formationCol:e,diveState:null,flightPathState:null}}let bo=0;function Io(i,e){return{id:`enemyD-${bo++}`,type:"D",position:{x:0,y:0},velocity:{x:0,y:0},rotation:Math.PI,isAlive:!0,health:_e,maxHealth:_e,fireMode:"plasma",fireCooldown:0,fireRate:2500,isThrusting:!1,isFiring:!1,collisionState:"none",scoreValue:Fi,collisionRadius:Ui,formationRow:i,formationCol:e,diveState:null,flightPathState:null}}let ko=0;function Oo(i,e){return{id:`enemyE-${ko++}`,type:"E",position:{x:0,y:0},velocity:{x:0,y:0},rotation:Math.PI,isAlive:!0,health:De,maxHealth:De,fireMode:"spread",fireCooldown:0,fireRate:4e3,isThrusting:!1,isFiring:!1,collisionState:"none",scoreValue:Yi,collisionRadius:Wi,formationRow:i,formationCol:e,diveState:null,flightPathState:null}}let _o=0;function Do(i,e){return{id:`enemyF-${_o++}`,type:"F",position:{x:0,y:0},velocity:{x:0,y:0},rotation:Math.PI,isAlive:!0,health:Ne,maxHealth:Ne,fireMode:"homing",fireCooldown:0,fireRate:3500,isThrusting:!1,isFiring:!1,collisionState:"none",scoreValue:$i,collisionRadius:Xi,formationRow:i,formationCol:e,diveState:null,flightPathState:null}}const No=250,Bo={A:1,B:.8,C:1.3,D:1.1,E:.6,F:.7};function Ho(i,e){if(i.length===2)return{x:i[0].x+(i[1].x-i[0].x)*e,y:i[0].y+(i[1].y-i[0].y)*e};if(i.length===3){const a=1-e;return{x:a*a*i[0].x+2*a*e*i[1].x+e*e*i[2].x,y:a*a*i[0].y+2*a*e*i[1].y+e*e*i[2].y}}const t=1-e,s=t*t,o=s*t,n=e*e,l=n*e;return{x:o*i[0].x+3*s*e*i[1].x+3*t*n*i[2].x+l*i[3].x,y:o*i[0].y+3*s*e*i[1].y+3*t*n*i[2].y+l*i[3].y}}function H(i,e){return{x:e.offsetX+(i.formationCol+.5)*e.cellWidth,y:e.offsetY+(i.formationRow+.5)*e.cellHeight}}function Fo(i,e,t){if(i==="grid")return;const o={"w-curve":Yo,chiral:Wo,diagonal:$o,"side-wave":Xo,"m-shape":Go,"inverted-v":xo,"x-formation":Ko}[i];o&&o(e,t)}function Uo(i,e){for(const t of i.enemies){if(!t.isAlive||!t.flightPathState)continue;const s=t.flightPathState,o=s.speed,n=s.controlPoints[0],l=s.controlPoints[s.controlPoints.length-1],a=l.x-n.x,r=l.y-n.y,f=Math.sqrt(a*a+r*r)*1.5,d=f>0?o*e/f:1;s.progress=Math.min(1,s.progress+d);const c=Ho(s.controlPoints,s.progress);if(t.position.x=c.x,t.position.y=c.y,s.progress>=1){const u=i.formation;t.position.x=u.offsetX+(t.formationCol+.5)*u.cellWidth,t.position.y=u.offsetY+(t.formationRow+.5)*u.cellHeight,t.flightPathState=null}}}function U(i,e,t){const s=H(i,t),o=[...e];o[o.length-1]=s,i.flightPathState={progress:0,controlPoints:o,targetSlot:s,speed:No*(Bo[i.type]??1)},i.position.x=o[0].x,i.position.y=o[0].y}function Yo(i,e){const t=p/2,s=i.length;for(let o=0;o<s;o++){const n=i[o],l=H(n,e),a=Math.floor(o/s*5),f=a%2===0?-150:150,c=[{x:t+(o-s/2)*10,y:-20},{x:t+f,y:200+a*30},{x:l.x+f*.2,y:l.y-40},l];U(n,c,e)}}function Wo(i,e){const t=p/2,s=g*.4,o=i.length;for(let n=0;n<o;n++){const l=i[n],a=H(l,e),r=n%4;let f,d;r===0?(f=20,d=20):r===1?(f=p-20,d=20):r===2?(f=p-20,d=g*.5):(f=20,d=g*.5);const c=r*Math.PI/2+Math.PI*.6,u=120,v=t+Math.cos(c)*u,m=s+Math.sin(c)*u*.5,h=[{x:f,y:d},{x:v,y:m},{x:a.x+(f>t?30:-30),y:a.y-30},a];U(l,h,e)}}function $o(i,e){const t=i.length;for(let s=0;s<t;s++){const o=i[s],n=H(o,e),l=p+20,a=30+s*15,r=[{x:l,y:a},{x:p*.65,y:g*.25+s*5},{x:n.x+50,y:n.y-30},n];U(o,r,e)}}function Xo(i,e){const t=i.length,s=p/2;for(let o=0;o<t;o++){const n=i[o],l=H(n,e),a=o%2===0,r=a?-20:p+20,f=60+o%8*40,d=100,c=a?s+d:s-d,u=[{x:r,y:f},{x:c,y:g*.3+o%5*20},{x:l.x+(a?-40:40),y:l.y-30},l];U(n,u,e)}}function Go(i,e){const t=p/2,s=i.length;for(let o=0;o<s;o++){const n=i[o],l=H(n,e),a=s>1?o/(s-1):.5,r=Math.abs(Math.sin(a*Math.PI*2))*120,f=t+(a-.5)*p*.7,d=[{x:f,y:-15},{x:f,y:80+r},{x:l.x,y:l.y-30},l];U(n,d,e)}}function xo(i,e){const t=p/2,s=i.length;for(let o=0;o<s;o++){const n=i[o],l=H(n,e),a=Math.floor(s/2),r=o<a,f=r?o:o-a,d=r?-15:p+15,c=40+f*20,u=g*.25,v=t+(r?-20:20),m=[{x:d,y:c},{x:v,y:u},{x:l.x+(r?-30:30),y:l.y-40},l];U(n,m,e)}}function Ko(i,e){const t=i.length;for(let s=0;s<t;s++){const o=i[s],n=H(o,e),l=s%2===0,a=Math.floor(s/2)*15,r=l?-20:p+20,f=-20+a,d=l?p*.65:p*.35,c=g*.3+a*.5,u=[{x:r,y:f},{x:d,y:c},{x:n.x+(l?30:-30),y:n.y-40},n];U(o,u,e)}}function Vo(){const i=p/2,e=ee*.42,t=ee*.2,s=[-e,-t,t,e],o=[];for(let l=0;l<4;l++){const a=s[l];o.push({id:`boss-turret-${l}`,position:{x:i+a,y:-_/2},offsetX:a,offsetY:_*.3,health:Je,maxHealth:Je,isAlive:!0,fireCooldown:1e3+l*500,fireRate:Pt,collisionRadius:ue,fireType:"bullet"})}o.push({id:"boss-turret-rocket",position:{x:i-e*.7,y:-_/2},offsetX:-e*.7,offsetY:-_*.15,health:ie,maxHealth:ie,isAlive:!0,fireCooldown:2e3,fireRate:ei,collisionRadius:ue,fireType:"rocket"}),o.push({id:"boss-turret-homing",position:{x:i+e*.7,y:-_/2},offsetX:e*.7,offsetY:-_*.15,health:ie,maxHealth:ie,isAlive:!0,fireCooldown:3e3,fireRate:ei,collisionRadius:ue,fireType:"homing"});const n=[{offsetX:0,offsetY:_*.3,width:ee*.18,height:_*.4}];return{position:{x:i,y:-_/2},velocity:{x:0,y:0},width:ee,height:_,isAlive:!0,health:Ze,maxHealth:Ze,turrets:o,layer:"entering",deathSequence:null,scoreValue:Rt,upperCollisionZones:n}}const zo=3e3,ri={A:ge,B:Lo,C:ai,D:Io,E:Oo,F:Do};class qo{constructor(){this.levels=new Map,this.waveTransitionTimer=0,this.clearingTimer=0}registerLevel(e){this.levels.set(e.levelNumber,e)}startLevel(e,t){const s=this.levels.get(t);s&&(e.currentLevel=t,e.currentWave=1,e.waveStatus="transition",this.waveTransitionTimer=0,this.clearingTimer=0,this.spawnWave(e,s.waves[0]))}update(e){if(e.waveStatus==="transition"){this.waveTransitionTimer+=e.deltaTime,(this.waveTransitionTimer>=zo||e.currentWave===1)&&(e.waveStatus="active",this.waveTransitionTimer=0);return}if(e.waveStatus==="clearing"){this.clearingTimer+=e.deltaTime,this.clearingTimer>=Nt&&(e.waveStatus="complete",this.clearingTimer=0);return}if(e.waveStatus!=="active")return;const s=e.enemies.filter(f=>f.isAlive).length===0&&e.enemies.length>0,o=this.levels.get(e.currentLevel),l=o?.waves[e.currentWave-1]?.bossSpawn===!0,a=l&&e.boss&&!e.boss.isAlive&&!e.boss.deathSequence;(l?a:s)&&(o&&e.currentWave<o.waves.length?(e.currentWave++,e.waveStatus="transition",this.waveTransitionTimer=0,this.spawnWave(e,o.waves[e.currentWave-1])):(e.waveStatus="clearing",this.clearingTimer=0))}getTotalWaves(e){const t=this.levels.get(e);return t?t.waves.length:0}hasLevel(e){return this.levels.has(e)}getLevelName(e){return this.levels.get(e)?.name??""}spawnWave(e,t){if(e.enemies=[],e.projectiles=[],t.bossSpawn){e.boss=Vo();return}if(t.slots&&t.slots.length>0){let o=0,n=0;for(const l of t.slots)l.row>o&&(o=l.row),l.col>n&&(n=l.col);e.formation=ni(o+1,n+1);for(const l of t.slots){const a=ri[l.type]??ge;e.enemies.push(a(l.row,l.col))}}else{let o=0,n=0;for(const a of t.enemies)o+=a.rows,a.cols>n&&(n=a.cols);e.formation=ni(o,n);let l=0;for(const a of t.enemies){const r=ri[a.type]??ge;for(let f=0;f<a.rows;f++)for(let d=0;d<a.cols;d++)e.enemies.push(r(l+f,d));l+=a.rows}}const s=t.formation??t.enemies[0]?.formation??"grid";s!=="grid"&&(e.formation.offsetY=40,Fo(s,e.enemies,e.formation))}}let jo=0;function Qo(i,e){return{id:`plasma-${jo++}`,type:"plasma",owner:e,position:{x:i.x,y:i.y},velocity:{x:0,y:Ye},rotation:Math.PI,speed:Ye,damage:Zi,isActive:!0,lifetime:0,maxLifetime:Ji,collisionRadius:et,hasCollided:!1}}let Zo=0;function fi(i,e){return{id:`enemy-homing-${Zo++}`,type:"missile",owner:e,position:{x:i.x,y:i.y},velocity:{x:0,y:Be},rotation:Math.PI,speed:Be,damage:xi,isActive:!0,lifetime:0,maxLifetime:Ki,collisionRadius:Vi,hasCollided:!1,turnRate:Gi,isHoming:!0}}const Jo={laser:{base:3e3,jitter:500},bullet:{base:2e3,jitter:500},plasma:{base:2500,jitter:400},spread:{base:4e3,jitter:600},homing:{base:3500,jitter:500}};class es{constructor(){this.cooldowns=new Map}update(e,t){const s=e.enemies.filter(n=>n.isAlive);if(s.length===0)return;const o=this.getFrontRowEnemyIds(s);for(const n of s){if(n.fireMode==="none"||!o.has(n.id))continue;this.cooldowns.has(n.id)||this.cooldowns.set(n.id,this.randomCooldown(n.fireMode));let l=this.cooldowns.get(n.id);l-=t*1e3,l<=0&&(this.fireProjectile(e,n),l=this.randomCooldown(n.fireMode)),this.cooldowns.set(n.id,l)}for(const[n]of this.cooldowns)s.some(l=>l.id===n)||this.cooldowns.delete(n)}getFrontRowEnemyIds(e){const t=new Map;for(const s of e){const o=t.get(s.formationCol);(!o||s.position.y>o.y)&&t.set(s.formationCol,{id:s.id,y:s.position.y})}return new Set([...t.values()].map(s=>s.id))}fireProjectile(e,t){const s={type:"enemy",id:t.id},o={x:t.position.x,y:t.position.y+16};if(t.fireMode==="spread"){const a=[-12,-4,4,12].map(r=>{const f=r*Math.PI/180,d=me(o,s);return d.velocity.x=Math.sin(f)*Z,d.velocity.y=Math.cos(f)*Z,d});e.projectiles=[...e.projectiles,...a];return}let n;t.fireMode==="laser"?n=to(o,s):t.fireMode==="plasma"?n=Qo(o,s):t.fireMode==="homing"?n=fi(o,s):n=me(o,s),e.projectiles=[...e.projectiles,n]}randomCooldown(e){const t=Jo[e];return t?t.base+(Math.random()*2-1)*t.jitter:5e3}reset(){this.cooldowns.clear()}}const is=2,Se=3,ts=300,os={A:1,B:.7,C:1.5,F:.8},ss=40,X=.2,ne=.5;class ns{constructor(){this.activeDivers=new Set,this.cooldownTimer=Se}update(e,t){const s=e.enemies.filter(o=>o.isAlive);if(s.length!==0){this.cooldownTimer-=t,this.activeDivers.size<is&&this.cooldownTimer<=0&&this.initiateDive(e,s);for(const o of s)o.diveState&&this.updateDivingEnemy(o,e,t);for(const o of this.activeDivers)s.some(n=>n.id===o)||this.activeDivers.delete(o)}}initiateDive(e,t){const s=t.filter(a=>!a.diveState&&!a.flightPathState&&!this.activeDivers.has(a.id));if(s.length===0)return;const o=s[Math.floor(Math.random()*s.length)],n=e.players.filter(a=>a.isAlive),l=n.length>0?n[Math.floor(Math.random()*n.length)].position.x:p/2;o.diveState={phase:"break",progress:0,targetX:l,startPos:{x:o.position.x,y:o.position.y}},this.activeDivers.add(o.id),this.cooldownTimer=Se}updateDivingEnemy(e,t,s){const o=e.diveState,l=ts*(os[e.type]??1)*s/g;if(o.progress+=l,o.progress<=X){const a=o.progress/X;e.position.x=o.startPos.x+(o.targetX-o.startPos.x)*a*.5,e.position.y=o.startPos.y+a*100}else if(o.progress<=X+ne){const a=(o.progress-X)/ne,r=o.startPos.x+(o.targetX-o.startPos.x)*.5,f=o.startPos.y+100;e.position.x=r+(o.targetX-r)*a,e.position.y=f+a*(g*.6)}else{o.phase="sweep";const a=(o.progress-X-ne)/(1-X-ne),r=o.startPos.y+100+g*.6;e.position.x=o.targetX,e.position.y=r+a*g*.4}e.position.y>g+ss&&this.returnToFormation(e,t)}returnToFormation(e,t){const s=t.formation;e.position.x=s.offsetX+(e.formationCol+.5)*s.cellWidth,e.position.y=s.offsetY+(e.formationRow+.5)*s.cellHeight,e.diveState=null,this.activeDivers.delete(e.id)}getActiveDiverCount(){return this.activeDivers.size}isDiving(e){return this.activeDivers.has(e)}reset(){this.activeDivers.clear(),this.cooldownTimer=Se}}let Y,ls=.3;function as(...i){return ci(hi(...i))}function ci(i){if(!Y)try{Y=new AudioContext}catch{return}const e=Y.createBuffer(1,i.length,Y.sampleRate),t=e.getChannelData(0);for(let n=0;n<i.length;n++)t[n]=i[n];const s=Y.createBufferSource(),o=Y.createGain();return o.gain.value=ls,s.buffer=e,s.connect(o),o.connect(Y.destination),s.start(),s}function hi(i=1,e=.05,t=220,s=0,o=0,n=.1,l=0,a=1,r=0,f=0,d=0,c=0,u=0,v=0,m=0,h=0,E=0,M=1,A=0,k=0){const b=Math.PI*2;let ae=r*=500*b/44100/44100,x=t*=(1+e*2*Math.random()-e)*b/44100,K=[],I=0,Ti=0,O=0,re=1,xs=0,Pi=0,q=0,j;s=s*44100+9,A=A*44100+9,o=o*44100,n=n*44100,E=E*44100,f*=500*b/44100**3,m*=b/44100,d*=b/44100,c*=44100,u=u*44100|0;const Ri=s+A+o+n+E|0;for(;O<Ri;K[O++]=q*i){++Pi>=100&&(Pi=0,q=0),u&&!(++xs%u)&&(t=x,r=ae,re=re||1),c&&!(re%c)&&(t+=d,x+=d,re=0),t+=r+=f,I+=t-t*v*(Math.sin(O)**2+.5);const Li=O<s?O/s:O<s+A?1+(M-1)*((O-s)/A):O<s+A+o?M:O<Ri-E?M*(1-(O-s-A-o)/n):0;j=l===0?Math.sin(I):l===1?Math.sin(I)**3:l===2?I%b>Math.PI?-1:1:l===3?I%b/b*2-1:Math.random()*2-1,j*=1-k+k*Math.sin(b*O/44100/(1/(k*10|0))),m&&(Ti+=m,j*=Math.sin(Ti)),h?q+=j*Li-q:q=j*Li}return K}const di={playerFire:[.5,.01,800,0,.02,.04,2,1,20,0,0,0,0,0,0,0,0,.5,.02,0],enemyFire:[.4,.02,400,0,.02,.06,2,1,-10,0,0,0,0,0,0,0,0,.5,.02,0],explosion:[.6,.05,200,0,.06,.2,3,1,0,0,0,0,0,1,0,0,0,.3,.1,0],playerDeath:[.8,.05,150,.01,.15,.4,3,1,-5,0,0,0,0,1,0,0,.1,.2,.15,0],menuSelect:[.3,0,600,0,.01,.02,0,1,0,0,200,.01,0,0,0,0,0,.8,0,0],hitA:[.5,.02,600,0,.03,.06,3,1,15,0,0,0,0,.3,0,0,0,.4,.04,0],hitB:[.7,.04,300,0,.06,.15,3,1,-8,-2,0,0,0,.8,0,0,0,.3,.1,0],hitC:[.6,.03,500,0,.04,.08,3,1,25,3,100,.02,0,.5,0,0,0,.4,.05,0],hitD:[.7,.03,250,.01,.08,.18,3,1,-5,-1,0,0,0,.6,0,0,0,.3,.12,0],hitE:[.8,.05,180,.01,.1,.25,3,1,-8,-2,0,0,0,.9,0,0,0,.2,.15,0],typeKey:[.15,.01,1200,0,.005,.01,0,1,0,0,0,0,0,0,0,0,0,.8,.005,0],asteroidHit:[.5,.04,150,0,.04,.08,3,1,-3,0,0,0,0,.7,0,0,0,.3,.06,0],asteroidExplode:[.7,.06,100,.01,.1,.3,3,1,-6,-1,0,0,0,1,0,0,0,.2,.15,0],hitF:[.9,.06,120,.02,.12,.3,3,1,-10,-3,0,0,0,1,0,0,0,.2,.18,0],missileWhistle:[.3,.02,600,.05,.2,.15,0,1,30,5,0,0,0,0,0,0,0,.5,.1,.2],bossExplosion:[3,.12,40,.04,.5,1.2,3,1,-12,-4,0,0,0,2,0,0,.2,.25,.4,0],lifePickup:[.4,0,800,0,.02,.08,0,1,10,0,400,.02,0,0,0,0,0,.7,.02,0]},L=class L{static init(){L.initialized=!0}static play(e){if(L.muted)return;const t=di[e];if(t)try{as(...t)}catch{}}static setMuted(e){L.muted=e}static isMuted(){return L.muted}static toggleMute(){return L.muted=!L.muted,L.muted}static reset(){L.muted=!1,L.initialized=!1}static getPreset(e){return di[e]}};L.muted=!1,L.initialized=!1;let S=L;function rs(i){const[e,t,s,o]=i,n=44100*60/o/4|0,l=s[0].length,a=t[0]?.length??0,r=[];for(let c=0;c<a;c++)r.push([]);for(let c=0;c<l;c++)for(let u=0;u<a;u++){const v=s[u][c],m=t[v];if(!m||!m[u])continue;const h=m[u],E=h.length/3|0;for(let M=0;M<E;M++){const A=h[M*3],k=h[M*3+1];if(A!==void 0&&A>0&&k!==void 0){const F=[...e[k]||[]],b=F[2]||220;F[2]=b*2**((A-60)/12);const x=hi(...F).slice(0,n);r[u].length;const K=(c*E+M)*n;for(;r[u].length<K;)r[u].push(0);for(let I=0;I<x.length;I++)r[u].length<=K+I?r[u].push(x[I]):r[u][K+I]+=x[I]}else{const F=(c*E+M+1)*n;for(;r[u].length<F;)r[u].push(0)}}}const f=Math.max(...r.map(c=>c.length),0),d=new Array(f).fill(0);for(const c of r)for(let u=0;u<c.length;u++)d[u]+=c[u];if(a>1){const c=1/a;for(let u=0;u<d.length;u++)d[u]*=c}return d}const fs={menu:[[[.3,0,220,.1,.3,.2,0,1,0,0,0,0,0,0,0,0,0,.7,.05,0],[.25,0,110,0,.15,.1,2,1,0,0,0,0,0,0,0,0,0,.5,.02,0]],[[[60,0,0,64,0,0,67,0,0,64,0,0,60,0,0,62,0,0,65,0,0,62,0,0],[48,1,0,0,void 0,0,48,1,0,0,void 0,0,45,1,0,0,void 0,0,45,1,0,0,void 0,0]],[[65,0,0,67,0,0,69,0,0,67,0,0,65,0,0,64,0,0,62,0,0,60,0,0],[41,1,0,0,void 0,0,41,1,0,0,void 0,0,43,1,0,0,void 0,0,48,1,0,0,void 0,0]]],[[0,1,0,1],[0,1,0,1]],90],level1:[[[.25,0,220,.12,.35,.25,0,1,0,0,0,0,0,0,0,0,0,.6,.08,0],[.2,0,55,.02,.2,.15,0,1,0,0,0,0,0,0,0,0,0,.5,.04,0],[.15,0,440,.01,.1,.12,1,1,0,0,0,0,0,0,0,0,0,.4,.03,.3]],[[[60,0,0,0,void 0,0,64,0,0,0,void 0,0,67,0,0,0,void 0,0,64,0,0,0,void 0,0],[48,1,0,0,void 0,0,48,1,0,0,void 0,0,43,1,0,0,void 0,0,45,1,0,0,void 0,0],[72,2,0,0,void 0,0,76,2,0,0,void 0,0,79,2,0,0,void 0,0,76,2,0,0,void 0,0]],[[64,0,0,0,void 0,0,67,0,0,0,void 0,0,69,0,0,0,void 0,0,67,0,0,0,void 0,0],[45,1,0,0,void 0,0,43,1,0,0,void 0,0,48,1,0,0,void 0,0,45,1,0,0,void 0,0],[79,2,0,0,void 0,0,81,2,0,0,void 0,0,84,2,0,0,void 0,0,79,2,0,0,void 0,0]],[[60,0,0,0,void 0,0,0,void 0,0,0,void 0,0,62,0,0,0,void 0,0,0,void 0,0,0,void 0,0],[36,1,0,0,void 0,0,0,void 0,0,0,void 0,0,40,1,0,0,void 0,0,0,void 0,0,0,void 0,0],[72,2,0,0,void 0,0,0,void 0,0,0,void 0,0,74,2,0,0,void 0,0,0,void 0,0,0,void 0,0]]],[[0,0,1,2,0,1],[0,0,1,2,0,1],[0,0,1,2,0,1]],105],level2:[[[.4,0,220,.01,.15,.1,1,1,0,0,0,0,0,0,0,0,0,.7,.02,0],[.3,0,110,.01,.2,.12,2,1,0,0,0,0,0,0,0,0,0,.6,.03,0],[.35,0,100,0,.02,.05,4,1,0,0,0,0,0,2,0,0,0,.3,.01,0]],[[[64,0,0,67,0,0,71,0,0,67,0,0,64,0,0,69,0,0,67,0,0,64,0,0],[40,1,0,0,void 0,0,40,1,0,0,void 0,0,45,1,0,0,void 0,0,43,1,0,0,void 0,0],[60,2,0,0,void 0,0,60,2,0,60,2,0,60,2,0,0,void 0,0,60,2,0,60,2,0]],[[71,0,0,72,0,0,74,0,0,72,0,0,69,0,0,67,0,0,64,0,0,67,0,0],[45,1,0,45,1,0,43,1,0,0,void 0,0,40,1,0,40,1,0,43,1,0,0,void 0,0],[60,2,0,60,2,0,60,2,0,0,void 0,0,60,2,0,60,2,0,60,2,0,60,2,0]]],[[0,1,0,1],[0,1,0,1],[0,1,0,1]],130],level3:[[[.4,0,220,.01,.15,.1,1,1,0,0,0,0,0,0,0,0,0,.7,.02,0],[.3,0,110,.01,.2,.12,2,1,0,0,0,0,0,0,0,0,0,.6,.03,0],[.35,0,100,0,.02,.05,4,1,0,0,0,0,0,2,0,0,0,.3,.01,0]],[[[69,0,0,72,0,0,76,0,0,72,0,0,69,0,0,74,0,0,72,0,0,69,0,0],[45,1,0,0,void 0,0,45,1,0,0,void 0,0,48,1,0,0,void 0,0,50,1,0,0,void 0,0],[60,2,0,0,void 0,0,60,2,0,60,2,0,60,2,0,0,void 0,0,60,2,0,60,2,0]],[[72,0,0,74,0,0,76,0,0,74,0,0,72,0,0,69,0,0,67,0,0,69,0,0],[48,1,0,48,1,0,50,1,0,0,void 0,0,45,1,0,45,1,0,43,1,0,0,void 0,0],[60,2,0,60,2,0,60,2,0,0,void 0,0,60,2,0,60,2,0,60,2,0,60,2,0]]],[[0,1,0,1],[0,1,0,1],[0,1,0,1]],135],level4:[[[.35,0,330,0,.05,.04,1,1,0,0,0,0,0,0,0,0,0,.5,.01,0],[.4,0,55,.01,.25,.2,0,1,0,0,0,0,0,0,0,0,0,.7,.05,0],[.3,0,150,0,.02,.03,4,1,0,0,0,0,0,2.5,0,0,0,.3,.01,0]],[[[72,0,0,0,void 0,0,75,0,0,72,0,0,0,void 0,0,77,0,0,72,0,0,0,void 0,0],[36,1,0,0,void 0,0,0,void 0,0,36,1,0,0,void 0,0,0,void 0,0,34,1,0,0,void 0,0],[60,2,0,60,2,0,0,void 0,0,60,2,0,60,2,0,60,2,0,0,void 0,0,60,2,0]],[[75,0,0,77,0,0,79,0,0,0,void 0,0,82,0,0,79,0,0,77,0,0,75,0,0],[36,1,0,36,1,0,0,void 0,0,0,void 0,0,34,1,0,34,1,0,0,void 0,0,36,1,0],[60,2,0,60,2,0,60,2,0,60,2,0,60,2,0,60,2,0,60,2,0,60,2,0]]],[[0,1,0,1],[0,1,0,1],[0,1,0,1]],165],level5:[[[.45,0,220,.01,.12,.08,1,1,0,0,0,0,0,0,0,0,0,.7,.02,0],[.35,0,110,.01,.2,.15,2,1,0,0,0,0,0,0,0,0,0,.65,.03,0],[.35,0,100,0,.02,.05,4,1,0,0,0,0,0,2,0,0,0,.3,.01,0]],[[[64,0,0,67,0,0,69,0,0,67,0,0,64,0,0,71,0,0,69,0,0,67,0,0],[40,1,0,0,void 0,0,40,1,0,0,void 0,0,43,1,0,43,1,0,45,1,0,0,void 0,0],[60,2,0,0,void 0,0,60,2,0,60,2,0,60,2,0,0,void 0,0,60,2,0,60,2,0]],[[71,0,0,69,0,0,67,0,0,69,0,0,71,0,0,74,0,0,71,0,0,69,0,0],[47,1,0,47,1,0,45,1,0,0,void 0,0,43,1,0,43,1,0,40,1,0,0,void 0,0],[60,2,0,60,2,0,60,2,0,0,void 0,0,60,2,0,60,2,0,60,2,0,60,2,0]]],[[0,1,0,1],[0,1,0,1],[0,1,0,1]],145]},y=class y{static play(e){if(y.currentTrack!==e||!y.playing)y.stop();else return;if(y.currentTrack=e,S.isMuted()){y.playing=!0;return}y.startPlayback(e)}static stop(){if(y.sourceNode){try{y.sourceNode.stop()}catch{}y.sourceNode=null}y.currentTrack=null,y.playing=!1}static getCurrentTrack(){return y.currentTrack}static isPlaying(){return y.playing}static onMuteChanged(e){if(e){if(y.sourceNode){try{y.sourceNode.stop()}catch{}y.sourceNode=null}}else y.currentTrack&&y.playing&&y.startPlayback(y.currentTrack)}static reset(){y.stop()}static startPlayback(e){const t=fs[e];if(t)try{const s=rs(t),o=ci(s);o&&(o.loop=!0,y.sourceNode=o,y.playing=!0)}catch{y.playing=!0}}};y.currentTrack=null,y.sourceNode=null,y.playing=!1;let C=y,cs=0;class hs{constructor(){this.spawnTimer=0,this.nextSpawnDelay=de}update(e,t){if(e.currentLevel!==4||e.gameStatus!=="playing")return;this.spawnTimer+=t,this.spawnTimer>=this.nextSpawnDelay&&(this.spawnAsteroid(e),this.spawnTimer=0,this.nextSpawnDelay=de+(Math.random()*2-1)*gt);const s=t/1e3;for(const o of e.asteroids)o.isAlive&&(o.position.x+=o.velocity.x*s,o.position.y+=o.velocity.y*s,o.rotation+=o.rotationSpeed*s);e.asteroids=e.asteroids.filter(o=>o.isAlive&&o.position.y<g+50)}spawnAsteroid(e){const t=Math.random()<.4,s=t?mt:pt,o=qe+Math.random()*(St-qe),n={id:`asteroid-${cs++}`,size:t?"large":"small",position:{x:s+Math.random()*(p-s*2),y:-s},velocity:{x:(Math.random()-.5)*20,y:o},rotation:Math.random()*Math.PI*2,rotationSpeed:(Math.random()-.5)*2,health:t?ze:Ve,maxHealth:t?ze:Ve,collisionRadius:s,isAlive:!0,scoreValue:t?vt:yt};e.asteroids=[...e.asteroids,n]}reset(){this.spawnTimer=0,this.nextSpawnDelay=de}}let ds=0;class us{maybeSpawnPickup(e,t){if(Math.random()>=Et)return;const s=Math.random()<.7,o=s?"primary":"secondary",n=s?Math.random()<.5?"laser":"bullet":Math.random()<.5?"rocket":"missile",l={id:`wp-${ds++}`,category:o,currentWeapon:n,position:{x:t.x,y:t.y},velocity:{x:0,y:At},isActive:!0,cycleTimer:je,lifetime:0};e.weaponPickups=[...e.weaponPickups,l]}updatePickups(e,t){const s=t/1e3;for(const o of e.weaponPickups)if(o.isActive){if(o.position.x+=o.velocity.x*s,o.position.y+=o.velocity.y*s,o.lifetime+=t,o.lifetime>=Mt){o.isActive=!1;continue}o.cycleTimer-=t,o.cycleTimer<=0&&(o.cycleTimer=je,o.category==="primary"?o.currentWeapon=o.currentWeapon==="laser"?"bullet":"laser":o.currentWeapon=o.currentWeapon==="rocket"?"missile":"rocket")}e.weaponPickups=e.weaponPickups.filter(o=>o.isActive)}}class ps{constructor(){this.fighterSpawnTimer=0}update(e,t){const s=e.boss;if(!s||!s.isAlive){s?.deathSequence&&this.updateDeathSequence(s,e,t);return}switch(s.layer){case"entering":this.updateEntry(s,t);break;case"active":this.updateActive(s,e,t);break;case"dying":this.updateDeathSequence(s,e,t);break}this.updateTurretPositions(s)}updateEntry(e,t){e.position.y+=bt*t,e.position.y>=120&&(e.position.y=120,e.layer="active")}updateActive(e,t,s){e.position.x=p/2+Math.sin(t.currentTime*.001*.5*Math.PI*2)*60;for(const a of e.turrets)if(a.isAlive&&(a.fireCooldown-=s*1e3,a.fireCooldown<=0)){const r={type:"enemy",id:a.id},f={x:a.position.x,y:a.position.y+20};if(a.fireType==="homing"){const d=fi(f,r);t.projectiles=[...t.projectiles,d]}else if(a.fireType==="rocket")t.projectiles=[...t.projectiles,{id:`boss-rocket-${Date.now()}-${Math.random()}`,type:"rocket",owner:r,position:{...f},velocity:{x:0,y:J},rotation:Math.PI,speed:J,damage:Xe,isActive:!0,lifetime:0,maxLifetime:Ge,collisionRadius:xe,hasCollided:!1,acceleration:$e,maxSpeed:We}];else{const d=me(f,r);t.projectiles=[...t.projectiles,d]}a.fireCooldown=a.fireRate}if(e.turrets.every(a=>!a.isAlive)&&e.health>0&&(this.fighterSpawnTimer-=s*1e3,this.fighterSpawnTimer<=0)){this.fighterSpawnTimer=It;const a=ai(0,0),r=e.position.x,f=e.position.y+e.height*.4;a.position={x:r,y:f},a.velocity={x:(Math.random()-.5)*100,y:150},a.diveState={phase:"sweep",progress:0,targetX:r+(Math.random()-.5)*200,startPos:{x:r,y:f}},t.enemies=[...t.enemies,a]}}startDeathSequence(e){e.layer="dying",e.deathSequence={phase:0,timer:0,phaseDuration:Ct}}updateDeathSequence(e,t,s){if(e.deathSequence&&(e.deathSequence.timer+=s*1e3,e.deathSequence.timer>=e.deathSequence.phaseDuration)){e.deathSequence.timer=0,e.deathSequence.phase++;const o=e.turrets.length;if(e.deathSequence.phase>o){e.isAlive=!1,e.deathSequence=null;for(const n of t.players)n.isAlive&&(n.score+=e.scoreValue)}}}updateTurretPositions(e){for(const t of e.turrets)t.position.x=e.position.x+t.offsetX,t.position.y=e.position.y+t.offsetY}reset(){this.fighterSpawnTimer=0}}let ms=0;class ys{constructor(){this.spawnedThisLevel=!1,this.spawnCheckDone=!1,this.spawnAtTime=0}update(e,t){if(!this.spawnCheckDone&&e.gameStatus==="playing"&&(this.spawnCheckDone=!0,Math.random()<kt&&(this.spawnAtTime=e.currentTime+5e3+Math.random()*1e4)),!this.spawnedThisLevel&&this.spawnAtTime>0&&e.currentTime>=this.spawnAtTime){this.spawnedThisLevel=!0;const o={id:`life-${ms++}`,position:{x:100+Math.random()*600,y:-20},velocity:{x:0,y:Ot},isActive:!0,lifetime:0};e.lifePickups=[...e.lifePickups,o]}const s=t/1e3;for(const o of e.lifePickups)o.isActive&&(o.position.y+=o.velocity.y*s,o.lifetime+=t,(o.lifetime>=_t||o.position.y>g+20)&&(o.isActive=!1));e.lifePickups=e.lifePickups.filter(o=>o.isActive)}reset(){this.spawnedThisLevel=!1,this.spawnCheckDone=!1,this.spawnAtTime=0}}const vs={levelNumber:1,name:"Invasion",waves:[{waveNumber:1,delay:0,enemies:[{type:"A",count:20,formation:"grid",rows:5,cols:4,spawnDelay:0}]},{waveNumber:2,delay:3e3,enemies:[{type:"A",count:16,formation:"grid",rows:4,cols:4,spawnDelay:0},{type:"B",count:4,formation:"grid",rows:1,cols:4,spawnDelay:0}]},{waveNumber:3,delay:3e3,enemies:[{type:"A",count:12,formation:"grid",rows:3,cols:4,spawnDelay:0},{type:"B",count:4,formation:"grid",rows:1,cols:4,spawnDelay:0},{type:"C",count:4,formation:"grid",rows:1,cols:4,spawnDelay:0}]},{waveNumber:4,delay:3e3,enemies:[{type:"A",count:8,formation:"grid",rows:2,cols:4,spawnDelay:0},{type:"B",count:8,formation:"grid",rows:2,cols:4,spawnDelay:0},{type:"C",count:4,formation:"grid",rows:1,cols:4,spawnDelay:0}]},{waveNumber:5,delay:3e3,enemies:[{type:"A",count:4,formation:"grid",rows:1,cols:4,spawnDelay:0},{type:"B",count:8,formation:"grid",rows:2,cols:4,spawnDelay:0},{type:"C",count:8,formation:"grid",rows:2,cols:4,spawnDelay:0}]}]};function P(i,e){return e.map(([t,s])=>({type:i,row:t,col:s}))}const gs={levelNumber:2,name:"Earth Defence",waves:[{waveNumber:1,delay:0,enemies:[],formation:"w-curve",slots:[...P("A",[[0,0],[0,1],[0,7],[0,8],[1,1],[1,2],[1,6],[1,7],[2,2],[2,3],[2,5],[2,6]]),...P("B",[[3,3],[3,4],[3,5],[4,4]])]},{waveNumber:2,delay:3e3,enemies:[],formation:"chiral",slots:[...P("A",[[0,3],[0,4],[1,2],[1,5],[2,1],[2,6],[3,2],[3,5],[4,3],[4,4]]),...P("B",[[1,3],[1,4],[2,2],[2,3],[2,4],[2,5],[3,3],[3,4]])]},{waveNumber:3,delay:3e3,enemies:[],formation:"diagonal",slots:[...P("B",[[0,0],[0,1],[0,2],[1,2],[1,3],[1,4],[2,4],[2,5],[2,6]]),...P("C",[[3,6],[3,7],[3,8]])]},{waveNumber:4,delay:3e3,enemies:[],formation:"side-wave",slots:[...P("A",[[0,0],[0,1],[0,2],[1,0],[1,1],[1,2],[2,0],[2,1],[2,2]]),...P("B",[[0,6],[0,7],[0,8],[1,6],[1,7],[1,8],[2,6],[2,7],[2,8]]),...P("C",[[3,4],[4,4]])]},{waveNumber:5,delay:3e3,enemies:[],formation:"m-shape",slots:[...P("B",[[0,3],[0,4],[1,2],[1,3],[1,4],[1,5],[2,1],[2,6]]),...P("C",[[2,2],[2,5],[3,3],[3,4],[4,3],[4,4],[5,3],[5,4]])]},{waveNumber:6,delay:3e3,enemies:[],formation:"inverted-v",slots:[...P("A",[[0,3],[0,4],[0,5],[4,3],[4,4],[4,5]]),...P("B",[[0,2],[0,6],[1,1],[1,7],[2,0],[2,8],[3,1],[3,7],[4,2],[4,6]]),...P("C",[[1,2],[1,6],[3,2],[3,6]])]}]};function T(i,e){return e.map(([t,s])=>({type:i,row:t,col:s}))}const Ss={levelNumber:3,name:"Moon Battle",waves:[{waveNumber:1,delay:0,enemies:[],formation:"w-curve",slots:[...T("A",[[0,0],[0,1],[0,7],[0,8],[1,1],[1,2],[1,6],[1,7]]),...T("B",[[2,2],[2,3],[2,5],[2,6],[3,3],[3,4],[3,5],[4,4]])]},{waveNumber:2,delay:3e3,enemies:[],formation:"chiral",slots:[...T("A",[[0,3],[0,4],[1,2],[1,5],[3,2],[3,5],[4,3],[4,4]]),...T("C",[[2,1],[2,6]]),...T("D",[[1,3],[1,4],[2,2],[2,3],[2,4],[2,5],[3,3],[3,4]])]},{waveNumber:3,delay:3e3,enemies:[],formation:"diagonal",slots:[...T("B",[[0,0],[0,1],[0,2],[1,2],[1,3],[1,4]]),...T("D",[[2,4],[2,5],[2,6],[3,6],[3,7],[3,8]])]},{waveNumber:4,delay:3e3,enemies:[],formation:"side-wave",slots:[...T("A",[[0,0],[0,1],[0,2],[1,0],[1,1],[1,2]]),...T("B",[[2,0],[2,1],[2,2]]),...T("C",[[0,6],[0,7],[0,8]]),...T("D",[[1,6],[1,7],[1,8],[2,6],[2,7],[2,8]])]},{waveNumber:5,delay:3e3,enemies:[],formation:"m-shape",slots:[...T("C",[[0,3],[0,4],[1,2],[1,5],[2,1],[2,6]]),...T("D",[[1,3],[1,4],[2,2],[2,5],[3,3],[3,4],[4,3],[4,4]])]},{waveNumber:6,delay:3e3,enemies:[],formation:"inverted-v",slots:[...T("B",[[0,3],[0,4],[0,5],[4,3],[4,4],[4,5]]),...T("C",[[0,2],[0,6],[1,1],[1,7],[3,1],[3,7],[4,2],[4,6]]),...T("D",[[2,0],[2,8],[1,2],[1,6],[3,2],[3,6]])]}]};function w(i,e){return e.map(([t,s])=>({type:i,row:t,col:s}))}const ws={levelNumber:4,name:"Asteroid Belt",waves:[{waveNumber:1,delay:0,enemies:[],formation:"w-curve",slots:[...w("A",[[0,0],[0,1],[0,7],[0,8],[1,1],[1,7]]),...w("B",[[1,2],[1,6],[2,3],[2,5]]),...w("D",[[2,2],[2,6],[3,3],[3,4],[3,5],[4,4]])]},{waveNumber:2,delay:3e3,enemies:[],formation:"chiral",slots:[...w("B",[[0,3],[0,4],[1,2],[1,5],[3,2],[3,5],[4,3],[4,4]]),...w("C",[[2,1],[2,6]]),...w("E",[[1,3],[1,4],[2,2],[2,3],[2,4],[2,5],[3,3],[3,4]])]},{waveNumber:3,delay:3e3,enemies:[],formation:"diagonal",slots:[...w("C",[[0,0],[0,1],[0,2]]),...w("D",[[1,2],[1,3],[1,4],[2,4],[2,5]]),...w("E",[[2,6],[3,6],[3,7],[3,8]])]},{waveNumber:4,delay:3e3,enemies:[],formation:"side-wave",slots:[...w("A",[[0,0],[0,1],[0,8],[0,9]]),...w("B",[[1,0],[1,1],[1,8],[1,9]]),...w("C",[[0,4],[0,5],[1,4],[1,5]]),...w("D",[[2,2],[2,3],[2,6],[2,7]]),...w("E",[[2,4],[2,5],[3,4],[3,5]])]},{waveNumber:5,delay:3e3,enemies:[],formation:"m-shape",slots:[...w("D",[[0,3],[0,4],[1,2],[1,5],[2,1],[2,6]]),...w("E",[[1,3],[1,4],[2,2],[2,5],[3,3],[3,4],[4,3],[4,4]])]},{waveNumber:6,delay:3e3,enemies:[],formation:"inverted-v",slots:[...w("A",[[0,3],[0,4],[0,5]]),...w("B",[[0,2],[0,6],[1,1],[1,7]]),...w("C",[[2,0],[2,8],[3,1],[3,7]]),...w("D",[[4,2],[4,6],[4,3],[4,5]]),...w("E",[[1,2],[1,6],[3,2],[3,6],[4,4]])]}]};function R(i,e){return e.map(([t,s])=>({type:i,row:t,col:s}))}const Es={levelNumber:5,name:"Defeat Mars Colony",waves:[{waveNumber:1,delay:0,enemies:[],formation:"x-formation",slots:[...R("A",[[0,0],[0,1],[0,7],[0,8],[1,1],[1,7]]),...R("B",[[1,2],[1,6],[2,3],[2,5]]),...R("D",[[2,4],[3,3],[3,5]])]},{waveNumber:2,delay:3e3,enemies:[],formation:"w-curve",slots:[...R("C",[[0,1],[0,2],[0,6],[0,7]]),...R("D",[[1,2],[1,6],[2,3],[2,5]]),...R("F",[[1,3],[1,4],[1,5],[2,4]])]},{waveNumber:3,delay:3e3,enemies:[],formation:"chiral",slots:[...R("E",[[0,2],[0,6],[1,1],[1,7]]),...R("F",[[0,3],[0,4],[0,5],[1,3],[1,4],[1,5],[2,3],[2,5]])]},{waveNumber:4,delay:3e3,enemies:[],formation:"inverted-v",slots:[...R("A",[[0,0],[0,8]]),...R("B",[[0,1],[0,7]]),...R("C",[[1,2],[1,6]]),...R("D",[[1,3],[1,5]]),...R("E",[[2,2],[2,6],[3,3],[3,5]]),...R("F",[[2,3],[2,4],[2,5],[3,4]])]},{waveNumber:5,delay:3e3,enemies:[],bossSpawn:!0}]},As={1:`2029.07.04 // 03:17 UTC
first contact confirmed. space force scrambled to defend earth.`,2:`// 07:45 UTC
the swarm has reached orbit. space force activates planetary defence grid.`,3:`// 12:08 UTC
enemy stronghold detected on the far side of the moon. space force moves to intercept.`,4:`// 18:32 UTC
hostile signatures in the asteroid belt. space force navigates the debris field.`,5:`// 23:00 UTC
enemy command has seized the mars colony. space force begins final assault on the mothership.`},we=50,Ms=1500;class Ts{constructor(e={}){this.introTimer=0,this.headless=e.headless??!1,this.renderer=e.renderer??null,this.stateManager=new Wt,this.inputHandler=new Gt(this.headless),this.gameLoop=new Yt(t=>this.update(t),t=>this.render(t)),this.levelManager=new qo,this.levelManager.registerLevel(vs),this.levelManager.registerLevel(gs),this.levelManager.registerLevel(Ss),this.levelManager.registerLevel(ws),this.levelManager.registerLevel(Es),this.enemyFiringManager=new es,this.diveManager=new ns,this.asteroidManager=new hs,this.weaponPickupManager=new us,this.bossManager=new ps,this.lifePickupManager=new ys,this.stateManager.currentState.background=$(),C.play("menu")}start(){this.headless||this.gameLoop.start()}stop(){this.gameLoop.stop()}tickHeadless(e){this.gameLoop.tickHeadless(e)}getState(){return this.stateManager.currentState}getPreviousState(){return this.stateManager.previousState}update(e){this.stateManager.swapBuffers();const t=this.stateManager.currentState,s=e/1e3;switch(t.deltaTime=e,t.currentTime+=e,t.gameStatus){case"menu":this.updateMenu(t);break;case"playing":this.updatePlaying(t,s);break;case"paused":this.updatePaused(t);break;case"gameover":this.updateGameOver(t);break;case"levelcomplete":this.updateLevelComplete(t);break;case"levelintro":this.updateLevelIntro(t);break;case"gamecomplete":this.updateGameComplete(t);break}}updateMenu(e){const t=this.inputHandler.getMenuInput();if(e.menu){if(t.down&&(e.menu={...e.menu,selectedOption:Math.min(e.menu.selectedOption+1,e.menu.options.length-1)}),t.up&&(e.menu={...e.menu,selectedOption:Math.max(e.menu.selectedOption-1,0)}),e.menu.type==="levelselect"){if(t.back){S.play("menuSelect"),e.menu={type:"start",selectedOption:0,options:["1 Player","2 Players","Test Mode"]};return}if(t.confirm){S.play("menuSelect");const s=e.menu.options[e.menu.selectedOption];if(s==="Back")e.menu={type:"start",selectedOption:0,options:["1 Player","2 Players","Test Mode"]};else{const o=parseInt(s.split(":")[0].replace("Level ",""),10);e.gameMode="single",this.startGame(e,o)}}return}if(t.confirm){S.play("menuSelect");const s=e.menu.options[e.menu.selectedOption];s==="1 Player"?(e.gameMode="single",this.startGame(e)):s==="2 Players"?(e.gameMode="co-op",this.startGame(e)):s==="Test Mode"&&(e.menu={type:"levelselect",selectedOption:0,options:this.getLevelOptions()})}}}startGame(e,t=1){if(e.projectiles=[],e.gameMode==="co-op"){const s=pe("player1");s.position.x=p*.33;const o=pe("player2");o.position.x=p*.66,e.players=[s,o]}else e.players=[pe("player1")];this.enemyFiringManager.reset(),this.diveManager.reset(),this.asteroidManager.reset(),this.startLevelIntro(e,t)}startLevelIntro(e,t){const s=As[t]??`level ${t}`;e.currentLevel=t,e.gameStatus="levelintro",e.menu={type:"levelintro",selectedOption:0,options:[],data:{level:t,introText:s,introChars:0}},this.introTimer=0}getLevelOptions(){const e=[];for(let t=1;this.levelManager.hasLevel(t);t++)e.push(`Level ${t}: ${this.levelManager.getLevelName(t)}`);return e.push("Back"),e}updatePlaying(e,t){if(this.inputHandler.getPauseToggle()){e.gameStatus="paused",e.menu={type:"pause",selectedOption:0,options:["Resume","Main Menu"]};return}if(this.inputHandler.getMuteToggle()){const h=S.toggleMute();C.onMuteChanged(h)}for(const h of e.players)h.deathSequence?.active||(h.id==="player1"?h.input=this.inputHandler.getPlayerInput():h.id==="player2"&&(h.input=this.inputHandler.getPlayer2Input()));for(const h of e.players)h.deathSequence?.active||xt(h,t);for(const h of e.players)h.deathSequence?.active||(po(h,t*1e3),h.secondaryCooldown>0&&(h.secondaryCooldown-=t*1e3));const s=e.projectiles.length;no(e),e.projectiles.length-s>0&&S.play("playerFire"),so(e,t),e.formation&&e.enemies.length>0&&ao(e,t),Uo(e,t),this.diveManager.update(e,t);const n=e.projectiles.length;this.enemyFiringManager.update(e,t),e.projectiles.length>n&&S.play("enemyFire"),this.bossManager.update(e,t),e.boss?.isAlive&&e.boss.health<=0&&!e.boss.deathSequence&&this.bossManager.startDeathSequence(e.boss),e.background&&ve(e.background,t),this.asteroidManager.update(e,t*1e3),this.weaponPickupManager.updatePickups(e,t*1e3),this.lifePickupManager.update(e,t*1e3);const l=e.waveStatus;if(this.levelManager.update(e),l==="active"&&e.waveStatus!=="active")for(const h of e.players)h.isAlive&&(h.score+=Bt);if(l==="clearing"&&e.waveStatus==="complete"){C.stop();const h=e.players.reduce((M,A)=>M+A.score,0);this.levelManager.hasLevel(e.currentLevel+1)?(e.gameStatus="levelcomplete",e.menu={type:"levelcomplete",selectedOption:0,options:["Next Level","Main Menu"],data:{finalScore:h,wave:e.currentWave,level:e.currentLevel}}):(e.players.length>1,e.gameStatus="gamecomplete",this.introTimer=0,e.menu={type:"gamecomplete",selectedOption:0,options:["Main Menu"],data:{finalScore:h,introText:`mission complete // ${new Date().toISOString().slice(0,10)}

space force has defeated the mothership.

but long range sensors detect survivors
regrouping on the martian surface...

... coming soon`,introChars:0}});return}const a=new Map(e.enemies.map(h=>[h.id,{alive:h.isAlive,type:h.type}])),r=new Map(e.asteroids.map(h=>[h.id,{alive:h.isAlive,health:h.health}])),f=e.boss?new Map(e.boss.turrets.map(h=>[h.id,h.isAlive])):new Map,d=e.boss?.health??0,c=e.lifePickups.filter(h=>h.isActive).length,u=e.players.filter(h=>h.isAlive).length;mo(e),e.lifePickups.filter(h=>h.isActive).length<c&&S.play("lifePickup");for(const h of e.enemies)if(a.get(h.id)?.alive&&!h.isAlive){const M=`hit${h.type}`;S.play(M),this.weaponPickupManager.maybeSpawnPickup(e,h.position)}for(const h of e.asteroids){const E=r.get(h.id);E&&E.alive&&(h.isAlive?h.health<E.health&&S.play("asteroidHit"):S.play("asteroidExplode"))}if(e.boss){for(const h of e.boss.turrets)f.get(h.id)&&!h.isAlive&&S.play("bossExplosion");e.boss.health<d&&e.boss.health>0&&S.play("hitF")}if(e.players.filter(h=>h.isAlive).length<u){S.play("playerDeath");for(const h of e.players)!h.isAlive&&h.collisionState==="destroyed"&&(h.primaryWeapon="laser",h.primaryLevel=1,h.secondaryWeapon=null,h.secondaryTimer=0,h.secondaryCooldown=0);e.weaponPickups=[]}for(const h of e.players)h.deathSequence?.active&&e.currentTime-h.deathSequence.startTime>=h.deathSequence.duration&&(h.deathSequence.active=!1,h.lives>0&&jt(h));this.checkGameOver(e)}updatePaused(e){const t=this.inputHandler.getMenuInput();if(e.menu){if(t.back){e.gameStatus="playing",e.menu=null;return}if(t.down&&(e.menu={...e.menu,selectedOption:Math.min(e.menu.selectedOption+1,e.menu.options.length-1)}),t.up&&(e.menu={...e.menu,selectedOption:Math.max(e.menu.selectedOption-1,0)}),t.confirm){S.play("menuSelect");const s=e.menu.options[e.menu.selectedOption];s==="Resume"?(e.gameStatus="playing",e.menu=null):s==="Main Menu"&&(this.stateManager.reset(),this.stateManager.currentState.background=$(),C.play("menu"))}}}updateGameOver(e){const t=this.inputHandler.getMenuInput();if(e.menu&&(t.down&&(e.menu={...e.menu,selectedOption:Math.min(e.menu.selectedOption+1,e.menu.options.length-1)}),t.up&&(e.menu={...e.menu,selectedOption:Math.max(e.menu.selectedOption-1,0)}),t.confirm)){S.play("menuSelect");const s=e.menu.options[e.menu.selectedOption];s==="Restart"?(this.stateManager.reset(),this.stateManager.currentState.background=$(),this.startGame(this.stateManager.currentState)):s==="Main Menu"&&(this.stateManager.reset(),this.stateManager.currentState.background=$(),C.play("menu"))}}updateLevelComplete(e){const t=this.inputHandler.getMenuInput();if(e.menu&&(t.down&&(e.menu={...e.menu,selectedOption:Math.min(e.menu.selectedOption+1,e.menu.options.length-1)}),t.up&&(e.menu={...e.menu,selectedOption:Math.max(e.menu.selectedOption-1,0)}),t.confirm)){S.play("menuSelect");const s=e.menu.options[e.menu.selectedOption];if(s==="Next Level"){const o=e.currentLevel+1;e.enemies=[],e.projectiles=[],e.boss=null,e.lifePickups=[],this.enemyFiringManager.reset(),this.diveManager.reset(),this.lifePickupManager.reset(),this.startLevelIntro(e,o)}else s==="Main Menu"&&(this.stateManager.reset(),this.stateManager.currentState.background=$(),C.play("menu"))}}updateGameComplete(e){if(!e.menu?.data)return;const t=e.menu.data,s=t.introText??"",o=t.introChars??0;if(this.introTimer+=e.deltaTime,o<s.length){const n=Math.min(Math.floor(this.introTimer/we),s.length);n>o&&(s[n-1]!==" "&&S.play("typeKey"),e.menu={...e.menu,data:{...t,introChars:n}})}else this.inputHandler.getMenuInput().confirm&&(S.play("menuSelect"),this.stateManager.reset(),this.stateManager.currentState.background=$(),C.play("menu"));e.background&&ve(e.background,e.deltaTime/1e3)}updateLevelIntro(e){if(!e.menu?.data)return;const t=e.menu.data,s=t.introText??"",o=t.introChars??0;if(this.introTimer+=e.deltaTime,o<s.length){const n=Math.min(Math.floor(this.introTimer/we),s.length);n>o&&(s[n-1]!==" "&&S.play("typeKey"),e.menu={...e.menu,data:{...t,introChars:n}})}else{const n=s.length*we;this.introTimer>=n+Ms&&(e.gameStatus="playing",e.menu=null,C.play("level"+(t.level??1)),this.levelManager.startLevel(e,t.level??1))}e.background&&ve(e.background,e.deltaTime/1e3)}checkGameOver(e){if(e.players.some(o=>o.deathSequence?.active))return;const s=e.players.filter(o=>o.isAlive||o.lives>0);if(e.players.length>0&&s.length===0){e.gameStatus="gameover",C.play("menu");const o=e.players.find(a=>a.id==="player1"),n=e.players.find(a=>a.id==="player2"),l=o?.score??0;e.menu={type:"gameover",selectedOption:0,options:["Restart","Main Menu"],data:{finalScore:l,...n?{p2Score:n.score}:{}}}}}render(e){this.renderer&&this.renderer.render(this.stateManager.currentState,this.stateManager.previousState,e)}destroy(){this.stop(),C.stop(),this.inputHandler.destroy(),this.renderer&&this.renderer.destroy()}}const Ps=`
  .menu-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: rgba(0, 0, 0, 0.85);
    font-family: 'Courier New', monospace;
    color: #fff;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 1000;
  }

  .menu-overlay.visible {
    opacity: 1;
  }

  .menu-title {
    font-size: 52px;
    font-weight: bold;
    color: #ffff00;
    margin-bottom: 12px;
  }

  .menu-title.gameover {
    color: #ff4444;
  }

  .menu-title.levelcomplete {
    color: #44ff44;
  }

  .menu-title.gamecomplete {
    color: #ffdd00;
    text-shadow: 0 0 12px #ffdd00, 0 0 30px #ff8800;
  }

  .menu-subtitle {
    font-size: 16px;
    color: #88aacc;
    margin-bottom: 30px;
  }

  .menu-controls {
    font-size: 14px;
    color: #888;
    margin-bottom: 8px;
  }

  .menu-controls-group {
    margin-bottom: 24px;
  }

  .menu-score {
    font-size: 24px;
    color: #fff;
    margin-bottom: 8px;
  }

  .menu-p2score {
    font-size: 18px;
    color: #4488ff;
    margin-bottom: 16px;
  }

  .menu-options {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .menu-option {
    font-size: 22px;
    color: #666;
    padding: 6px 0;
    transition: color 0.15s;
  }

  .menu-option.selected {
    color: #ffff00;
  }

  .menu-option.selected::before {
    content: '> ';
  }

  .menu-version {
    position: absolute;
    bottom: 12px;
    font-size: 12px;
    color: #44ff44;
  }

  .intro-level-label {
    font-size: 18px;
    color: #888;
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 4px;
  }

  .intro-typing {
    font-size: 28px;
    color: #00ffff;
    text-shadow: 0 0 8px #00ffff, 0 0 20px #006688;
    min-height: 40px;
  }

  .intro-cursor {
    animation: blink 0.6s step-end infinite;
    color: #00ffff;
  }

  @keyframes blink {
    50% { opacity: 0; }
  }
`;class Rs{constructor(e,t=Ci){this.lastMenuType=null,this.lastSelectedOption=-1,this.lastMenuDataHash="",this.container=e,this.version=t,this.styleEl=document.createElement("style"),this.styleEl.textContent=Ps,document.head.appendChild(this.styleEl),this.overlay=document.createElement("div"),this.overlay.className="menu-overlay",this.container.appendChild(this.overlay)}update(e){const t=e.menu;if(!(e.gameStatus==="menu"||e.gameStatus==="paused"||e.gameStatus==="gameover"||e.gameStatus==="levelcomplete"||e.gameStatus==="levelintro"||e.gameStatus==="gamecomplete")||!t){this.hide();return}const o=JSON.stringify(t.data||{});(t.type!==this.lastMenuType||o!==this.lastMenuDataHash)&&(this.buildMenu(t.type,t.options,t.data),this.lastMenuType=t.type,this.lastMenuDataHash=o),t.selectedOption!==this.lastSelectedOption&&(this.updateSelection(t.selectedOption),this.lastSelectedOption=t.selectedOption),this.show()}buildMenu(e,t,s){if(this.overlay.innerHTML="",e==="start")this.overlay.innerHTML=`
        <div class="menu-title">PB-GALAGA</div>
        <div class="menu-subtitle">A Space Shooter</div>
        <div class="menu-controls-group">
          <div class="menu-controls">Arrow Keys: Move Ship</div>
          <div class="menu-controls">Spacebar: Fire Laser</div>
        </div>
        ${this.buildOptions(t)}
        <div class="menu-version">v${this.version}</div>
      `;else if(e==="pause")this.overlay.innerHTML=`
        <div class="menu-title">PAUSED</div>
        <div class="menu-controls-group">
          <div class="menu-controls">Press ESC to resume</div>
        </div>
        ${this.buildOptions(t)}
      `;else if(e==="gameover"){let o="";s?.finalScore!==void 0&&(o+=`<div class="menu-score">Final Score: ${s.finalScore}</div>`),s?.p2Score!==void 0&&(o+=`<div class="menu-p2score">P2 Score: ${s.p2Score}</div>`),this.overlay.innerHTML=`
        <div class="menu-title gameover">GAME OVER</div>
        ${o}
        ${this.buildOptions(t)}
      `}else if(e==="levelintro"){const o=s?.level??1,n=s?.introText??"",l=s?.introChars??0,a=n.slice(0,l).replace(/\n/g,"<br>"),r=l>=n.length;this.overlay.innerHTML=`
        <div class="intro-level-label">Level ${o}</div>
        <div class="intro-typing">${a}${r?"":'<span class="intro-cursor">_</span>'}</div>
      `}else if(e==="levelselect")this.overlay.innerHTML=`
        <div class="menu-title">SELECT LEVEL</div>
        <div class="menu-controls-group">
          <div class="menu-controls">Press ESC to go back</div>
        </div>
        ${this.buildOptions(t)}
        <div class="menu-version">v${this.version}</div>
      `;else if(e==="levelcomplete"){let o="";s?.finalScore!==void 0&&(o+=`<div class="menu-score">Total Score: ${s.finalScore}</div>`);const n=s?.level?`LEVEL ${s.level} COMPLETE!`:"LEVEL COMPLETE!";this.overlay.innerHTML=`
        <div class="menu-title levelcomplete">${n}</div>
        ${o}
        ${this.buildOptions(t)}
      `}else if(e==="gamecomplete"){const o=s?.introText??"",n=s?.introChars??0,l=o.slice(0,n).replace(/\n/g,"<br>"),a=n>=o.length;let r="";s?.finalScore!==void 0&&(r+=`<div class="menu-score">Final Score: ${s.finalScore}</div>`),this.overlay.innerHTML=`
        <div class="menu-title gamecomplete">MISSION COMPLETE</div>
        ${r}
        <div class="intro-typing">${l}${a?"":'<span class="intro-cursor">_</span>'}</div>
        ${a?this.buildOptions(t):""}
      `}}buildOptions(e){return`<ul class="menu-options">${e.map((s,o)=>`<li class="menu-option" data-index="${o}">${s}</li>`).join("")}</ul>`}updateSelection(e){this.overlay.querySelectorAll(".menu-option").forEach((s,o)=>{s.classList.toggle("selected",o===e)})}show(){this.overlay.classList.add("visible")}hide(){this.overlay.classList.contains("visible")&&(this.overlay.classList.remove("visible"),this.lastMenuType=null,this.lastSelectedOption=-1,this.lastMenuDataHash="")}destroy(){this.overlay.remove(),this.styleEl.remove()}}function Ee(i,e){for(const t of e){const s=Math.floor(t.brightness*255);i.fillStyle=`rgb(${s},${s},${s})`,t.brightness>.7&&(i.shadowBlur=2,i.shadowColor=`rgba(180, 200, 255, ${t.brightness*.5})`),i.fillRect(Math.floor(t.position.x),Math.floor(t.position.y),Math.ceil(t.size),Math.ceil(t.size)),t.brightness>.7&&(i.shadowBlur=0)}}function ui(i,e,t){return i+(e-i)*t}function Ae(i,e,t){return{x:ui(i.x,e.x,t),y:ui(i.y,e.y,t)}}const pi={red:{fill:"#ff3344",glow:"#ff3344",cockpit:"#2244aa"},blue:{fill:"#0099ff",glow:"#0099ff",cockpit:"#aa2244"}};function mi(i,e,t,s,o){for(const n of e){if(!n.isAlive||n.deathSequence?.active)continue;const l=t.get(n.id),a=l?Ae(l.position,n.position,s):n.position,r=pi[n.shipColor]||pi.red;if(i.save(),n.isInvulnerable){const f=Math.floor(o/100)%2===0;i.globalAlpha=f?1:.3}i.shadowBlur=12,i.shadowColor=r.glow,i.fillStyle=r.fill,i.beginPath(),i.moveTo(a.x,a.y-14),i.lineTo(a.x-12,a.y+12),i.lineTo(a.x+12,a.y+12),i.closePath(),i.fill(),i.shadowBlur=0,i.fillStyle=r.cockpit,i.fillRect(a.x-2,a.y-2,4,6),i.shadowBlur=6,i.shadowColor="#ffaa22",i.fillStyle="#ffff44",i.fillRect(a.x-5,a.y+10,3,3),i.fillRect(a.x+2,a.y+10,3,3),i.shadowBlur=0,i.restore()}}const yi={A:{fill:"#00ff44",glow:"#00ff44",accent:"#44ee66"},B:{fill:"#00ccff",glow:"#00ccff",accent:"#44bbee"},C:{fill:"#ff5500",glow:"#ff5500",accent:"#ff8822"},D:{fill:"#ff00ff",glow:"#ff00ff",accent:"#ff66ff"},E:{fill:"#ffff00",glow:"#ffff00",accent:"#ffff66"},F:{fill:"#00ff88",glow:"#00ff88",accent:"#44ffaa"}};function vi(i,e,t,s){for(const o of e){if(!o.isAlive)continue;const n=t.get(o.id),l=n?Ae(n.position,o.position,s):o.position,a=yi[o.type]||yi.A;i.save(),i.shadowBlur=10,i.shadowColor=a.glow,o.type==="A"?Ls(i,l.x,l.y,a):o.type==="B"?Cs(i,l.x,l.y,a):o.type==="C"?bs(i,l.x,l.y,a):o.type==="D"?Is(i,l.x,l.y,a):o.type==="F"?Os(i,l.x,l.y,a):ks(i,l.x,l.y,a),i.restore()}}function Ls(i,e,t,s){i.fillStyle=s.fill,i.fillRect(e-4,t-12,8,4),i.fillRect(e-8,t-8,16,10),i.fillRect(e-6,t+2,12,4),i.fillRect(e-10,t+6,4,5),i.fillRect(e+6,t+6,4,5),i.fillRect(e-2,t+6,4,5),i.fillStyle=s.accent,i.fillRect(e-2,t-10,4,2),i.shadowBlur=0,i.fillStyle="#ff2222",i.fillRect(e-5,t-5,3,3),i.fillRect(e+2,t-5,3,3),i.fillStyle="#ffffff",i.fillRect(e-4,t-4,1,1),i.fillRect(e+3,t-4,1,1)}function Cs(i,e,t,s){i.fillStyle=s.fill,i.fillRect(e-8,t-12,16,4),i.fillRect(e-10,t-8,20,6),i.fillRect(e-12,t-2,24,8),i.fillRect(e-8,t+6,16,4),i.fillStyle="#006699",i.fillRect(e-10,t-2,4,4),i.fillRect(e+6,t-2,4,4),i.shadowBlur=0,i.fillStyle="#ffaa22",i.fillRect(e-6,t-6,4,3),i.fillRect(e+2,t-6,4,3),i.fillStyle="#ffffff",i.fillRect(e-5,t-5,2,1),i.fillRect(e+3,t-5,2,1),i.fillStyle=s.accent,i.fillRect(e-4,t+2,8,2)}function bs(i,e,t,s){i.fillStyle=s.fill,i.beginPath(),i.moveTo(e,t-12),i.lineTo(e-6,t-4),i.lineTo(e+6,t-4),i.closePath(),i.fill(),i.fillRect(e-8,t-4,16,6),i.fillRect(e-14,t+2,28,4),i.fillRect(e-4,t+6,8,4),i.fillStyle=s.accent,i.fillRect(e-14,t+4,4,2),i.fillRect(e+10,t+4,4,2),i.shadowBlur=0,i.fillStyle="#44ff44",i.fillRect(e-4,t-2,3,2),i.fillRect(e+1,t-2,3,2)}function Is(i,e,t,s){i.fillStyle=s.fill,i.beginPath(),i.arc(e,t+4,12,Math.PI*1.15,Math.PI*1.85),i.lineTo(e+8,t-8),i.arc(e,t+4,8,Math.PI*1.85,Math.PI*1.15,!0),i.closePath(),i.fill(),i.fillRect(e-13,t-8,4,6),i.fillRect(e+9,t-8,4,6),i.fillStyle=s.accent,i.fillRect(e-3,t+8,6,5),i.shadowBlur=0,i.fillStyle="#ffffff",i.fillRect(e-2,t-2,4,3),i.fillStyle="#ff00ff",i.fillRect(e-1,t-1,2,1)}function ks(i,e,t,s){i.fillStyle=s.fill,i.beginPath(),i.moveTo(e,t+8),i.lineTo(e-18,t-6),i.lineTo(e-14,t-10),i.lineTo(e-4,t-2),i.lineTo(e,t-6),i.lineTo(e+4,t-2),i.lineTo(e+14,t-10),i.lineTo(e+18,t-6),i.closePath(),i.fill(),i.fillStyle=s.accent,i.fillRect(e-8,t-5,3,3),i.fillRect(e+5,t-5,3,3),i.shadowBlur=0,i.fillStyle="#ff4444",i.fillRect(e-3,t+2,6,2),i.fillStyle=s.accent,i.fillRect(e-17,t-8,3,2),i.fillRect(e+14,t-8,3,2)}function Os(i,e,t,s){i.fillStyle=s.fill,i.beginPath(),i.moveTo(e,t+10),i.lineTo(e-20,t-8),i.lineTo(e-16,t-12),i.lineTo(e-6,t-4),i.lineTo(e,t-8),i.lineTo(e+6,t-4),i.lineTo(e+16,t-12),i.lineTo(e+20,t-8),i.closePath(),i.fill(),i.fillStyle=s.accent,i.fillRect(e-10,t-6,4,4),i.fillRect(e+6,t-6,4,4),i.fillStyle="#006644",i.fillRect(e-3,t+2,6,4),i.shadowBlur=0,i.fillStyle="#ff2222",i.fillRect(e-4,t-1,8,2),i.fillStyle=s.accent,i.fillRect(e-19,t-10,3,2),i.fillRect(e+16,t-10,3,2)}const gi=[.35,.2,.1,.04],_s=8;function Si(i,e,t,s){for(const o of e){if(!o.isActive)continue;const n=t.get(o.id),l=n?Ae(n.position,o.position,s):o.position,a=o.velocity.x,r=o.velocity.y,f=Math.sqrt(a*a+r*r),d=f>0?a/f:0,c=f>0?r/f:-1;if(o.type==="laser")G(i,l.x,l.y,d,c,"#00ffff",4,12);else if(o.type==="plasma")G(i,l.x,l.y,d,c,"#ff00ff",6,10);else if(o.type==="rocket")G(i,l.x,l.y,d,c,"#aa44ff",5,10);else if(o.type==="missile")G(i,l.x,l.y,d,c,"#44ff44",3,6);else if(o.type==="snake")G(i,l.x,l.y,d,c,"#00ffff",8,14);else{const v=o.owner.type==="player"?"#ff4444":"#ff8800";G(i,l.x,l.y,d,c,v,4,6)}if(i.save(),o.type==="laser")i.shadowBlur=8,i.shadowColor="#00ffff",i.fillStyle="#00ffff",i.fillRect(l.x-2,l.y-6,4,12),i.shadowBlur=0,i.fillStyle="#ffffff",i.fillRect(l.x-1,l.y-5,2,10);else if(o.type==="plasma")i.shadowBlur=12,i.shadowColor="#ff00ff",i.fillStyle="#ff00ff",i.fillRect(l.x-3,l.y-5,6,10),i.shadowBlur=0,i.fillStyle="#ffffff",i.fillRect(l.x-1,l.y-3,2,6);else if(o.type==="rocket")i.shadowBlur=10,i.shadowColor="#8800ff",i.fillStyle="#aa44ff",i.fillRect(l.x-2.5,l.y-5,5,10),i.shadowBlur=0,i.fillStyle="#ffffff",i.fillRect(l.x-1,l.y-5,2,3),i.fillStyle="#cc88ff",i.fillRect(l.x-2,l.y+3,4,4);else if(o.type==="missile")i.shadowBlur=4,i.shadowColor="#44ff44",i.fillStyle="#44ff44",i.fillRect(l.x-1.5,l.y-4,3,8),i.shadowBlur=0,i.fillStyle="#88ffaa",i.fillRect(l.x-1,l.y+2,2,3);else if(o.type==="snake")i.shadowBlur=16,i.shadowColor="#00ffff",i.fillStyle="#00ffff",i.fillRect(l.x-4,l.y-7,8,14),i.shadowBlur=0,i.fillStyle="#ffffff",i.fillRect(l.x-2,l.y-5,4,10);else{const u=o.owner.type==="player",v=u?"#ff4444":"#ffff00",m=u?"#ff4444":"#ff8800";i.shadowBlur=6,i.shadowColor=m,i.fillStyle=v,i.fillRect(l.x-2,l.y-3,4,6),i.shadowBlur=0,i.fillStyle="#ffffff",i.fillRect(l.x-1,l.y-2,2,4)}i.restore()}}function G(i,e,t,s,o,n,l,a){i.save(),i.globalCompositeOperation="lighter";for(let r=0;r<gi.length;r++){const f=(r+1)*_s,d=e-s*f,c=t-o*f,u=1-(r+1)*.15;i.globalAlpha=gi[r],i.fillStyle=n;const v=l*u,m=a*u;i.fillRect(d-v/2,c-m/2,v,m)}i.restore()}function Ds(i,e){if(!e.isAlive&&!e.deathSequence)return;const{x:t,y:s}=e.position,o=e.width/2,n=e.height/2;i.save(),i.globalAlpha=.5,i.fillStyle="#1a2233",i.beginPath(),i.moveTo(t-o,s-n*.3),i.lineTo(t-o*.7,s-n),i.lineTo(t+o*.7,s-n),i.lineTo(t+o,s-n*.3),i.lineTo(t+o*.9,s+n),i.lineTo(t-o*.9,s+n),i.closePath(),i.fill(),i.strokeStyle="#2a3344",i.lineWidth=1,i.beginPath(),i.moveTo(t-o*.5,s-n*.5),i.lineTo(t-o*.5,s+n*.8),i.moveTo(t+o*.5,s-n*.5),i.lineTo(t+o*.5,s+n*.8),i.moveTo(t-o*.8,s),i.lineTo(t+o*.8,s),i.stroke(),i.restore()}function Ns(i,e){if(!e.isAlive&&!e.deathSequence)return;const{x:t,y:s}=e.position;for(const r of e.turrets){if(i.save(),r.isAlive){const f=r.fireType==="rocket"?{glow:"#ff3300",base:"#882200",barrel:"#aa3300",cap:"#ff5533"}:r.fireType==="homing"?{glow:"#00ff66",base:"#005522",barrel:"#00aa44",cap:"#33ff88"}:{glow:"#ff8800",base:"#885500",barrel:"#aa6600",cap:"#ffaa44"};i.shadowBlur=12,i.shadowColor=f.glow,i.fillStyle=f.base,i.fillRect(r.position.x-14,r.position.y-10,28,20),i.fillStyle=f.barrel,i.fillRect(r.position.x-4,r.position.y+8,8,14),i.fillStyle=f.cap,i.beginPath(),i.arc(r.position.x,r.position.y,10,0,Math.PI*2),i.fill(),i.shadowBlur=0;const d=r.health/r.maxHealth,c=20;i.fillStyle="#333333",i.fillRect(r.position.x-c/2,r.position.y-16,c,3),i.fillStyle=d>.5?"#44ff44":"#ff4444",i.fillRect(r.position.x-c/2,r.position.y-16,c*d,3)}else i.fillStyle="#332211",i.fillRect(r.position.x-12,r.position.y-8,24,16),i.fillStyle="#221100",i.beginPath(),i.arc(r.position.x,r.position.y,8,0,Math.PI*2),i.fill();i.restore()}const o=e.turrets.every(r=>!r.isAlive);i.save(),o&&e.health>0?(i.shadowBlur=15,i.shadowColor="#ff0000",i.fillStyle="#882222"):(i.shadowBlur=6,i.shadowColor="#4466aa",i.fillStyle="#334466");const n=e.width*.2,l=e.height*.25;i.fillRect(t-n/2,s+e.height*.15,n,l),i.shadowBlur=0;const a=o?"#ff4444":"#4488ff";if(i.fillStyle=a,i.fillRect(t-n*.3,s+e.height*.2,n*.6,l*.4),o&&e.health>0){const r=n,f=e.health/e.maxHealth;i.fillStyle="#333333",i.fillRect(t-r/2,s+e.height*.1,r,4),i.fillStyle=f>.3?"#ff4444":"#ff0000",i.fillRect(t-r/2,s+e.height*.1,r*f,4)}i.restore()}function Bs(i,e,t){for(const s of e){if(!s.isActive)continue;const{x:o,y:n}=s.position,a=8*(.8+.2*Math.sin(t*.005));i.save(),i.shadowBlur=10,i.shadowColor="#ff4466",i.fillStyle="#ff2244",i.beginPath(),i.moveTo(o,n+a*.4),i.bezierCurveTo(o-a,n-a*.3,o-a*.5,n-a,o,n-a*.4),i.bezierCurveTo(o+a*.5,n-a,o+a,n-a*.3,o,n+a*.4),i.fill(),i.restore()}}function wi(i,e,t,s){i.save(),i.font="16px monospace";const o=e.players.find(a=>a.id==="player1");if(o){const a=e.gameMode==="co-op"?"P1 ":"";i.fillStyle="#ffffff",i.textAlign="right",i.fillText(`${a}Score: ${o.score}`,p-10,24),i.fillText(`${a}Lives: ${o.lives}`,p-10,44)}const n=e.players.find(a=>a.id==="player2");n&&(i.fillStyle="#4488ff",i.textAlign="right",i.fillText(`P2 Score: ${n.score}`,p-10,68),i.fillText(`P2 Lives: ${n.lives}`,p-10,88)),i.font="14px monospace",i.fillStyle="#aaaaaa",i.textAlign="center",i.fillText(`Level ${e.currentLevel} - Wave ${e.currentWave}`,p/2,24),i.font="12px monospace",i.fillStyle="#88ff88",i.textAlign="left",i.fillText(`Engine: ${t} | Render: ${s}`,10,20);const l=e.gameMode==="co-op"&&n;o&&(l?(Me(i,o,"left"),Me(i,n,"right")):Me(i,o,"full")),i.restore()}function Me(i,e,t){const n=e.id==="player2",l=n?"#4488ff":"#ffffff";let a,r,f,d,c,u,v;const m=100,h=80;t==="left"?(a=10,r="left",f=150,d=200,c=290,u=370,v="right"):t==="right"?(a=p-10,r="right",f=p-250,d=p-200,c=p-370,u=p-290,v="left"):(a=10,r="left",f=p/2-m/2,d=p/2,c=p-h-10,u=p-10,v="right"),i.font="10px monospace",i.textAlign=r;const E=e.primaryWeapon==="laser"?"#4488ff":"#ff4444",M="".repeat(e.primaryLevel)+"".repeat(4-e.primaryLevel);if(i.fillStyle=E,i.fillText(`${e.primaryWeapon.toUpperCase()} ${M}`,a,780),e.secondaryWeapon){const F=Math.max(0,e.secondaryTimer/Qe),ae={rocket:"#aa44ff",missile:"#44ff44"}[e.secondaryWeapon]??"#ffffff";i.fillStyle="#333333",i.fillRect(f,780,m,6),i.fillStyle=ae,i.fillRect(f,780,m*F,6),i.font="10px monospace",i.fillStyle=l,i.textAlign="center",i.fillText(e.secondaryWeapon.toUpperCase(),d,776)}const A=Math.max(0,e.health/e.maxHealth);let k;A>.6?k="#44ff44":A>.3?k="#ffff44":k="#ff4444",i.fillStyle="#333333",i.fillRect(c,780,h,6),i.fillStyle=k,i.fillRect(c,780,h*A,6),i.font="10px monospace",i.fillStyle=n?"#4488ff":"#aaaaaa",i.textAlign=v,i.fillText("SHIELD",u,776)}const le={A:["#00ff44","#66ff88","#ffffff"],B:["#00ccff","#55ddff","#ffffff"],C:["#ff5500","#ff9933","#ffffff"],D:["#ff00ff","#ff66ff","#ffffff"],E:["#ffff00","#ffff66","#ffffff"],F:["#00ff88","#44ffaa","#ffffff"],player:["#ff3344","#ff7755","#ffffff"],asteroid:["#886644","#aa8855","#ccaa77"],bossTurret:["#ff8800","#ffaa44","#ffffff"],bossBridge:["#ff4400","#ff6622","#ffaa44","#ffffff"],default:["#ffcc00","#ff5500","#ffffff"]};class Hs{constructor(){this.particles=[],this.flashes=[],this.explodedEntities=new Set,this.impactedProjectiles=new Set,this.shakeOffsetX=0,this.shakeOffsetY=0,this.shakeTimer=0,this.shakeDuration=0,this.shakeIntensity=0}emit(e,t,s,o){if(this.explodedEntities.has(s))return;this.explodedEntities.add(s);const n=le[o]||le.default,l=o==="player",a=l?35:20,r=l?200:150,f=l?600:400;for(let d=0;d<a;d++){const c=Math.random()*Math.PI*2,u=30+Math.random()*r,v=n[Math.floor(Math.random()*n.length)];this.particles.push({x:e,y:t,vx:Math.cos(c)*u,vy:Math.sin(c)*u,color:v,life:f,maxLife:f,size:2+Math.random()*3})}l&&(this.shakeTimer=0,this.shakeDuration=150,this.shakeIntensity=4)}emitLargeExplosion(e,t,s,o){if(this.explodedEntities.has(s))return;this.explodedEntities.add(s);const n=o==="bossBridge",l=le[o]||le.default,a=n?150:50,r=n?450:250,f=n?1500:800;for(let d=0;d<a;d++){const c=Math.random()*Math.PI*2,u=40+Math.random()*r,v=l[Math.floor(Math.random()*l.length)];this.particles.push({x:e,y:t,vx:Math.cos(c)*u,vy:Math.sin(c)*u,color:v,life:f,maxLife:f,size:n?4+Math.random()*6:3+Math.random()*4})}this.shakeTimer=0,this.shakeDuration=n?600:200,this.shakeIntensity=n?15:5}emitImpactFlash(e,t,s,o="#ffffff"){this.impactedProjectiles.has(s)||(this.impactedProjectiles.add(s),this.flashes.push({x:e,y:t,radius:20,color:o,life:60,maxLife:60,isScreenFlash:!1}))}update(e){for(let t=this.particles.length-1;t>=0;t--){const s=this.particles[t],o=e/1e3;s.x+=s.vx*o,s.y+=s.vy*o,s.vy+=50*o,s.vx*=.99,s.vy*=.99,s.life-=e,s.life<=0&&this.particles.splice(t,1)}for(let t=this.flashes.length-1;t>=0;t--)this.flashes[t].life-=e,this.flashes[t].life<=0&&this.flashes.splice(t,1);if(this.shakeTimer<this.shakeDuration){this.shakeTimer+=e;const t=1-this.shakeTimer/this.shakeDuration;this.shakeOffsetX=(Math.random()-.5)*2*this.shakeIntensity*t,this.shakeOffsetY=(Math.random()-.5)*2*this.shakeIntensity*t}else this.shakeOffsetX=0,this.shakeOffsetY=0}draw(e){for(const t of this.flashes){const s=Math.max(0,t.life/t.maxLife);if(e.save(),t.isScreenFlash)e.globalCompositeOperation="lighter",e.globalAlpha=s*.12,e.fillStyle=t.color,e.fillRect(0,0,p,g);else{e.globalCompositeOperation="lighter";const o=e.createRadialGradient(t.x,t.y,0,t.x,t.y,t.radius);o.addColorStop(0,t.color),o.addColorStop(1,"transparent"),e.globalAlpha=s*.6,e.fillStyle=o,e.beginPath(),e.arc(t.x,t.y,t.radius,0,Math.PI*2),e.fill()}e.restore()}for(const t of this.particles){const s=Math.max(0,t.life/t.maxLife);e.save(),e.globalAlpha=s,e.fillStyle=t.color,s>.5&&(e.shadowBlur=6,e.shadowColor=t.color),e.fillRect(Math.floor(t.x-t.size/2),Math.floor(t.y-t.size/2),Math.ceil(t.size),Math.ceil(t.size)),e.restore()}}clearTracking(){this.explodedEntities.clear(),this.impactedProjectiles.clear(),this.particles=[],this.flashes=[],this.shakeTimer=0,this.shakeDuration=0,this.shakeOffsetX=0,this.shakeOffsetY=0}get activeCount(){return this.particles.length}get flashCount(){return this.flashes.length}}const Fs=""+new URL("earth-rcJ1oaF5.png",document.currentScript&&document.currentScript.tagName.toUpperCase()==="SCRIPT"&&document.currentScript.src||document.baseURI).href,Us=""+new URL("moon-ID8Sgcb2.png",document.currentScript&&document.currentScript.tagName.toUpperCase()==="SCRIPT"&&document.currentScript.src||document.baseURI).href,Ei=""+new URL("moon-small-Ct-oRMeY.png",document.currentScript&&document.currentScript.tagName.toUpperCase()==="SCRIPT"&&document.currentScript.src||document.baseURI).href,Ys=""+new URL("asteroids-brown-Clkmp3V-.png",document.currentScript&&document.currentScript.tagName.toUpperCase()==="SCRIPT"&&document.currentScript.src||document.baseURI).href,Ws=""+new URL("asteroids-blue-Cm4PGCFG.png",document.currentScript&&document.currentScript.tagName.toUpperCase()==="SCRIPT"&&document.currentScript.src||document.baseURI).href,$s=""+new URL("asteroids-purple-D8-1SGlL.png",document.currentScript&&document.currentScript.tagName.toUpperCase()==="SCRIPT"&&document.currentScript.src||document.baseURI).href,Xs=""+new URL("mars-De7HTeuz.png",document.currentScript&&document.currentScript.tagName.toUpperCase()==="SCRIPT"&&document.currentScript.src||document.baseURI).href,Ai={1:[],2:[{url:Fs,x:400,y:100,scale:1.8,alpha:.15,scrollSpeed:12}],3:[{url:Us,x:300,y:50,scale:1.4,alpha:.2,scrollSpeed:15},{url:Ei,x:600,y:400,scale:.6,alpha:.12,scrollSpeed:10}],4:[{url:Ys,x:200,y:0,scale:1,alpha:.18,scrollSpeed:18},{url:Ws,x:550,y:300,scale:.8,alpha:.14,scrollSpeed:14},{url:$s,x:650,y:600,scale:.7,alpha:.1,scrollSpeed:10}],5:[{url:Xs,x:350,y:80,scale:1.6,alpha:.18,scrollSpeed:8},{url:Ei,x:620,y:500,scale:.5,alpha:.12,scrollSpeed:12}]};class Gs{constructor(e){this.engineFps=0,this.renderFps=0,this.lastRenderTime=0,this.lastGameStatus="",this.lastBossTurretAlive=[],this.lastBossHealth=0,this.bgImageCache=new Map,this.bgScrollOffsets=[],this.currentBgLevel=-1;const t=document.getElementById(e);if(!t)throw new Error(`Container #${e} not found`);t.style.position="relative",this.canvas=document.createElement("canvas"),this.canvas.width=p,this.canvas.height=g,this.canvas.style.display="block",t.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this.particleSystem=new Hs,this.menuOverlay=new Rs(t)}setFpsCounters(e,t){this.engineFps=e,this.renderFps=t}render(e,t,s){const o=this.ctx,n=performance.now(),l=this.lastRenderTime>0?n-this.lastRenderTime:16.667;this.lastRenderTime=n,e.gameStatus==="playing"&&this.lastGameStatus!=="playing"&&this.particleSystem.clearTracking(),this.lastGameStatus=e.gameStatus,o.fillStyle="#000",o.fillRect(0,0,p,g),e.currentLevel!==this.currentBgLevel&&this.loadBackgrounds(e.currentLevel);const a=e.gameStatus==="paused"?0:l;if(this.drawBackgrounds(o,e.currentLevel,a),this.particleSystem.update(l),e.gameStatus==="menu"||e.gameStatus==="gameover"||e.gameStatus==="levelcomplete"||e.gameStatus==="levelintro"){e.background&&Ee(o,e.background.stars),this.particleSystem.draw(o),this.menuOverlay.update(e);return}if(e.gameStatus==="paused"){const c=new Map(t.players.map(m=>[m.id,m])),u=new Map(t.enemies.map(m=>[m.id,m])),v=new Map(t.projectiles.map(m=>[m.id,m]));e.background&&Ee(o,e.background.stars),vi(o,e.enemies,u,1),Si(o,e.projectiles,v,1),this.drawAsteroids(o,e.asteroids),this.drawWeaponPickups(o,e.weaponPickups,e.currentTime),mi(o,e.players,c,1,e.currentTime),this.particleSystem.draw(o),wi(o,e,this.engineFps,this.renderFps),this.menuOverlay.update(e);return}o.save(),o.translate(this.particleSystem.shakeOffsetX,this.particleSystem.shakeOffsetY);const r=new Map(t.players.map(c=>[c.id,c])),f=new Map(t.enemies.map(c=>[c.id,c])),d=new Map(t.projectiles.map(c=>[c.id,c]));this.detectDeaths(e),e.background&&Ee(o,e.background.stars),e.boss&&Ds(o,e.boss),vi(o,e.enemies,f,s),Si(o,e.projectiles,d,s),this.drawAsteroids(o,e.asteroids),this.drawWeaponPickups(o,e.weaponPickups,e.currentTime),Bs(o,e.lifePickups,e.currentTime),mi(o,e.players,r,s,e.currentTime),e.boss&&Ns(o,e.boss),this.particleSystem.draw(o),o.restore(),wi(o,e,this.engineFps,this.renderFps),this.menuOverlay.update(e)}detectDeaths(e){for(const t of e.enemies)!t.isAlive&&t.collisionState==="destroyed"&&this.particleSystem.emit(t.position.x,t.position.y,t.id,t.type);for(const t of e.players)t.isAlive||this.particleSystem.emit(t.position.x,t.position.y,t.id,"player");for(const t of e.asteroids)t.isAlive||this.particleSystem.emit(t.position.x,t.position.y,t.id,"asteroid");if(e.boss){for(let t=0;t<e.boss.turrets.length;t++){const s=e.boss.turrets[t];(this.lastBossTurretAlive[t]??!0)&&!s.isAlive&&this.particleSystem.emitLargeExplosion(s.position.x,s.position.y,s.id,"bossTurret")}if(this.lastBossTurretAlive=e.boss.turrets.map(t=>t.isAlive),this.lastBossHealth>0&&e.boss.health<=0&&e.boss.deathSequence&&this.particleSystem.emitLargeExplosion(e.boss.position.x,e.boss.position.y,"boss-bridge","bossBridge"),this.lastBossHealth=e.boss.health,e.boss.deathSequence){const t=e.boss.deathSequence.phase,s=e.boss.turrets.length;if(t<s){const o=e.boss.turrets[t];o&&this.particleSystem.emitLargeExplosion(o.position.x,o.position.y,`boss-death-phase-${t}`,"bossTurret")}else t===s&&this.particleSystem.emitLargeExplosion(e.boss.position.x,e.boss.position.y,"boss-death-final","bossBridge")}}for(const t of e.enemies)!t.isAlive&&t.collisionState==="destroyed"&&t.type==="F"&&this.particleSystem.emitLargeExplosion(t.position.x,t.position.y,`${t.id}-large`,"F");for(const t of e.projectiles)if(t.hasCollided&&!t.isActive){const s=t.owner.type==="player"?"#00ffff":"#ff8800";this.particleSystem.emitImpactFlash(t.position.x,t.position.y,t.id,s)}}loadBackgrounds(e){this.currentBgLevel=e;const t=Ai[e]??[];this.bgScrollOffsets=t.map(()=>0);for(const s of t)if(!this.bgImageCache.has(s.url)){const o=new Image;o.src=s.url,this.bgImageCache.set(s.url,o)}}drawBackgrounds(e,t,s){const o=Ai[t]??[];if(o.length!==0)for(let n=0;n<o.length;n++){const l=o[n],a=this.bgImageCache.get(l.url);if(!a||!a.complete)continue;this.bgScrollOffsets[n]+=l.scrollSpeed*s/1e3;const r=a.height*l.scale,f=a.width*l.scale,d=-(r/2)-l.y+this.bgScrollOffsets[n],c=l.x;d-r/2>g||d+r/2<0||(e.save(),e.globalAlpha=l.alpha,e.drawImage(a,c-f/2,d-r/2,f,r),e.restore())}}drawWeaponPickups(e,t,s){for(const o of t){if(!o.isActive)continue;const l={laser:"#4488ff",bullet:"#ff4444",rocket:"#aa44ff",missile:"#44ff44"}[o.currentWeapon]??"#ffffff",r=10*(.7+.3*Math.sin(s*.005));e.save(),e.shadowBlur=12,e.shadowColor=l,e.globalAlpha=.9,e.fillStyle=l,e.beginPath(),e.arc(o.position.x,o.position.y,r,0,Math.PI*2),e.fill(),e.shadowBlur=0,e.fillStyle="#ffffff",e.globalAlpha=.8,e.beginPath(),e.arc(o.position.x,o.position.y,r*.4,0,Math.PI*2),e.fill(),e.restore()}}drawAsteroids(e,t){for(const s of t){if(!s.isAlive)continue;const o=s.collisionRadius,n=s.size==="large"?8:6,l=s.size==="large"?"#887766":"#998877";e.save(),e.translate(s.position.x,s.position.y),e.rotate(s.rotation),e.shadowBlur=4,e.shadowColor="#665544",e.fillStyle=l,e.beginPath();for(let a=0;a<n;a++){const r=a/n*Math.PI*2,f=.8+.2*Math.sin(a*2.5),d=Math.cos(r)*o*f,c=Math.sin(r)*o*f;a===0?e.moveTo(d,c):e.lineTo(d,c)}e.closePath(),e.fill(),e.shadowBlur=0,e.fillStyle="#554433",e.beginPath(),e.arc(o*.2,-o*.2,o*.15,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(-o*.3,o*.1,o*.1,0,Math.PI*2),e.fill(),e.restore()}}destroy(){this.menuOverlay.destroy(),this.canvas.remove()}}function Mi(){const i=new Gs("game-container"),e=new Ts({renderer:i}),t=i.render.bind(i);i.render=(s,o,n)=>{i.setFpsCounters(e.gameLoop.engineFps,e.gameLoop.renderFps),t(s,o,n)},e.start(),window.__game=e}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Mi):Mi()})();
//# sourceMappingURL=index-B1A9jCbf.js.map
