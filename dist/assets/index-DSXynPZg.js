(function(){"use strict";const Li="0.7.5",V=1e3/60,we=250,p=800,v=800,Ci=3,Ee=100,bi=300,Ae=2e3,D=14,Ii=200,N=500,Me=50,Te=3e3,Pe=4,Re=50,ki=100,Oi=14,Le=100,_i=200,Di=16,Ce=50,Ni=150,Bi=12,be=75,Hi=250,Fi=14,Ie=150,Ui=300,Wi=18,ke=125,Yi=350,Xi=16,Oe=200,Gi=2.5,$i=40,Ki=5e3,Vi=4,Q=60,re=48,fe=40,zi=1.5,qi=20,Z=260,xi=50,_e=3e3,De=3,Ne=550,ji=25,Be=180,Qi=75,Zi=3e3,Ji=9,J=200,He=420,Fe=400,Ue=40,We=3e3,Ye=5,et=500,ce=150,it=350,tt=350,ot=10,st=4e3,nt=3,lt=3,at=800,rt=200,Xe=400,ft=75,ct=3e3,ht=8,dt=2,Ge=100,$e=300,ut=12,pt=24,mt=50,yt=150,he=3e3,vt=1e3,Ke=40,gt=80,St=50,wt=.15,Ve=5e3,Et=60,At=1e4,Mt=12,ze=15e3,ee=720,O=200,qe=1e3,xe=400,Tt=600,de=20,Pt=5e3,Rt=500,Lt=800,ie=300,je=1200,Ct=30,bt=1333,It=.5,kt=50,Ot=12e3,_t=10,Dt=3e3,Nt=500,Bt=2e3,Ht=100,Ft=30;class Ut{constructor(e,t){this.animationFrameId=0,this.lastTimestamp=0,this.accumulator=0,this.running=!1,this.tickCount=0,this.frameCount=0,this.fpsTimer=0,this.engineFps=0,this.renderFps=0,this.updateFn=e,this.renderFn=t}start(){this.running||(this.running=!0,this.lastTimestamp=0,this.accumulator=0,this.tickCount=0,this.frameCount=0,this.fpsTimer=0,this.animationFrameId=requestAnimationFrame(e=>this.tick(e)))}stop(){this.running=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=0)}isRunning(){return this.running}tick(e){if(!this.running)return;if(this.lastTimestamp===0){this.lastTimestamp=e,this.fpsTimer=e,this.animationFrameId=requestAnimationFrame(o=>this.tick(o));return}let t=e-this.lastTimestamp;for(this.lastTimestamp=e,t>we&&(t=we),this.accumulator+=t;this.accumulator>=V;)this.updateFn(V),this.accumulator-=V,this.tickCount++;const s=this.accumulator/V;this.renderFn(s),this.frameCount++,this.fpsTimer=this.fpsTimer||e,e-this.fpsTimer>=1e3&&(this.engineFps=this.tickCount,this.renderFps=this.frameCount,this.tickCount=0,this.frameCount=0,this.fpsTimer=e),this.animationFrameId=requestAnimationFrame(o=>this.tick(o))}tickHeadless(e){for(let t=0;t<e;t++)this.updateFn(V),this.tickCount++}}class Wt{constructor(){this.bufferA=te(),this.bufferB=te(),this.currentState=this.bufferA,this.previousState=this.bufferB}swapBuffers(){const e=this.previousState;this.previousState=this.currentState,this.currentState=e,Xt(this.currentState,this.previousState)}reset(){this.bufferA=te(),this.bufferB=te(),this.currentState=this.bufferA,this.previousState=this.bufferB}}function te(){return{currentTime:0,deltaTime:0,gameMode:"single",gameStatus:"menu",currentLevel:1,currentWave:1,waveStatus:"transition",players:[],enemies:[],projectiles:[],powerups:[],weaponPickups:[],asteroids:[],background:{stars:[],scrollSpeed:0},formation:Yt(),menu:{type:"start",selectedOption:0,options:["1 Player","2 Players","Test Mode"]},boss:null,lifePickups:[]}}function Yt(){return{rows:0,cols:0,direction:1,speed:Q,baseSpeed:Q,offsetX:0,offsetY:0,cellWidth:re,cellHeight:fe,standoffY:0}}function Xt(i,e){i.currentTime=e.currentTime,i.deltaTime=e.deltaTime,i.gameMode=e.gameMode,i.gameStatus=e.gameStatus,i.currentLevel=e.currentLevel,i.currentWave=e.currentWave,i.waveStatus=e.waveStatus,i.players=e.players,i.enemies=e.enemies,i.projectiles=e.projectiles,i.powerups=e.powerups,i.weaponPickups=e.weaponPickups,i.asteroids=e.asteroids,i.background=e.background,i.formation=e.formation,i.menu=e.menu,i.boss=e.boss,i.lifePickups=e.lifePickups}function ue(i){return{id:i,shipColor:i==="player1"?"red":"blue",position:{x:p/2,y:v-60},velocity:{x:0,y:0},rotation:0,isAlive:!0,isInvulnerable:!0,invulnerabilityTimer:2e3,lives:Ci,score:0,health:Ee,maxHealth:Ee,primaryWeapon:"laser",primaryLevel:1,secondaryWeapon:null,secondaryTimer:0,secondaryCooldown:0,fireCooldown:0,isThrusting:!1,isFiring:!1,collisionState:"none",input:{left:!1,right:!1,up:!1,down:!1,fire:!1},deathSequence:null}}const Qe=new Set(["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Space","Enter","Escape","KeyW","KeyA","KeyS","KeyD","KeyQ","KeyM"]);class Gt{constructor(e=!1){this.keyState={},this.handleKeyDown=t=>{Qe.has(t.code)&&t.preventDefault(),this.keyState[t.code]=!0},this.handleKeyUp=t=>{Qe.has(t.code)&&t.preventDefault(),this.keyState[t.code]=!1},this.headless=e,!e&&typeof window<"u"&&(window.addEventListener("keydown",this.handleKeyDown),window.addEventListener("keyup",this.handleKeyUp))}getPlayerInput(){return{left:!!this.keyState.ArrowLeft,right:!!this.keyState.ArrowRight,up:!!this.keyState.ArrowUp,down:!!this.keyState.ArrowDown,fire:!!this.keyState.Space}}getPlayer2Input(){return{left:!!this.keyState.KeyA,right:!!this.keyState.KeyD,up:!!this.keyState.KeyW,down:!!this.keyState.KeyS,fire:!!this.keyState.KeyQ}}getMenuInput(){const e={up:!!this.keyState.ArrowUp,down:!!this.keyState.ArrowDown,confirm:!!this.keyState.Enter||!!this.keyState.Space,back:!!this.keyState.Escape};return e.up&&(this.keyState.ArrowUp=!1),e.down&&(this.keyState.ArrowDown=!1),e.confirm&&(this.keyState.Enter=!1,this.keyState.Space=!1),e.back&&(this.keyState.Escape=!1),e}getPauseToggle(){const e=!!this.keyState.Escape;return e&&(this.keyState.Escape=!1),e}getMuteToggle(){const e=!!this.keyState.KeyM;return e&&(this.keyState.KeyM=!1),e}injectPlayerInput(e){e.left!==void 0&&(this.keyState.ArrowLeft=e.left),e.right!==void 0&&(this.keyState.ArrowRight=e.right),e.up!==void 0&&(this.keyState.ArrowUp=e.up),e.down!==void 0&&(this.keyState.ArrowDown=e.down),e.fire!==void 0&&(this.keyState.Space=e.fire)}injectMenuInput(e){e.up&&(this.keyState.ArrowUp=!0),e.down&&(this.keyState.ArrowDown=!0),e.confirm&&(this.keyState.Enter=!0),e.back&&(this.keyState.Escape=!0)}clearAll(){this.keyState={}}destroy(){!this.headless&&typeof window<"u"&&(window.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("keyup",this.handleKeyUp))}}const oe=D+2;function $t(i,e){i.isAlive&&(Kt(i,e),Vt(i,e),zt(i,e),qt(i))}function Kt(i,e){const t=i.input,s=bi*e;if(i.velocity.x=0,i.velocity.y=0,t.left&&(i.velocity.x=-s),t.right&&(i.velocity.x=s),t.up&&(i.velocity.y=-s),t.down&&(i.velocity.y=s),i.velocity.x!==0&&i.velocity.y!==0){const o=1/Math.SQRT2;i.velocity.x*=o,i.velocity.y*=o}i.position.x+=i.velocity.x,i.position.y+=i.velocity.y,i.position.x=Math.max(oe,Math.min(p-oe,i.position.x)),i.position.y=Math.max(oe,Math.min(v-oe,i.position.y)),i.isThrusting=i.velocity.x!==0||i.velocity.y!==0}function Vt(i,e){i.isInvulnerable&&(i.invulnerabilityTimer-=e*1e3,i.invulnerabilityTimer<=0&&(i.isInvulnerable=!1,i.invulnerabilityTimer=0))}function zt(i,e){i.fireCooldown>0&&(i.fireCooldown-=e*1e3,i.fireCooldown<0&&(i.fireCooldown=0))}function qt(i){i.isFiring=i.input.fire&&i.fireCooldown<=0,i.isFiring&&(i.fireCooldown=Ii)}function xt(i){i.lives<=0||(i.isAlive=!0,i.health=i.maxHealth,i.position={x:p/2,y:v-60},i.velocity={x:0,y:0},i.isInvulnerable=!0,i.invulnerabilityTimer=Ae,i.collisionState="none",i.deathSequence=null)}function se(i,e,t=0){return i.isInvulnerable||!i.isAlive?!1:(i.health-=e,i.health<=0?(i.health=0,i.isAlive=!1,i.lives--,i.collisionState="destroyed",i.deathSequence={active:!0,startTime:t,duration:Bt,position:{x:i.position.x,y:i.position.y}},!0):(i.collisionState="colliding",i.isInvulnerable=!0,i.invulnerabilityTimer=Ae,!1))}let Ze=0;function pe(i,e){return{id:`bullet-${Ze++}`,type:"bullet",owner:e,position:{x:i.x,y:i.y},velocity:{x:0,y:Z},rotation:Math.PI,speed:Z,damage:xi,isActive:!0,lifetime:0,maxLifetime:_e,collisionRadius:De,hasCollided:!1}}function z(i,e){return{id:`bullet-${Ze++}`,type:"bullet",owner:e,position:{x:i.x,y:i.y},velocity:{x:0,y:-Ne},rotation:0,speed:Ne,damage:ji,isActive:!0,lifetime:0,maxLifetime:_e,collisionRadius:De,hasCollided:!1}}let jt=0;function Je(i,e,t){const s=t==="left"?-20:20;return{id:`rocket-${jt++}`,type:"rocket",owner:e,position:{x:i.x+s,y:i.y},velocity:{x:0,y:-J},rotation:0,speed:J,damage:Ue,isActive:!0,lifetime:0,maxLifetime:We,collisionRadius:Ye,hasCollided:!1,acceleration:Fe,maxSpeed:He}}let Qt=0;function Zt(i,e,t){const s=Math.sin(t)*ce,o=-Math.cos(t)*ce;return{id:`missile-${Qt++}`,type:"missile",owner:e,position:{x:i.x,y:i.y},velocity:{x:s,y:o},rotation:t,speed:ce,damage:ot,isActive:!0,lifetime:0,maxLifetime:st,collisionRadius:nt,hasCollided:!1,acceleration:tt,maxSpeed:it,turnRate:lt,isHoming:!0,homingDelay:rt}}let Jt=0;function eo(i,e){return{id:`snake-${Jt++}`,type:"snake",owner:e,position:{x:i.x,y:i.y},velocity:{x:0,y:-Xe},rotation:0,speed:Xe,damage:ft,isActive:!0,lifetime:0,maxLifetime:ct,collisionRadius:ht,hasCollided:!1,turnRate:dt,isHoming:!0}}let ei=0;function U(i,e){return{id:`laser-${ei++}`,type:"laser",owner:e,position:{x:i.x,y:i.y},velocity:{x:0,y:-N},rotation:0,speed:N,damage:Me,isActive:!0,lifetime:0,maxLifetime:Te,collisionRadius:Pe,hasCollided:!1}}function io(i,e){return{id:`laser-${ei++}`,type:"laser",owner:e,position:{x:i.x,y:i.y},velocity:{x:0,y:N},rotation:Math.PI,speed:N,damage:Me,isActive:!0,lifetime:0,maxLifetime:Te,collisionRadius:Pe,hasCollided:!1}}function to(i,e,t){if(!i.isActive)return;const s=e*1e3;if(i.acceleration&&i.maxSpeed&&i.speed<i.maxSpeed){i.speed=Math.min(i.speed+i.acceleration*e,i.maxSpeed);const o=Math.atan2(i.velocity.y,i.velocity.x);i.velocity.x=Math.cos(o)*i.speed,i.velocity.y=Math.sin(o)*i.speed}if(i.homingDelay!==void 0&&i.homingDelay>0&&(i.homingDelay-=s),i.isHoming&&i.turnRate&&t&&(i.homingDelay===void 0||i.homingDelay<=0)){let o;if(i.owner.type==="enemy"?o=t.players.filter(n=>n.isAlive):(o=[...t.enemies.filter(n=>n.isAlive)],t.boss?.isAlive&&o.push(...t.boss.turrets.filter(n=>n.isAlive))),o.length>0){let n=o[0],l=1/0;for(const d of o){const E=d.position.x-i.position.x,A=d.position.y-i.position.y,T=E*E+A*A;T<l&&(l=T,n=d)}const a=n.position.x-i.position.x,r=n.position.y-i.position.y,f=Math.atan2(r,a),h=Math.atan2(i.velocity.y,i.velocity.x);let c=f-h;for(;c>Math.PI;)c-=2*Math.PI;for(;c<-Math.PI;)c+=2*Math.PI;const u=i.turnRate*e,g=Math.max(-u,Math.min(u,c)),y=h+g;i.velocity.x=Math.cos(y)*i.speed,i.velocity.y=Math.sin(y)*i.speed}}i.position.x+=i.velocity.x*e,i.position.y+=i.velocity.y*e,i.lifetime+=s,(i.position.y<-20||i.position.y>v+20||i.position.x<-20||i.position.x>p+20||i.lifetime>=i.maxLifetime||i.hasCollided)&&(i.isActive=!1)}function oo(i,e){for(const t of i.projectiles)to(t,e,i);i.projectiles=i.projectiles.filter(t=>t.isActive)}function so(i){for(const e of i.players){if(!e.isFiring||!e.isAlive)continue;const t={type:"player",id:e.id},s={x:e.position.x,y:e.position.y-16},o=[];if(e.primaryWeapon==="laser")switch(e.primaryLevel){case 1:o.push(U(s,t));break;case 2:o.push(U({x:s.x-8,y:s.y},t)),o.push(U({x:s.x+8,y:s.y},t));break;case 3:{o.push(U(s,t));const n=5*Math.PI/180,l=U({x:s.x-8,y:s.y},t);l.velocity.x=-Math.sin(n)*N,l.velocity.y=-Math.cos(n)*N;const a=U({x:s.x+8,y:s.y},t);a.velocity.x=Math.sin(n)*N,a.velocity.y=-Math.cos(n)*N,o.push(l,a);break}case 4:o.push(eo(s,t));break}else switch(e.primaryLevel){case 1:o.push(z(s,t));break;case 2:o.push(z({x:s.x-8,y:s.y},t)),o.push(z({x:s.x+8,y:s.y},t));break;case 3:{const n=[0,-10,10];for(const l of n){const a=l*Math.PI/180,r=z(s,t);l!==0&&(r.velocity.x=Math.sin(a)*r.speed,r.velocity.y=-Math.cos(a)*r.speed),o.push(r)}break}case 4:{const n=[0,-8,8,-16,16];for(const l of n){const a=l*Math.PI/180,r=z(s,t);l!==0&&(r.velocity.x=Math.sin(a)*r.speed,r.velocity.y=-Math.cos(a)*r.speed),o.push(r)}break}}if(e.secondaryWeapon&&e.secondaryCooldown<=0){if(e.secondaryWeapon==="rocket")o.push(Je(s,t,"left")),o.push(Je(s,t,"right")),e.secondaryCooldown=et;else if(e.secondaryWeapon==="missile"){const n=[-15,0,15];for(const l of n)o.push(Zt(s,t,l*Math.PI/180));e.secondaryCooldown=at}}o.length>0&&(i.projectiles=[...i.projectiles,...o])}}const no=50;function ii(i,e){const t=e*re,s=(p-t)/2;return{rows:i,cols:e,direction:1,speed:Q,baseSpeed:Q,offsetX:s,offsetY:-i*fe,cellWidth:re,cellHeight:fe,standoffY:v-no-D}}function lo(i,e){const t=i.formation,s=i.enemies.filter(u=>u.isAlive);if(s.length===0)return;if(i.enemies.some(u=>u.isAlive&&u.flightPathState)){me(i);return}const n=t.rows*t.cols,l=s.length;if(n>0&&l>0){const u=1-l/n;t.speed=t.baseSpeed*(1+u*zi)}if(t.offsetY<20){t.offsetY+=t.speed*e*2,me(i);return}const a=t.direction*t.speed*e;t.offsetX+=a;const{minCol:r,maxCol:f}=ao(s),h=t.offsetX+r*t.cellWidth;if(t.offsetX+(f+1)*t.cellWidth>p||h<0){t.direction*=-1,t.offsetX-=a;const u=ro(s);t.offsetY+(u+1)*t.cellHeight<t.standoffY&&(t.offsetY+=qi)}me(i)}function me(i){const e=i.formation;for(const t of i.enemies)t.isAlive&&(t.diveState||t.flightPathState||(t.position.x=e.offsetX+(t.formationCol+.5)*e.cellWidth,t.position.y=e.offsetY+(t.formationRow+.5)*e.cellHeight))}function ao(i){let e=1/0,t=-1/0;for(const s of i)s.formationCol<e&&(e=s.formationCol),s.formationCol>t&&(t=s.formationCol);return{minCol:e,maxCol:t}}function ro(i){let e=0;for(const t of i)t.formationRow>e&&(e=t.formationRow);return e}function q(){const i=[];for(let e=0;e<Ht;e++)i.push(fo());return{stars:i,scrollSpeed:Ft}}function fo(){const i=Math.random()*.8+.2;return{position:{x:Math.random()*p,y:Math.random()*v},depth:i,size:i*2+.5,brightness:i*.6+.4}}function ti(i,e){for(const t of i.stars)t.position.y+=i.scrollSpeed*t.depth*e,t.position.y>v&&(t.position.y-=v,t.position.x=Math.random()*p)}let co=0;function ye(i,e){return{id:`enemyA-${co++}`,type:"A",position:{x:0,y:0},velocity:{x:0,y:0},rotation:Math.PI,isAlive:!0,health:Re,maxHealth:Re,fireMode:"none",fireCooldown:0,fireRate:0,isThrusting:!1,isFiring:!1,collisionState:"none",scoreValue:ki,collisionRadius:Oi,formationRow:i,formationCol:e,diveState:null,flightPathState:null}}function oi(i,e){return i.isAlive?(i.health-=e,i.health<=0?(i.health=0,i.isAlive=!1,i.collisionState="destroyed",!0):(i.collisionState="colliding",!1)):!1}function ho(i,e){if(e.category==="primary"){const t=e.currentWeapon;t===i.primaryWeapon?i.primaryLevel<4&&(i.primaryLevel=i.primaryLevel+1):(i.primaryWeapon=t,i.primaryLevel=1)}else{const t=e.currentWeapon;i.secondaryWeapon=t,i.secondaryTimer=ze,i.secondaryCooldown=0}}function uo(i,e){i.secondaryWeapon!==null&&(i.secondaryTimer-=e,i.secondaryTimer<=0&&(i.secondaryWeapon=null,i.secondaryTimer=0,i.secondaryCooldown=0))}function _(i,e){const t=i.x-e.x,s=i.y-e.y;return Math.sqrt(t*t+s*s)}function po(i){mo(i),yo(i),vo(i),go(i),So(i),wo(i),Eo(i),i.boss&&(Ao(i),Mo(i),To(i))}function mo(i){for(const e of i.players)if(!(!e.isAlive||e.isInvulnerable))for(const t of i.enemies){if(!t.isAlive)continue;_(e.position,t.position)<D+t.collisionRadius&&(se(e,e.maxHealth,i.currentTime),oi(t,t.maxHealth))}}function yo(i){for(const e of i.projectiles)if(!(!e.isActive||e.hasCollided)&&e.owner.type==="player")for(const t of i.enemies){if(!t.isAlive)continue;if(_(e.position,t.position)<e.collisionRadius+t.collisionRadius){if(e.hasCollided=!0,e.isActive=!1,oi(t,e.damage)){const n=i.players.find(l=>l.id===e.owner.id);n&&(n.score+=t.scoreValue)}break}}}function vo(i){for(const e of i.projectiles)if(!(!e.isActive||e.hasCollided)&&e.owner.type==="enemy")for(const t of i.players){if(!t.isAlive||t.isInvulnerable)continue;if(_(e.position,t.position)<e.collisionRadius+D){e.hasCollided=!0,e.isActive=!1,se(t,e.damage,i.currentTime);break}}}function go(i){for(const e of i.weaponPickups)if(e.isActive)for(const t of i.players){if(!t.isAlive)continue;if(_(t.position,e.position)<D+Mt){e.isActive=!1,ho(t,e);break}}}function So(i){for(const e of i.players)if(!(!e.isAlive||e.isInvulnerable))for(const t of i.asteroids){if(!t.isAlive)continue;if(_(e.position,t.position)<D+t.collisionRadius){se(e,St,i.currentTime),t.isAlive=!1;break}}}function wo(i){for(const e of i.projectiles)if(!(!e.isActive||e.hasCollided)&&e.owner.type==="player")for(const t of i.asteroids){if(!t.isAlive)continue;if(_(e.position,t.position)<e.collisionRadius+t.collisionRadius){if(e.hasCollided=!0,e.isActive=!1,t.health-=e.damage,t.health<=0){t.isAlive=!1;const o=i.players.find(n=>n.id===e.owner.id);o&&(o.score+=t.scoreValue)}break}}}function Eo(i){for(const e of i.lifePickups)if(e.isActive)for(const t of i.players){if(!t.isAlive)continue;if(_(t.position,e.position)<D+_t){e.isActive=!1,t.lives++;break}}}function Ao(i){const e=i.boss;if(!(!e||!e.isAlive||e.layer==="entering")){for(const t of i.projectiles)if(!(!t.isActive||t.hasCollided)&&t.owner.type==="player")for(const s of e.turrets){if(!s.isAlive)continue;if(_(t.position,s.position)<t.collisionRadius+s.collisionRadius){if(t.hasCollided=!0,t.isActive=!1,s.health-=t.damage,s.health<=0){s.health=0,s.isAlive=!1;const n=i.players.find(l=>l.id===t.owner.id);n&&(n.score+=Rt)}break}}}}function Mo(i){const e=i.boss;if(!e||!e.isAlive||e.layer!=="active"||!e.turrets.every(a=>!a.isAlive))return;const s=e.width*.09,o=e.height*.2,n=e.position.x,l=e.position.y;for(const a of i.projectiles)!a.isActive||a.hasCollided||a.owner.type==="player"&&a.position.x>=n-s&&a.position.x<=n+s&&a.position.y>=l-o&&a.position.y<=l+o&&(a.hasCollided=!0,a.isActive=!1,e.health-=a.damage,e.health<=0&&(e.health=0))}function To(i){const e=i.boss;if(!(!e||!e.isAlive||e.layer==="entering")){for(const t of i.players)if(!(!t.isAlive||t.isInvulnerable))for(const s of e.upperCollisionZones){const o=e.position.x+s.offsetX,n=e.position.y+s.offsetY,l=s.width/2,a=s.height/2,r=Math.max(o-l,Math.min(t.position.x,o+l)),f=Math.max(n-a,Math.min(t.position.y,n+a));if(_(t.position,{x:r,y:f})<D){se(t,t.maxHealth,i.currentTime);break}}}}let Po=0;function Ro(i,e){return{id:`enemyB-${Po++}`,type:"B",position:{x:0,y:0},velocity:{x:0,y:0},rotation:Math.PI,isAlive:!0,health:Le,maxHealth:Le,fireMode:"laser",fireCooldown:0,fireRate:3e3,isThrusting:!1,isFiring:!1,collisionState:"none",scoreValue:_i,collisionRadius:Di,formationRow:i,formationCol:e,diveState:null,flightPathState:null}}let Lo=0;function si(i,e){return{id:`enemyC-${Lo++}`,type:"C",position:{x:0,y:0},velocity:{x:0,y:0},rotation:Math.PI,isAlive:!0,health:Ce,maxHealth:Ce,fireMode:"bullet",fireCooldown:0,fireRate:2e3,isThrusting:!1,isFiring:!1,collisionState:"none",scoreValue:Ni,collisionRadius:Bi,formationRow:i,formationCol:e,diveState:null,flightPathState:null}}let Co=0;function bo(i,e){return{id:`enemyD-${Co++}`,type:"D",position:{x:0,y:0},velocity:{x:0,y:0},rotation:Math.PI,isAlive:!0,health:be,maxHealth:be,fireMode:"plasma",fireCooldown:0,fireRate:2500,isThrusting:!1,isFiring:!1,collisionState:"none",scoreValue:Hi,collisionRadius:Fi,formationRow:i,formationCol:e,diveState:null,flightPathState:null}}let Io=0;function ko(i,e){return{id:`enemyE-${Io++}`,type:"E",position:{x:0,y:0},velocity:{x:0,y:0},rotation:Math.PI,isAlive:!0,health:Ie,maxHealth:Ie,fireMode:"spread",fireCooldown:0,fireRate:4e3,isThrusting:!1,isFiring:!1,collisionState:"none",scoreValue:Ui,collisionRadius:Wi,formationRow:i,formationCol:e,diveState:null,flightPathState:null}}let Oo=0;function _o(i,e){return{id:`enemyF-${Oo++}`,type:"F",position:{x:0,y:0},velocity:{x:0,y:0},rotation:Math.PI,isAlive:!0,health:ke,maxHealth:ke,fireMode:"homing",fireCooldown:0,fireRate:3500,isThrusting:!1,isFiring:!1,collisionState:"none",scoreValue:Yi,collisionRadius:Xi,formationRow:i,formationCol:e,diveState:null,flightPathState:null}}const Do=250,No={A:1,B:.8,C:1.3,D:1.1,E:.6,F:.7};function Bo(i,e){if(i.length===2)return{x:i[0].x+(i[1].x-i[0].x)*e,y:i[0].y+(i[1].y-i[0].y)*e};if(i.length===3){const a=1-e;return{x:a*a*i[0].x+2*a*e*i[1].x+e*e*i[2].x,y:a*a*i[0].y+2*a*e*i[1].y+e*e*i[2].y}}const t=1-e,s=t*t,o=s*t,n=e*e,l=n*e;return{x:o*i[0].x+3*s*e*i[1].x+3*t*n*i[2].x+l*i[3].x,y:o*i[0].y+3*s*e*i[1].y+3*t*n*i[2].y+l*i[3].y}}function B(i,e){return{x:e.offsetX+(i.formationCol+.5)*e.cellWidth,y:e.offsetY+(i.formationRow+.5)*e.cellHeight}}function Ho(i,e,t){if(i==="grid")return;const o={"w-curve":Uo,chiral:Wo,diagonal:Yo,"side-wave":Xo,"m-shape":Go,"inverted-v":$o,"x-formation":Ko}[i];o&&o(e,t)}function Fo(i,e){for(const t of i.enemies){if(!t.isAlive||!t.flightPathState)continue;const s=t.flightPathState,o=s.speed,n=s.controlPoints[0],l=s.controlPoints[s.controlPoints.length-1],a=l.x-n.x,r=l.y-n.y,f=Math.sqrt(a*a+r*r)*1.5,h=f>0?o*e/f:1;s.progress=Math.min(1,s.progress+h);const c=Bo(s.controlPoints,s.progress);if(t.position.x=c.x,t.position.y=c.y,s.progress>=1){const u=i.formation;t.position.x=u.offsetX+(t.formationCol+.5)*u.cellWidth,t.position.y=u.offsetY+(t.formationRow+.5)*u.cellHeight,t.flightPathState=null}}}function H(i,e,t){const s=B(i,t),o=[...e];o[o.length-1]=s,i.flightPathState={progress:0,controlPoints:o,targetSlot:s,speed:Do*(No[i.type]??1)},i.position.x=o[0].x,i.position.y=o[0].y}function Uo(i,e){const t=p/2,s=i.length;for(let o=0;o<s;o++){const n=i[o],l=B(n,e),a=Math.floor(o/s*5),f=a%2===0?-150:150,c=[{x:t+(o-s/2)*10,y:-20},{x:t+f,y:200+a*30},{x:l.x+f*.2,y:l.y-40},l];H(n,c,e)}}function Wo(i,e){const t=p/2,s=v*.4,o=i.length;for(let n=0;n<o;n++){const l=i[n],a=B(l,e),r=n%4;let f,h;r===0?(f=20,h=20):r===1?(f=p-20,h=20):r===2?(f=p-20,h=v*.5):(f=20,h=v*.5);const c=r*Math.PI/2+Math.PI*.6,u=120,g=t+Math.cos(c)*u,y=s+Math.sin(c)*u*.5,d=[{x:f,y:h},{x:g,y},{x:a.x+(f>t?30:-30),y:a.y-30},a];H(l,d,e)}}function Yo(i,e){const t=i.length;for(let s=0;s<t;s++){const o=i[s],n=B(o,e),l=p+20,a=30+s*15,r=[{x:l,y:a},{x:p*.65,y:v*.25+s*5},{x:n.x+50,y:n.y-30},n];H(o,r,e)}}function Xo(i,e){const t=i.length,s=p/2;for(let o=0;o<t;o++){const n=i[o],l=B(n,e),a=o%2===0,r=a?-20:p+20,f=60+o%8*40,h=100,c=a?s+h:s-h,u=[{x:r,y:f},{x:c,y:v*.3+o%5*20},{x:l.x+(a?-40:40),y:l.y-30},l];H(n,u,e)}}function Go(i,e){const t=p/2,s=i.length;for(let o=0;o<s;o++){const n=i[o],l=B(n,e),a=s>1?o/(s-1):.5,r=Math.abs(Math.sin(a*Math.PI*2))*120,f=t+(a-.5)*p*.7,h=[{x:f,y:-15},{x:f,y:80+r},{x:l.x,y:l.y-30},l];H(n,h,e)}}function $o(i,e){const t=p/2,s=i.length;for(let o=0;o<s;o++){const n=i[o],l=B(n,e),a=Math.floor(s/2),r=o<a,f=r?o:o-a,h=r?-15:p+15,c=40+f*20,u=v*.25,g=t+(r?-20:20),y=[{x:h,y:c},{x:g,y:u},{x:l.x+(r?-30:30),y:l.y-40},l];H(n,y,e)}}function Ko(i,e){const t=i.length;for(let s=0;s<t;s++){const o=i[s],n=B(o,e),l=s%2===0,a=Math.floor(s/2)*15,r=l?-20:p+20,f=-20+a,h=l?p*.65:p*.35,c=v*.3+a*.5,u=[{x:r,y:f},{x:h,y:c},{x:n.x+(l?30:-30),y:n.y-40},n];H(o,u,e)}}function Vo(){const i=p/2,e=ee*.42,t=ee*.2,s=[-e,-t,t,e],o=[];for(let l=0;l<4;l++){const a=s[l];o.push({id:`boss-turret-${l}`,position:{x:i+a,y:-O/2},offsetX:a,offsetY:O*.3,health:xe,maxHealth:xe,isAlive:!0,fireCooldown:1e3+l*500,fireRate:Tt,collisionRadius:de,fireType:"bullet"})}o.push({id:"boss-turret-rocket",position:{x:i-e*.7,y:-O/2},offsetX:-e*.7,offsetY:-O*.15,health:ie,maxHealth:ie,isAlive:!0,fireCooldown:2e3,fireRate:je,collisionRadius:de,fireType:"rocket"}),o.push({id:"boss-turret-homing",position:{x:i+e*.7,y:-O/2},offsetX:e*.7,offsetY:-O*.15,health:ie,maxHealth:ie,isAlive:!0,fireCooldown:3e3,fireRate:je,collisionRadius:de,fireType:"homing"});const n=[{offsetX:0,offsetY:O*.3,width:ee*.18,height:O*.4}];return{position:{x:i,y:-O/2},velocity:{x:0,y:0},width:ee,height:O,isAlive:!0,health:qe,maxHealth:qe,turrets:o,layer:"entering",deathSequence:null,scoreValue:Pt,upperCollisionZones:n}}const zo=3e3,ni={A:ye,B:Ro,C:si,D:bo,E:ko,F:_o};class qo{constructor(){this.levels=new Map,this.waveTransitionTimer=0,this.clearingTimer=0}registerLevel(e){this.levels.set(e.levelNumber,e)}startLevel(e,t){const s=this.levels.get(t);s&&(e.currentLevel=t,e.currentWave=1,e.waveStatus="transition",this.waveTransitionTimer=0,this.clearingTimer=0,this.spawnWave(e,s.waves[0]))}update(e){if(e.waveStatus==="transition"){this.waveTransitionTimer+=e.deltaTime,(this.waveTransitionTimer>=zo||e.currentWave===1)&&(e.waveStatus="active",this.waveTransitionTimer=0);return}if(e.waveStatus==="clearing"){this.clearingTimer+=e.deltaTime,this.clearingTimer>=Dt&&(e.waveStatus="complete",this.clearingTimer=0);return}if(e.waveStatus!=="active")return;const s=e.enemies.filter(f=>f.isAlive).length===0&&e.enemies.length>0,o=this.levels.get(e.currentLevel),l=o?.waves[e.currentWave-1]?.bossSpawn===!0,a=l&&e.boss&&!e.boss.isAlive&&!e.boss.deathSequence;(l?a:s)&&(o&&e.currentWave<o.waves.length?(e.currentWave++,e.waveStatus="transition",this.waveTransitionTimer=0,this.spawnWave(e,o.waves[e.currentWave-1])):(e.waveStatus="clearing",this.clearingTimer=0))}getTotalWaves(e){const t=this.levels.get(e);return t?t.waves.length:0}hasLevel(e){return this.levels.has(e)}getLevelName(e){return this.levels.get(e)?.name??""}spawnWave(e,t){if(e.enemies=[],e.projectiles=[],t.bossSpawn){e.boss=Vo();return}if(t.slots&&t.slots.length>0){let o=0,n=0;for(const l of t.slots)l.row>o&&(o=l.row),l.col>n&&(n=l.col);e.formation=ii(o+1,n+1);for(const l of t.slots){const a=ni[l.type]??ye;e.enemies.push(a(l.row,l.col))}}else{let o=0,n=0;for(const a of t.enemies)o+=a.rows,a.cols>n&&(n=a.cols);e.formation=ii(o,n);let l=0;for(const a of t.enemies){const r=ni[a.type]??ye;for(let f=0;f<a.rows;f++)for(let h=0;h<a.cols;h++)e.enemies.push(r(l+f,h));l+=a.rows}}const s=t.formation??t.enemies[0]?.formation??"grid";s!=="grid"&&(e.formation.offsetY=40,Ho(s,e.enemies,e.formation))}}let xo=0;function jo(i,e){return{id:`plasma-${xo++}`,type:"plasma",owner:e,position:{x:i.x,y:i.y},velocity:{x:0,y:Be},rotation:Math.PI,speed:Be,damage:Qi,isActive:!0,lifetime:0,maxLifetime:Zi,collisionRadius:Ji,hasCollided:!1}}let Qo=0;function li(i,e){return{id:`enemy-homing-${Qo++}`,type:"missile",owner:e,position:{x:i.x,y:i.y},velocity:{x:0,y:Oe},rotation:Math.PI,speed:Oe,damage:$i,isActive:!0,lifetime:0,maxLifetime:Ki,collisionRadius:Vi,hasCollided:!1,turnRate:Gi,isHoming:!0}}const Zo={laser:{base:3e3,jitter:500},bullet:{base:2e3,jitter:500},plasma:{base:2500,jitter:400},spread:{base:4e3,jitter:600},homing:{base:3500,jitter:500}};class Jo{constructor(){this.cooldowns=new Map}update(e,t){const s=e.enemies.filter(n=>n.isAlive);if(s.length===0)return;const o=this.getFrontRowEnemyIds(s);for(const n of s){if(n.fireMode==="none"||!o.has(n.id))continue;this.cooldowns.has(n.id)||this.cooldowns.set(n.id,this.randomCooldown(n.fireMode));let l=this.cooldowns.get(n.id);l-=t*1e3,l<=0&&(this.fireProjectile(e,n),l=this.randomCooldown(n.fireMode)),this.cooldowns.set(n.id,l)}for(const[n]of this.cooldowns)s.some(l=>l.id===n)||this.cooldowns.delete(n)}getFrontRowEnemyIds(e){const t=new Map;for(const s of e){const o=t.get(s.formationCol);(!o||s.position.y>o.y)&&t.set(s.formationCol,{id:s.id,y:s.position.y})}return new Set([...t.values()].map(s=>s.id))}fireProjectile(e,t){const s={type:"enemy",id:t.id},o={x:t.position.x,y:t.position.y+16};if(t.fireMode==="spread"){const a=[-12,-4,4,12].map(r=>{const f=r*Math.PI/180,h=pe(o,s);return h.velocity.x=Math.sin(f)*Z,h.velocity.y=Math.cos(f)*Z,h});e.projectiles=[...e.projectiles,...a];return}let n;t.fireMode==="laser"?n=io(o,s):t.fireMode==="plasma"?n=jo(o,s):t.fireMode==="homing"?n=li(o,s):n=pe(o,s),e.projectiles=[...e.projectiles,n]}randomCooldown(e){const t=Zo[e];return t?t.base+(Math.random()*2-1)*t.jitter:5e3}reset(){this.cooldowns.clear()}}const es=2,ve=3,is=300,ts={A:1,B:.7,C:1.5,F:.8},os=40,W=.2,ne=.5;class ss{constructor(){this.activeDivers=new Set,this.cooldownTimer=ve}update(e,t){const s=e.enemies.filter(o=>o.isAlive);if(s.length!==0){this.cooldownTimer-=t,this.activeDivers.size<es&&this.cooldownTimer<=0&&this.initiateDive(e,s);for(const o of s)o.diveState&&this.updateDivingEnemy(o,e,t);for(const o of this.activeDivers)s.some(n=>n.id===o)||this.activeDivers.delete(o)}}initiateDive(e,t){const s=t.filter(a=>!a.diveState&&!a.flightPathState&&!this.activeDivers.has(a.id));if(s.length===0)return;const o=s[Math.floor(Math.random()*s.length)],n=e.players.filter(a=>a.isAlive),l=n.length>0?n[Math.floor(Math.random()*n.length)].position.x:p/2;o.diveState={phase:"break",progress:0,targetX:l,startPos:{x:o.position.x,y:o.position.y}},this.activeDivers.add(o.id),this.cooldownTimer=ve}updateDivingEnemy(e,t,s){const o=e.diveState,l=is*(ts[e.type]??1)*s/v;if(o.progress+=l,o.progress<=W){const a=o.progress/W;e.position.x=o.startPos.x+(o.targetX-o.startPos.x)*a*.5,e.position.y=o.startPos.y+a*100}else if(o.progress<=W+ne){const a=(o.progress-W)/ne,r=o.startPos.x+(o.targetX-o.startPos.x)*.5,f=o.startPos.y+100;e.position.x=r+(o.targetX-r)*a,e.position.y=f+a*(v*.6)}else{o.phase="sweep";const a=(o.progress-W-ne)/(1-W-ne),r=o.startPos.y+100+v*.6;e.position.x=o.targetX,e.position.y=r+a*v*.4}e.position.y>v+os&&this.returnToFormation(e,t)}returnToFormation(e,t){const s=t.formation;e.position.x=s.offsetX+(e.formationCol+.5)*s.cellWidth,e.position.y=s.offsetY+(e.formationRow+.5)*s.cellHeight,e.diveState=null,this.activeDivers.delete(e.id)}getActiveDiverCount(){return this.activeDivers.size}isDiving(e){return this.activeDivers.has(e)}reset(){this.activeDivers.clear(),this.cooldownTimer=ve}}let F,ns=.3;function ls(...i){return ai(ri(...i))}function ai(i){if(!F)try{F=new AudioContext}catch{return}const e=F.createBuffer(1,i.length,F.sampleRate),t=e.getChannelData(0);for(let n=0;n<i.length;n++)t[n]=i[n];const s=F.createBufferSource(),o=F.createGain();return o.gain.value=ns,s.buffer=e,s.connect(o),o.connect(F.destination),s.start(),s}function ri(i=1,e=.05,t=220,s=0,o=0,n=.1,l=0,a=1,r=0,f=0,h=0,c=0,u=0,g=0,y=0,d=0,E=0,A=1,T=0,X=0){const C=Math.PI*2;let Ai=r*=500*C/44100/44100,$=t*=(1+e*2*Math.random()-e)*C/44100,K=[],b=0,Mi=0,k=0,ae=1,$s=0,Ti=0,x=0,j;s=s*44100+9,T=T*44100+9,o=o*44100,n=n*44100,E=E*44100,f*=500*C/44100**3,y*=C/44100,h*=C/44100,c*=44100,u=u*44100|0;const Pi=s+T+o+n+E|0;for(;k<Pi;K[k++]=x*i){++Ti>=100&&(Ti=0,x=0),u&&!(++$s%u)&&(t=$,r=Ai,ae=ae||1),c&&!(ae%c)&&(t+=h,$+=h,ae=0),t+=r+=f,b+=t-t*g*(Math.sin(k)**2+.5);const Ri=k<s?k/s:k<s+T?1+(A-1)*((k-s)/T):k<s+T+o?A:k<Pi-E?A*(1-(k-s-T-o)/n):0;j=l===0?Math.sin(b):l===1?Math.sin(b)**3:l===2?Math.sin(b%C>Math.PI?-1:1):l===3?(b%C/C*2-1+(b%C/C*2-1>0?-1:1))*.7:0,j*=1-X+X*Math.sin(C*k/44100/(1/(X*10|0))),y&&(Mi+=y,j*=Math.sin(Mi)),d?x+=j*Ri-x:x=j*Ri}return K}const fi={playerFire:[.5,.01,800,0,.02,.04,2,1,20,0,0,0,0,0,0,0,0,.5,.02,0],enemyFire:[.4,.02,400,0,.02,.06,2,1,-10,0,0,0,0,0,0,0,0,.5,.02,0],explosion:[.6,.05,200,0,.06,.2,3,1,0,0,0,0,0,1,0,0,0,.3,.1,0],playerDeath:[.8,.05,150,.01,.15,.4,3,1,-5,0,0,0,0,1,0,0,.1,.2,.15,0],menuSelect:[.3,0,600,0,.01,.02,0,1,0,0,200,.01,0,0,0,0,0,.8,0,0],hitA:[.5,.02,600,0,.03,.06,3,1,15,0,0,0,0,.3,0,0,0,.4,.04,0],hitB:[.7,.04,300,0,.06,.15,3,1,-8,-2,0,0,0,.8,0,0,0,.3,.1,0],hitC:[.6,.03,500,0,.04,.08,3,1,25,3,100,.02,0,.5,0,0,0,.4,.05,0],hitD:[.7,.03,250,.01,.08,.18,3,1,-5,-1,0,0,0,.6,0,0,0,.3,.12,0],hitE:[.8,.05,180,.01,.1,.25,3,1,-8,-2,0,0,0,.9,0,0,0,.2,.15,0],typeKey:[.15,.01,1200,0,.005,.01,0,1,0,0,0,0,0,0,0,0,0,.8,.005,0],asteroidHit:[.5,.04,150,0,.04,.08,3,1,-3,0,0,0,0,.7,0,0,0,.3,.06,0],asteroidExplode:[.7,.06,100,.01,.1,.3,3,1,-6,-1,0,0,0,1,0,0,0,.2,.15,0],hitF:[.9,.06,120,.02,.12,.3,3,1,-10,-3,0,0,0,1,0,0,0,.2,.18,0],missileWhistle:[.3,.02,600,.05,.2,.15,0,1,30,5,0,0,0,0,0,0,0,.5,.1,.2],bossExplosion:[3,.12,40,.04,.5,1.2,3,1,-12,-4,0,0,0,2,0,0,.2,.25,.4,0],lifePickup:[.4,0,800,0,.02,.08,0,1,10,0,400,.02,0,0,0,0,0,.7,.02,0]},L=class L{static init(){L.initialized=!0}static play(e){if(L.muted)return;const t=fi[e];if(t)try{ls(...t)}catch{}}static setMuted(e){L.muted=e}static isMuted(){return L.muted}static toggleMute(){return L.muted=!L.muted,L.muted}static reset(){L.muted=!1,L.initialized=!1}static getPreset(e){return fi[e]}};L.muted=!1,L.initialized=!1;let w=L;function as(i){const[e,t,s,o]=i,n=o/60*44100/4|0,l=s[0].length,a=t[0]?.length??0,r=[];for(let c=0;c<a;c++)r.push([]);for(let c=0;c<l;c++)for(let u=0;u<a;u++){const g=s[u][c],y=t[g];if(!y||!y[u])continue;const d=y[u],E=d.length/3|0;for(let A=0;A<E;A++){const T=d[A*3],X=d[A*3+1];if(T!==void 0&&T>0&&X!==void 0){const G=[...e[X]||[]],C=G[2]||220;G[2]=C*2**((T-60)/12);const $=ri(...G).slice(0,n);r[u].length;const K=(c*E+A)*n;for(;r[u].length<K;)r[u].push(0);for(let b=0;b<$.length;b++)r[u].length<=K+b?r[u].push($[b]):r[u][K+b]+=$[b]}else{const G=(c*E+A+1)*n;for(;r[u].length<G;)r[u].push(0)}}}const f=Math.max(...r.map(c=>c.length),0),h=new Array(f).fill(0);for(const c of r)for(let u=0;u<c.length;u++)h[u]+=c[u];if(a>1){const c=1/a;for(let u=0;u<h.length;u++)h[u]*=c}return h}const rs={menu:[[[.3,0,220,.1,.3,.2,0,1,0,0,0,0,0,0,0,0,0,.7,.05,0],[.25,0,110,0,.15,.1,2,1,0,0,0,0,0,0,0,0,0,.5,.02,0]],[[[60,0,0,64,0,0,67,0,0,64,0,0,60,0,0,62,0,0,65,0,0,62,0,0],[48,1,0,0,void 0,0,48,1,0,0,void 0,0,45,1,0,0,void 0,0,45,1,0,0,void 0,0]],[[65,0,0,67,0,0,69,0,0,67,0,0,65,0,0,64,0,0,62,0,0,60,0,0],[41,1,0,0,void 0,0,41,1,0,0,void 0,0,43,1,0,0,void 0,0,48,1,0,0,void 0,0]]],[[0,1,0,1],[0,1,0,1]],90],level1:[[[.25,0,220,.12,.35,.25,0,1,0,0,0,0,0,0,0,0,0,.6,.08,0],[.2,0,55,.02,.2,.15,0,1,0,0,0,0,0,0,0,0,0,.5,.04,0],[.15,0,440,.01,.1,.12,1,1,0,0,0,0,0,0,0,0,0,.4,.03,.3]],[[[60,0,0,0,void 0,0,64,0,0,0,void 0,0,67,0,0,0,void 0,0,64,0,0,0,void 0,0],[48,1,0,0,void 0,0,48,1,0,0,void 0,0,43,1,0,0,void 0,0,45,1,0,0,void 0,0],[72,2,0,0,void 0,0,76,2,0,0,void 0,0,79,2,0,0,void 0,0,76,2,0,0,void 0,0]],[[64,0,0,0,void 0,0,67,0,0,0,void 0,0,69,0,0,0,void 0,0,67,0,0,0,void 0,0],[45,1,0,0,void 0,0,43,1,0,0,void 0,0,48,1,0,0,void 0,0,45,1,0,0,void 0,0],[79,2,0,0,void 0,0,81,2,0,0,void 0,0,84,2,0,0,void 0,0,79,2,0,0,void 0,0]],[[60,0,0,0,void 0,0,0,void 0,0,0,void 0,0,62,0,0,0,void 0,0,0,void 0,0,0,void 0,0],[36,1,0,0,void 0,0,0,void 0,0,0,void 0,0,40,1,0,0,void 0,0,0,void 0,0,0,void 0,0],[72,2,0,0,void 0,0,0,void 0,0,0,void 0,0,74,2,0,0,void 0,0,0,void 0,0,0,void 0,0]]],[[0,0,1,2,0,1],[0,0,1,2,0,1],[0,0,1,2,0,1]],105],level2:[[[.4,0,220,.01,.15,.1,1,1,0,0,0,0,0,0,0,0,0,.7,.02,0],[.3,0,110,.01,.2,.12,2,1,0,0,0,0,0,0,0,0,0,.6,.03,0],[.35,0,100,0,.02,.05,4,1,0,0,0,0,0,2,0,0,0,.3,.01,0]],[[[64,0,0,67,0,0,71,0,0,67,0,0,64,0,0,69,0,0,67,0,0,64,0,0],[40,1,0,0,void 0,0,40,1,0,0,void 0,0,45,1,0,0,void 0,0,43,1,0,0,void 0,0],[60,2,0,0,void 0,0,60,2,0,60,2,0,60,2,0,0,void 0,0,60,2,0,60,2,0]],[[71,0,0,72,0,0,74,0,0,72,0,0,69,0,0,67,0,0,64,0,0,67,0,0],[45,1,0,45,1,0,43,1,0,0,void 0,0,40,1,0,40,1,0,43,1,0,0,void 0,0],[60,2,0,60,2,0,60,2,0,0,void 0,0,60,2,0,60,2,0,60,2,0,60,2,0]]],[[0,1,0,1],[0,1,0,1],[0,1,0,1]],130],level3:[[[.3,.1,440,0,.08,.06,2,1,.5,0,0,0,0,0,0,0,0,.5,.01,0],[.35,0,80,.02,.2,.15,0,1,0,0,0,0,0,0,3,0,0,.6,.04,0],[.2,0,200,0,.01,.02,4,1,0,0,0,0,0,3,0,0,0,.2,0,0]],[[[72,0,0,75,0,0,79,0,0,82,0,0,79,0,0,75,0,0,73,0,0,70,0,0],[36,1,0,0,void 0,0,36,1,0,0,void 0,0,39,1,0,0,void 0,0,34,1,0,0,void 0,0],[80,2,0,80,2,0,80,2,0,80,2,0,80,2,0,80,2,0,80,2,0,80,2,0]],[[84,0,0,82,0,0,80,0,0,78,0,0,76,0,0,74,0,0,72,0,0,75,0,0],[0,void 0,0,39,1,0,0,void 0,0,36,1,0,0,void 0,0,34,1,0,0,void 0,0,36,1,0],[80,2,0,0,void 0,0,80,2,0,80,2,0,0,void 0,0,80,2,0,80,2,0,0,void 0,0]]],[[0,1,0,1],[0,1,0,1],[0,1,0,1]],140],level4:[[[.35,0,330,0,.05,.04,1,1,0,0,0,0,0,0,0,0,0,.5,.01,0],[.4,0,55,.01,.25,.2,0,1,0,0,0,0,0,0,0,0,0,.7,.05,0],[.3,0,150,0,.02,.03,4,1,0,0,0,0,0,2.5,0,0,0,.3,.01,0]],[[[72,0,0,0,void 0,0,75,0,0,72,0,0,0,void 0,0,77,0,0,72,0,0,0,void 0,0],[36,1,0,0,void 0,0,0,void 0,0,36,1,0,0,void 0,0,0,void 0,0,34,1,0,0,void 0,0],[60,2,0,60,2,0,0,void 0,0,60,2,0,60,2,0,60,2,0,0,void 0,0,60,2,0]],[[75,0,0,77,0,0,79,0,0,0,void 0,0,82,0,0,79,0,0,77,0,0,75,0,0],[36,1,0,36,1,0,0,void 0,0,0,void 0,0,34,1,0,34,1,0,0,void 0,0,36,1,0],[60,2,0,60,2,0,60,2,0,60,2,0,60,2,0,60,2,0,60,2,0,60,2,0]]],[[0,1,0,1],[0,1,0,1],[0,1,0,1]],165],level5:[[[.4,.1,330,0,.06,.05,2,1,.3,0,0,0,0,0,0,0,0,.6,.02,0],[.45,0,55,.01,.3,.25,0,1,0,0,0,0,0,0,0,0,0,.7,.06,0],[.35,0,120,0,.02,.04,4,1,0,0,0,0,0,3,0,0,0,.3,.01,0]],[[[72,0,0,72,0,0,0,void 0,0,75,0,0,72,0,0,0,void 0,0,79,0,0,77,0,0],[36,1,0,0,void 0,0,36,1,0,0,void 0,0,34,1,0,34,1,0,36,1,0,0,void 0,0],[60,2,0,60,2,0,60,2,0,0,void 0,0,60,2,0,60,2,0,60,2,0,60,2,0]],[[79,0,0,77,0,0,75,0,0,77,0,0,82,0,0,79,0,0,75,0,0,72,0,0],[36,1,0,36,1,0,0,void 0,0,34,1,0,36,1,0,0,void 0,0,39,1,0,36,1,0],[60,2,0,60,2,0,60,2,0,60,2,0,60,2,0,60,2,0,60,2,0,60,2,0]]],[[0,1,0,1],[0,1,0,1],[0,1,0,1]],175]},m=class m{static play(e){if(m.currentTrack!==e||!m.playing)m.stop();else return;if(m.currentTrack=e,w.isMuted()){m.playing=!0;return}m.startPlayback(e)}static stop(){if(m.sourceNode){try{m.sourceNode.stop()}catch{}m.sourceNode=null}m.currentTrack=null,m.playing=!1}static getCurrentTrack(){return m.currentTrack}static isPlaying(){return m.playing}static onMuteChanged(e){if(e){if(m.sourceNode){try{m.sourceNode.stop()}catch{}m.sourceNode=null}}else m.currentTrack&&m.playing&&m.startPlayback(m.currentTrack)}static reset(){m.stop()}static startPlayback(e){const t=rs[e];if(t)try{const s=as(t),o=ai(s);o&&(o.loop=!0,m.sourceNode=o,m.playing=!0)}catch{m.playing=!0}}};m.currentTrack=null,m.sourceNode=null,m.playing=!1;let I=m,fs=0;class cs{constructor(){this.spawnTimer=0,this.nextSpawnDelay=he}update(e,t){if(e.currentLevel!==4||e.gameStatus!=="playing")return;this.spawnTimer+=t,this.spawnTimer>=this.nextSpawnDelay&&(this.spawnAsteroid(e),this.spawnTimer=0,this.nextSpawnDelay=he+(Math.random()*2-1)*vt);const s=t/1e3;for(const o of e.asteroids)o.isAlive&&(o.position.x+=o.velocity.x*s,o.position.y+=o.velocity.y*s,o.rotation+=o.rotationSpeed*s);e.asteroids=e.asteroids.filter(o=>o.isAlive&&o.position.y<v+50)}spawnAsteroid(e){const t=Math.random()<.4,s=t?pt:ut,o=Ke+Math.random()*(gt-Ke),n={id:`asteroid-${fs++}`,size:t?"large":"small",position:{x:s+Math.random()*(p-s*2),y:-s},velocity:{x:(Math.random()-.5)*20,y:o},rotation:Math.random()*Math.PI*2,rotationSpeed:(Math.random()-.5)*2,health:t?$e:Ge,maxHealth:t?$e:Ge,collisionRadius:s,isAlive:!0,scoreValue:t?yt:mt};e.asteroids=[...e.asteroids,n]}reset(){this.spawnTimer=0,this.nextSpawnDelay=he}}let hs=0;class ds{maybeSpawnPickup(e,t){if(Math.random()>=wt)return;const s=Math.random()<.7,o=s?"primary":"secondary",n=s?Math.random()<.5?"laser":"bullet":Math.random()<.5?"rocket":"missile",l={id:`wp-${hs++}`,category:o,currentWeapon:n,position:{x:t.x,y:t.y},velocity:{x:0,y:Et},isActive:!0,cycleTimer:Ve,lifetime:0};e.weaponPickups=[...e.weaponPickups,l]}updatePickups(e,t){const s=t/1e3;for(const o of e.weaponPickups)if(o.isActive){if(o.position.x+=o.velocity.x*s,o.position.y+=o.velocity.y*s,o.lifetime+=t,o.lifetime>=At){o.isActive=!1;continue}o.cycleTimer-=t,o.cycleTimer<=0&&(o.cycleTimer=Ve,o.category==="primary"?o.currentWeapon=o.currentWeapon==="laser"?"bullet":"laser":o.currentWeapon=o.currentWeapon==="rocket"?"missile":"rocket")}e.weaponPickups=e.weaponPickups.filter(o=>o.isActive)}}class us{constructor(){this.fighterSpawnTimer=0}update(e,t){const s=e.boss;if(!s||!s.isAlive){s?.deathSequence&&this.updateDeathSequence(s,e,t);return}switch(s.layer){case"entering":this.updateEntry(s,t);break;case"active":this.updateActive(s,e,t);break;case"dying":this.updateDeathSequence(s,e,t);break}this.updateTurretPositions(s)}updateEntry(e,t){e.position.y+=Ct*t,e.position.y>=120&&(e.position.y=120,e.layer="active")}updateActive(e,t,s){e.position.x=p/2+Math.sin(t.currentTime*.001*.5*Math.PI*2)*60;for(const a of e.turrets)if(a.isAlive&&(a.fireCooldown-=s*1e3,a.fireCooldown<=0)){const r={type:"enemy",id:a.id},f={x:a.position.x,y:a.position.y+20};if(a.fireType==="homing"){const h=li(f,r);t.projectiles=[...t.projectiles,h]}else if(a.fireType==="rocket")t.projectiles=[...t.projectiles,{id:`boss-rocket-${Date.now()}-${Math.random()}`,type:"rocket",owner:r,position:{...f},velocity:{x:0,y:J},rotation:Math.PI,speed:J,damage:Ue,isActive:!0,lifetime:0,maxLifetime:We,collisionRadius:Ye,hasCollided:!1,acceleration:Fe,maxSpeed:He}];else{const h=pe(f,r);t.projectiles=[...t.projectiles,h]}a.fireCooldown=a.fireRate}if(e.turrets.every(a=>!a.isAlive)&&e.health>0&&(this.fighterSpawnTimer-=s*1e3,this.fighterSpawnTimer<=0)){this.fighterSpawnTimer=bt;const a=si(0,0),r=e.position.x,f=e.position.y+e.height*.4;a.position={x:r,y:f},a.velocity={x:(Math.random()-.5)*100,y:150},a.diveState={phase:"sweep",progress:0,targetX:r+(Math.random()-.5)*200,startPos:{x:r,y:f}},t.enemies=[...t.enemies,a]}}startDeathSequence(e){e.layer="dying",e.deathSequence={phase:0,timer:0,phaseDuration:Lt}}updateDeathSequence(e,t,s){if(e.deathSequence&&(e.deathSequence.timer+=s*1e3,e.deathSequence.timer>=e.deathSequence.phaseDuration)){e.deathSequence.timer=0,e.deathSequence.phase++;const o=e.turrets.length;if(e.deathSequence.phase>o){e.isAlive=!1,e.deathSequence=null;for(const n of t.players)n.isAlive&&(n.score+=e.scoreValue)}}}updateTurretPositions(e){for(const t of e.turrets)t.position.x=e.position.x+t.offsetX,t.position.y=e.position.y+t.offsetY}reset(){this.fighterSpawnTimer=0}}let ps=0;class ms{constructor(){this.spawnedThisLevel=!1,this.spawnCheckDone=!1,this.spawnAtTime=0}update(e,t){if(!this.spawnCheckDone&&e.gameStatus==="playing"&&(this.spawnCheckDone=!0,Math.random()<It&&(this.spawnAtTime=e.currentTime+5e3+Math.random()*1e4)),!this.spawnedThisLevel&&this.spawnAtTime>0&&e.currentTime>=this.spawnAtTime){this.spawnedThisLevel=!0;const o={id:`life-${ps++}`,position:{x:100+Math.random()*600,y:-20},velocity:{x:0,y:kt},isActive:!0,lifetime:0};e.lifePickups=[...e.lifePickups,o]}const s=t/1e3;for(const o of e.lifePickups)o.isActive&&(o.position.y+=o.velocity.y*s,o.lifetime+=t,(o.lifetime>=Ot||o.position.y>v+20)&&(o.isActive=!1));e.lifePickups=e.lifePickups.filter(o=>o.isActive)}reset(){this.spawnedThisLevel=!1,this.spawnCheckDone=!1,this.spawnAtTime=0}}const ys={levelNumber:1,name:"Invasion",waves:[{waveNumber:1,delay:0,enemies:[{type:"A",count:20,formation:"grid",rows:5,cols:4,spawnDelay:0}]},{waveNumber:2,delay:3e3,enemies:[{type:"A",count:16,formation:"grid",rows:4,cols:4,spawnDelay:0},{type:"B",count:4,formation:"grid",rows:1,cols:4,spawnDelay:0}]},{waveNumber:3,delay:3e3,enemies:[{type:"A",count:12,formation:"grid",rows:3,cols:4,spawnDelay:0},{type:"B",count:4,formation:"grid",rows:1,cols:4,spawnDelay:0},{type:"C",count:4,formation:"grid",rows:1,cols:4,spawnDelay:0}]},{waveNumber:4,delay:3e3,enemies:[{type:"A",count:8,formation:"grid",rows:2,cols:4,spawnDelay:0},{type:"B",count:8,formation:"grid",rows:2,cols:4,spawnDelay:0},{type:"C",count:4,formation:"grid",rows:1,cols:4,spawnDelay:0}]},{waveNumber:5,delay:3e3,enemies:[{type:"A",count:4,formation:"grid",rows:1,cols:4,spawnDelay:0},{type:"B",count:8,formation:"grid",rows:2,cols:4,spawnDelay:0},{type:"C",count:8,formation:"grid",rows:2,cols:4,spawnDelay:0}]}]};function P(i,e){return e.map(([t,s])=>({type:i,row:t,col:s}))}const vs={levelNumber:2,name:"Earth Defence",waves:[{waveNumber:1,delay:0,enemies:[],formation:"w-curve",slots:[...P("A",[[0,0],[0,1],[0,7],[0,8],[1,1],[1,2],[1,6],[1,7],[2,2],[2,3],[2,5],[2,6]]),...P("B",[[3,3],[3,4],[3,5],[4,4]])]},{waveNumber:2,delay:3e3,enemies:[],formation:"chiral",slots:[...P("A",[[0,3],[0,4],[1,2],[1,5],[2,1],[2,6],[3,2],[3,5],[4,3],[4,4]]),...P("B",[[1,3],[1,4],[2,2],[2,3],[2,4],[2,5],[3,3],[3,4]])]},{waveNumber:3,delay:3e3,enemies:[],formation:"diagonal",slots:[...P("B",[[0,0],[0,1],[0,2],[1,2],[1,3],[1,4],[2,4],[2,5],[2,6]]),...P("C",[[3,6],[3,7],[3,8]])]},{waveNumber:4,delay:3e3,enemies:[],formation:"side-wave",slots:[...P("A",[[0,0],[0,1],[0,2],[1,0],[1,1],[1,2],[2,0],[2,1],[2,2]]),...P("B",[[0,6],[0,7],[0,8],[1,6],[1,7],[1,8],[2,6],[2,7],[2,8]]),...P("C",[[3,4],[4,4]])]},{waveNumber:5,delay:3e3,enemies:[],formation:"m-shape",slots:[...P("B",[[0,3],[0,4],[1,2],[1,3],[1,4],[1,5],[2,1],[2,6]]),...P("C",[[2,2],[2,5],[3,3],[3,4],[4,3],[4,4],[5,3],[5,4]])]},{waveNumber:6,delay:3e3,enemies:[],formation:"inverted-v",slots:[...P("A",[[0,3],[0,4],[0,5],[4,3],[4,4],[4,5]]),...P("B",[[0,2],[0,6],[1,1],[1,7],[2,0],[2,8],[3,1],[3,7],[4,2],[4,6]]),...P("C",[[1,2],[1,6],[3,2],[3,6]])]}]};function M(i,e){return e.map(([t,s])=>({type:i,row:t,col:s}))}const gs={levelNumber:3,name:"Moon Battle",waves:[{waveNumber:1,delay:0,enemies:[],formation:"w-curve",slots:[...M("A",[[0,0],[0,1],[0,7],[0,8],[1,1],[1,2],[1,6],[1,7]]),...M("B",[[2,2],[2,3],[2,5],[2,6],[3,3],[3,4],[3,5],[4,4]])]},{waveNumber:2,delay:3e3,enemies:[],formation:"chiral",slots:[...M("A",[[0,3],[0,4],[1,2],[1,5],[3,2],[3,5],[4,3],[4,4]]),...M("C",[[2,1],[2,6]]),...M("D",[[1,3],[1,4],[2,2],[2,3],[2,4],[2,5],[3,3],[3,4]])]},{waveNumber:3,delay:3e3,enemies:[],formation:"diagonal",slots:[...M("B",[[0,0],[0,1],[0,2],[1,2],[1,3],[1,4]]),...M("D",[[2,4],[2,5],[2,6],[3,6],[3,7],[3,8]])]},{waveNumber:4,delay:3e3,enemies:[],formation:"side-wave",slots:[...M("A",[[0,0],[0,1],[0,2],[1,0],[1,1],[1,2]]),...M("B",[[2,0],[2,1],[2,2]]),...M("C",[[0,6],[0,7],[0,8]]),...M("D",[[1,6],[1,7],[1,8],[2,6],[2,7],[2,8]])]},{waveNumber:5,delay:3e3,enemies:[],formation:"m-shape",slots:[...M("C",[[0,3],[0,4],[1,2],[1,5],[2,1],[2,6]]),...M("D",[[1,3],[1,4],[2,2],[2,5],[3,3],[3,4],[4,3],[4,4]])]},{waveNumber:6,delay:3e3,enemies:[],formation:"inverted-v",slots:[...M("B",[[0,3],[0,4],[0,5],[4,3],[4,4],[4,5]]),...M("C",[[0,2],[0,6],[1,1],[1,7],[3,1],[3,7],[4,2],[4,6]]),...M("D",[[2,0],[2,8],[1,2],[1,6],[3,2],[3,6]])]}]};function S(i,e){return e.map(([t,s])=>({type:i,row:t,col:s}))}const Ss={levelNumber:4,name:"Asteroid Belt",waves:[{waveNumber:1,delay:0,enemies:[],formation:"w-curve",slots:[...S("A",[[0,0],[0,1],[0,7],[0,8],[1,1],[1,7]]),...S("B",[[1,2],[1,6],[2,3],[2,5]]),...S("D",[[2,2],[2,6],[3,3],[3,4],[3,5],[4,4]])]},{waveNumber:2,delay:3e3,enemies:[],formation:"chiral",slots:[...S("B",[[0,3],[0,4],[1,2],[1,5],[3,2],[3,5],[4,3],[4,4]]),...S("C",[[2,1],[2,6]]),...S("E",[[1,3],[1,4],[2,2],[2,3],[2,4],[2,5],[3,3],[3,4]])]},{waveNumber:3,delay:3e3,enemies:[],formation:"diagonal",slots:[...S("C",[[0,0],[0,1],[0,2]]),...S("D",[[1,2],[1,3],[1,4],[2,4],[2,5]]),...S("E",[[2,6],[3,6],[3,7],[3,8]])]},{waveNumber:4,delay:3e3,enemies:[],formation:"side-wave",slots:[...S("A",[[0,0],[0,1],[0,8],[0,9]]),...S("B",[[1,0],[1,1],[1,8],[1,9]]),...S("C",[[0,4],[0,5],[1,4],[1,5]]),...S("D",[[2,2],[2,3],[2,6],[2,7]]),...S("E",[[2,4],[2,5],[3,4],[3,5]])]},{waveNumber:5,delay:3e3,enemies:[],formation:"m-shape",slots:[...S("D",[[0,3],[0,4],[1,2],[1,5],[2,1],[2,6]]),...S("E",[[1,3],[1,4],[2,2],[2,5],[3,3],[3,4],[4,3],[4,4]])]},{waveNumber:6,delay:3e3,enemies:[],formation:"inverted-v",slots:[...S("A",[[0,3],[0,4],[0,5]]),...S("B",[[0,2],[0,6],[1,1],[1,7]]),...S("C",[[2,0],[2,8],[3,1],[3,7]]),...S("D",[[4,2],[4,6],[4,3],[4,5]]),...S("E",[[1,2],[1,6],[3,2],[3,6],[4,4]])]}]};function R(i,e){return e.map(([t,s])=>({type:i,row:t,col:s}))}const ws={levelNumber:5,name:"Defeat Mars Colony",waves:[{waveNumber:1,delay:0,enemies:[],formation:"x-formation",slots:[...R("A",[[0,0],[0,1],[0,7],[0,8],[1,1],[1,7]]),...R("B",[[1,2],[1,6],[2,3],[2,5]]),...R("D",[[2,4],[3,3],[3,5]])]},{waveNumber:2,delay:3e3,enemies:[],formation:"w-curve",slots:[...R("C",[[0,1],[0,2],[0,6],[0,7]]),...R("D",[[1,2],[1,6],[2,3],[2,5]]),...R("F",[[1,3],[1,4],[1,5],[2,4]])]},{waveNumber:3,delay:3e3,enemies:[],formation:"chiral",slots:[...R("E",[[0,2],[0,6],[1,1],[1,7]]),...R("F",[[0,3],[0,4],[0,5],[1,3],[1,4],[1,5],[2,3],[2,5]])]},{waveNumber:4,delay:3e3,enemies:[],formation:"inverted-v",slots:[...R("A",[[0,0],[0,8]]),...R("B",[[0,1],[0,7]]),...R("C",[[1,2],[1,6]]),...R("D",[[1,3],[1,5]]),...R("E",[[2,2],[2,6],[3,3],[3,5]]),...R("F",[[2,3],[2,4],[2,5],[3,4]])]},{waveNumber:5,delay:3e3,enemies:[],bossSpawn:!0}]},Es={1:`2029.07.04 // 03:17 UTC
first contact confirmed. space force scrambled to defend earth.`,2:`// 07:45 UTC
the swarm has reached orbit. space force activates planetary defence grid.`,3:`// 12:08 UTC
enemy stronghold detected on the far side of the moon. space force moves to intercept.`,4:`// 18:32 UTC
hostile signatures in the asteroid belt. space force navigates the debris field.`,5:`// 23:00 UTC
enemy command has seized the mars colony. space force begins final assault on the mothership.`},ci=50,As=1500;class Ms{constructor(e={}){this.introTimer=0,this.headless=e.headless??!1,this.renderer=e.renderer??null,this.stateManager=new Wt,this.inputHandler=new Gt(this.headless),this.gameLoop=new Ut(t=>this.update(t),t=>this.render(t)),this.levelManager=new qo,this.levelManager.registerLevel(ys),this.levelManager.registerLevel(vs),this.levelManager.registerLevel(gs),this.levelManager.registerLevel(Ss),this.levelManager.registerLevel(ws),this.enemyFiringManager=new Jo,this.diveManager=new ss,this.asteroidManager=new cs,this.weaponPickupManager=new ds,this.bossManager=new us,this.lifePickupManager=new ms,this.stateManager.currentState.background=q(),I.play("menu")}start(){this.headless||this.gameLoop.start()}stop(){this.gameLoop.stop()}tickHeadless(e){this.gameLoop.tickHeadless(e)}getState(){return this.stateManager.currentState}getPreviousState(){return this.stateManager.previousState}update(e){this.stateManager.swapBuffers();const t=this.stateManager.currentState,s=e/1e3;switch(t.deltaTime=e,t.currentTime+=e,t.gameStatus){case"menu":this.updateMenu(t);break;case"playing":this.updatePlaying(t,s);break;case"paused":this.updatePaused(t);break;case"gameover":this.updateGameOver(t);break;case"levelcomplete":this.updateLevelComplete(t);break;case"levelintro":this.updateLevelIntro(t);break}}updateMenu(e){const t=this.inputHandler.getMenuInput();if(e.menu){if(t.down&&(e.menu={...e.menu,selectedOption:Math.min(e.menu.selectedOption+1,e.menu.options.length-1)}),t.up&&(e.menu={...e.menu,selectedOption:Math.max(e.menu.selectedOption-1,0)}),e.menu.type==="levelselect"){if(t.back){w.play("menuSelect"),e.menu={type:"start",selectedOption:0,options:["1 Player","2 Players","Test Mode"]};return}if(t.confirm){w.play("menuSelect");const s=e.menu.options[e.menu.selectedOption];if(s==="Back")e.menu={type:"start",selectedOption:0,options:["1 Player","2 Players","Test Mode"]};else{const o=parseInt(s.split(":")[0].replace("Level ",""),10);e.gameMode="single",this.startGame(e,o)}}return}if(t.confirm){w.play("menuSelect");const s=e.menu.options[e.menu.selectedOption];s==="1 Player"?(e.gameMode="single",this.startGame(e)):s==="2 Players"?(e.gameMode="co-op",this.startGame(e)):s==="Test Mode"&&(e.menu={type:"levelselect",selectedOption:0,options:this.getLevelOptions()})}}}startGame(e,t=1){if(e.projectiles=[],e.gameMode==="co-op"){const s=ue("player1");s.position.x=p*.33;const o=ue("player2");o.position.x=p*.66,e.players=[s,o]}else e.players=[ue("player1")];this.enemyFiringManager.reset(),this.diveManager.reset(),this.asteroidManager.reset(),this.startLevelIntro(e,t)}startLevelIntro(e,t){const s=Es[t]??`level ${t}`;e.currentLevel=t,e.gameStatus="levelintro",e.menu={type:"levelintro",selectedOption:0,options:[],data:{level:t,introText:s,introChars:0}},this.introTimer=0}getLevelOptions(){const e=[];for(let t=1;this.levelManager.hasLevel(t);t++)e.push(`Level ${t}: ${this.levelManager.getLevelName(t)}`);return e.push("Back"),e}updatePlaying(e,t){if(this.inputHandler.getPauseToggle()){e.gameStatus="paused",e.menu={type:"pause",selectedOption:0,options:["Resume","Main Menu"]};return}if(this.inputHandler.getMuteToggle()){const d=w.toggleMute();I.onMuteChanged(d)}for(const d of e.players)d.deathSequence?.active||(d.id==="player1"?d.input=this.inputHandler.getPlayerInput():d.id==="player2"&&(d.input=this.inputHandler.getPlayer2Input()));for(const d of e.players)d.deathSequence?.active||$t(d,t);for(const d of e.players)d.deathSequence?.active||(uo(d,t*1e3),d.secondaryCooldown>0&&(d.secondaryCooldown-=t*1e3));const s=e.projectiles.length;so(e),e.projectiles.length-s>0&&w.play("playerFire"),oo(e,t),e.formation&&e.enemies.length>0&&lo(e,t),Fo(e,t),this.diveManager.update(e,t);const n=e.projectiles.length;this.enemyFiringManager.update(e,t),e.projectiles.length>n&&w.play("enemyFire"),this.bossManager.update(e,t),e.boss?.isAlive&&e.boss.health<=0&&!e.boss.deathSequence&&this.bossManager.startDeathSequence(e.boss),e.background&&ti(e.background,t),this.asteroidManager.update(e,t*1e3),this.weaponPickupManager.updatePickups(e,t*1e3),this.lifePickupManager.update(e,t*1e3);const l=e.waveStatus;if(this.levelManager.update(e),l==="active"&&e.waveStatus!=="active")for(const d of e.players)d.isAlive&&(d.score+=Nt);if(l==="clearing"&&e.waveStatus==="complete"){e.gameStatus="levelcomplete",I.stop();const d=e.players.reduce((A,T)=>A+T.score,0),E=this.levelManager.hasLevel(e.currentLevel+1);e.menu={type:"levelcomplete",selectedOption:0,options:E?["Next Level","Main Menu"]:["Main Menu"],data:{finalScore:d,wave:e.currentWave,level:e.currentLevel}};return}const a=new Map(e.enemies.map(d=>[d.id,{alive:d.isAlive,type:d.type}])),r=new Map(e.asteroids.map(d=>[d.id,{alive:d.isAlive,health:d.health}])),f=e.boss?new Map(e.boss.turrets.map(d=>[d.id,d.isAlive])):new Map,h=e.boss?.health??0,c=e.lifePickups.filter(d=>d.isActive).length,u=e.players.filter(d=>d.isAlive).length;po(e),e.lifePickups.filter(d=>d.isActive).length<c&&w.play("lifePickup");for(const d of e.enemies)if(a.get(d.id)?.alive&&!d.isAlive){const A=`hit${d.type}`;w.play(A),this.weaponPickupManager.maybeSpawnPickup(e,d.position)}for(const d of e.asteroids){const E=r.get(d.id);E&&E.alive&&(d.isAlive?d.health<E.health&&w.play("asteroidHit"):w.play("asteroidExplode"))}if(e.boss){for(const d of e.boss.turrets)f.get(d.id)&&!d.isAlive&&w.play("bossExplosion");e.boss.health<h&&e.boss.health>0&&w.play("hitF")}if(e.players.filter(d=>d.isAlive).length<u){w.play("playerDeath");for(const d of e.players)!d.isAlive&&d.collisionState==="destroyed"&&(d.primaryWeapon="laser",d.primaryLevel=1,d.secondaryWeapon=null,d.secondaryTimer=0,d.secondaryCooldown=0);e.weaponPickups=[]}for(const d of e.players)d.deathSequence?.active&&e.currentTime-d.deathSequence.startTime>=d.deathSequence.duration&&(d.deathSequence.active=!1,d.lives>0&&xt(d));this.checkGameOver(e)}updatePaused(e){const t=this.inputHandler.getMenuInput();if(e.menu){if(t.back){e.gameStatus="playing",e.menu=null;return}if(t.down&&(e.menu={...e.menu,selectedOption:Math.min(e.menu.selectedOption+1,e.menu.options.length-1)}),t.up&&(e.menu={...e.menu,selectedOption:Math.max(e.menu.selectedOption-1,0)}),t.confirm){w.play("menuSelect");const s=e.menu.options[e.menu.selectedOption];s==="Resume"?(e.gameStatus="playing",e.menu=null):s==="Main Menu"&&(this.stateManager.reset(),this.stateManager.currentState.background=q(),I.play("menu"))}}}updateGameOver(e){const t=this.inputHandler.getMenuInput();if(e.menu&&(t.down&&(e.menu={...e.menu,selectedOption:Math.min(e.menu.selectedOption+1,e.menu.options.length-1)}),t.up&&(e.menu={...e.menu,selectedOption:Math.max(e.menu.selectedOption-1,0)}),t.confirm)){w.play("menuSelect");const s=e.menu.options[e.menu.selectedOption];s==="Restart"?(this.stateManager.reset(),this.stateManager.currentState.background=q(),this.startGame(this.stateManager.currentState)):s==="Main Menu"&&(this.stateManager.reset(),this.stateManager.currentState.background=q(),I.play("menu"))}}updateLevelComplete(e){const t=this.inputHandler.getMenuInput();if(e.menu&&(t.down&&(e.menu={...e.menu,selectedOption:Math.min(e.menu.selectedOption+1,e.menu.options.length-1)}),t.up&&(e.menu={...e.menu,selectedOption:Math.max(e.menu.selectedOption-1,0)}),t.confirm)){w.play("menuSelect");const s=e.menu.options[e.menu.selectedOption];if(s==="Next Level"){const o=e.currentLevel+1;e.enemies=[],e.projectiles=[],e.boss=null,e.lifePickups=[],this.enemyFiringManager.reset(),this.diveManager.reset(),this.lifePickupManager.reset(),this.startLevelIntro(e,o)}else s==="Main Menu"&&(this.stateManager.reset(),this.stateManager.currentState.background=q(),I.play("menu"))}}updateLevelIntro(e){if(!e.menu?.data)return;const t=e.menu.data,s=t.introText??"",o=t.introChars??0;if(this.introTimer+=e.deltaTime,o<s.length){const n=Math.min(Math.floor(this.introTimer/ci),s.length);n>o&&(s[n-1]!==" "&&w.play("typeKey"),e.menu={...e.menu,data:{...t,introChars:n}})}else{const n=s.length*ci;this.introTimer>=n+As&&(e.gameStatus="playing",e.menu=null,I.play("level"+(t.level??1)),this.levelManager.startLevel(e,t.level??1))}e.background&&ti(e.background,e.deltaTime/1e3)}checkGameOver(e){if(e.players.some(o=>o.deathSequence?.active))return;const s=e.players.filter(o=>o.isAlive||o.lives>0);if(e.players.length>0&&s.length===0){e.gameStatus="gameover",I.play("menu");const o=e.players.find(a=>a.id==="player1"),n=e.players.find(a=>a.id==="player2"),l=o?.score??0;e.menu={type:"gameover",selectedOption:0,options:["Restart","Main Menu"],data:{finalScore:l,...n?{p2Score:n.score}:{}}}}}render(e){this.renderer&&this.renderer.render(this.stateManager.currentState,this.stateManager.previousState,e)}destroy(){this.stop(),I.stop(),this.inputHandler.destroy(),this.renderer&&this.renderer.destroy()}}const Ts=`
  .menu-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: rgba(0, 0, 0, 0.85);
    font-family: 'Courier New', monospace;
    color: #fff;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 1000;
  }

  .menu-overlay.visible {
    opacity: 1;
  }

  .menu-title {
    font-size: 52px;
    font-weight: bold;
    color: #ffff00;
    margin-bottom: 12px;
  }

  .menu-title.gameover {
    color: #ff4444;
  }

  .menu-title.levelcomplete {
    color: #44ff44;
  }

  .menu-subtitle {
    font-size: 16px;
    color: #88aacc;
    margin-bottom: 30px;
  }

  .menu-controls {
    font-size: 14px;
    color: #888;
    margin-bottom: 8px;
  }

  .menu-controls-group {
    margin-bottom: 24px;
  }

  .menu-score {
    font-size: 24px;
    color: #fff;
    margin-bottom: 8px;
  }

  .menu-p2score {
    font-size: 18px;
    color: #4488ff;
    margin-bottom: 16px;
  }

  .menu-options {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .menu-option {
    font-size: 22px;
    color: #666;
    padding: 6px 0;
    transition: color 0.15s;
  }

  .menu-option.selected {
    color: #ffff00;
  }

  .menu-option.selected::before {
    content: '> ';
  }

  .menu-version {
    position: absolute;
    bottom: 12px;
    font-size: 12px;
    color: #444;
  }

  .intro-level-label {
    font-size: 18px;
    color: #888;
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 4px;
  }

  .intro-typing {
    font-size: 28px;
    color: #00ffff;
    text-shadow: 0 0 8px #00ffff, 0 0 20px #006688;
    min-height: 40px;
  }

  .intro-cursor {
    animation: blink 0.6s step-end infinite;
    color: #00ffff;
  }

  @keyframes blink {
    50% { opacity: 0; }
  }
`;class Ps{constructor(e,t=Li){this.lastMenuType=null,this.lastSelectedOption=-1,this.lastMenuDataHash="",this.container=e,this.version=t,this.styleEl=document.createElement("style"),this.styleEl.textContent=Ts,document.head.appendChild(this.styleEl),this.overlay=document.createElement("div"),this.overlay.className="menu-overlay",this.container.appendChild(this.overlay)}update(e){const t=e.menu;if(!(e.gameStatus==="menu"||e.gameStatus==="paused"||e.gameStatus==="gameover"||e.gameStatus==="levelcomplete"||e.gameStatus==="levelintro")||!t){this.hide();return}const o=JSON.stringify(t.data||{});(t.type!==this.lastMenuType||o!==this.lastMenuDataHash)&&(this.buildMenu(t.type,t.options,t.data),this.lastMenuType=t.type,this.lastMenuDataHash=o),t.selectedOption!==this.lastSelectedOption&&(this.updateSelection(t.selectedOption),this.lastSelectedOption=t.selectedOption),this.show()}buildMenu(e,t,s){if(this.overlay.innerHTML="",e==="start")this.overlay.innerHTML=`
        <div class="menu-title">PB-GALAGA</div>
        <div class="menu-subtitle">A Space Shooter</div>
        <div class="menu-controls-group">
          <div class="menu-controls">Arrow Keys: Move Ship</div>
          <div class="menu-controls">Spacebar: Fire Laser</div>
        </div>
        ${this.buildOptions(t)}
        <div class="menu-version">v${this.version}</div>
      `;else if(e==="pause")this.overlay.innerHTML=`
        <div class="menu-title">PAUSED</div>
        <div class="menu-controls-group">
          <div class="menu-controls">Press ESC to resume</div>
        </div>
        ${this.buildOptions(t)}
      `;else if(e==="gameover"){let o="";s?.finalScore!==void 0&&(o+=`<div class="menu-score">Final Score: ${s.finalScore}</div>`),s?.p2Score!==void 0&&(o+=`<div class="menu-p2score">P2 Score: ${s.p2Score}</div>`),this.overlay.innerHTML=`
        <div class="menu-title gameover">GAME OVER</div>
        ${o}
        ${this.buildOptions(t)}
      `}else if(e==="levelintro"){const o=s?.level??1,n=s?.introText??"",l=s?.introChars??0,a=n.slice(0,l).replace(/\n/g,"<br>"),r=l>=n.length;this.overlay.innerHTML=`
        <div class="intro-level-label">Level ${o}</div>
        <div class="intro-typing">${a}${r?"":'<span class="intro-cursor">_</span>'}</div>
      `}else if(e==="levelselect")this.overlay.innerHTML=`
        <div class="menu-title">SELECT LEVEL</div>
        <div class="menu-controls-group">
          <div class="menu-controls">Press ESC to go back</div>
        </div>
        ${this.buildOptions(t)}
        <div class="menu-version">v${this.version}</div>
      `;else if(e==="levelcomplete"){let o="";s?.finalScore!==void 0&&(o+=`<div class="menu-score">Total Score: ${s.finalScore}</div>`);const n=s?.level?`LEVEL ${s.level} COMPLETE!`:"LEVEL COMPLETE!";this.overlay.innerHTML=`
        <div class="menu-title levelcomplete">${n}</div>
        ${o}
        ${this.buildOptions(t)}
      `}}buildOptions(e){return`<ul class="menu-options">${e.map((s,o)=>`<li class="menu-option" data-index="${o}">${s}</li>`).join("")}</ul>`}updateSelection(e){this.overlay.querySelectorAll(".menu-option").forEach((s,o)=>{s.classList.toggle("selected",o===e)})}show(){this.overlay.classList.add("visible")}hide(){this.overlay.classList.contains("visible")&&(this.overlay.classList.remove("visible"),this.lastMenuType=null,this.lastSelectedOption=-1,this.lastMenuDataHash="")}destroy(){this.overlay.remove(),this.styleEl.remove()}}function ge(i,e){for(const t of e){const s=Math.floor(t.brightness*255);i.fillStyle=`rgb(${s},${s},${s})`,t.brightness>.7&&(i.shadowBlur=2,i.shadowColor=`rgba(180, 200, 255, ${t.brightness*.5})`),i.fillRect(Math.floor(t.position.x),Math.floor(t.position.y),Math.ceil(t.size),Math.ceil(t.size)),t.brightness>.7&&(i.shadowBlur=0)}}function hi(i,e,t){return i+(e-i)*t}function Se(i,e,t){return{x:hi(i.x,e.x,t),y:hi(i.y,e.y,t)}}const di={red:{fill:"#ff3344",glow:"#ff3344",cockpit:"#2244aa"},blue:{fill:"#0099ff",glow:"#0099ff",cockpit:"#aa2244"}};function ui(i,e,t,s,o){for(const n of e){if(!n.isAlive||n.deathSequence?.active)continue;const l=t.get(n.id),a=l?Se(l.position,n.position,s):n.position,r=di[n.shipColor]||di.red;if(i.save(),n.isInvulnerable){const f=Math.floor(o/100)%2===0;i.globalAlpha=f?1:.3}i.shadowBlur=12,i.shadowColor=r.glow,i.fillStyle=r.fill,i.beginPath(),i.moveTo(a.x,a.y-14),i.lineTo(a.x-12,a.y+12),i.lineTo(a.x+12,a.y+12),i.closePath(),i.fill(),i.shadowBlur=0,i.fillStyle=r.cockpit,i.fillRect(a.x-2,a.y-2,4,6),i.shadowBlur=6,i.shadowColor="#ffaa22",i.fillStyle="#ffff44",i.fillRect(a.x-5,a.y+10,3,3),i.fillRect(a.x+2,a.y+10,3,3),i.shadowBlur=0,i.restore()}}const pi={A:{fill:"#00ff44",glow:"#00ff44",accent:"#44ee66"},B:{fill:"#00ccff",glow:"#00ccff",accent:"#44bbee"},C:{fill:"#ff5500",glow:"#ff5500",accent:"#ff8822"},D:{fill:"#ff00ff",glow:"#ff00ff",accent:"#ff66ff"},E:{fill:"#ffff00",glow:"#ffff00",accent:"#ffff66"},F:{fill:"#00ff88",glow:"#00ff88",accent:"#44ffaa"}};function mi(i,e,t,s){for(const o of e){if(!o.isAlive)continue;const n=t.get(o.id),l=n?Se(n.position,o.position,s):o.position,a=pi[o.type]||pi.A;i.save(),i.shadowBlur=10,i.shadowColor=a.glow,o.type==="A"?Rs(i,l.x,l.y,a):o.type==="B"?Ls(i,l.x,l.y,a):o.type==="C"?Cs(i,l.x,l.y,a):o.type==="D"?bs(i,l.x,l.y,a):o.type==="F"?ks(i,l.x,l.y,a):Is(i,l.x,l.y,a),i.restore()}}function Rs(i,e,t,s){i.fillStyle=s.fill,i.fillRect(e-4,t-12,8,4),i.fillRect(e-8,t-8,16,10),i.fillRect(e-6,t+2,12,4),i.fillRect(e-10,t+6,4,5),i.fillRect(e+6,t+6,4,5),i.fillRect(e-2,t+6,4,5),i.fillStyle=s.accent,i.fillRect(e-2,t-10,4,2),i.shadowBlur=0,i.fillStyle="#ff2222",i.fillRect(e-5,t-5,3,3),i.fillRect(e+2,t-5,3,3),i.fillStyle="#ffffff",i.fillRect(e-4,t-4,1,1),i.fillRect(e+3,t-4,1,1)}function Ls(i,e,t,s){i.fillStyle=s.fill,i.fillRect(e-8,t-12,16,4),i.fillRect(e-10,t-8,20,6),i.fillRect(e-12,t-2,24,8),i.fillRect(e-8,t+6,16,4),i.fillStyle="#006699",i.fillRect(e-10,t-2,4,4),i.fillRect(e+6,t-2,4,4),i.shadowBlur=0,i.fillStyle="#ffaa22",i.fillRect(e-6,t-6,4,3),i.fillRect(e+2,t-6,4,3),i.fillStyle="#ffffff",i.fillRect(e-5,t-5,2,1),i.fillRect(e+3,t-5,2,1),i.fillStyle=s.accent,i.fillRect(e-4,t+2,8,2)}function Cs(i,e,t,s){i.fillStyle=s.fill,i.beginPath(),i.moveTo(e,t-12),i.lineTo(e-6,t-4),i.lineTo(e+6,t-4),i.closePath(),i.fill(),i.fillRect(e-8,t-4,16,6),i.fillRect(e-14,t+2,28,4),i.fillRect(e-4,t+6,8,4),i.fillStyle=s.accent,i.fillRect(e-14,t+4,4,2),i.fillRect(e+10,t+4,4,2),i.shadowBlur=0,i.fillStyle="#44ff44",i.fillRect(e-4,t-2,3,2),i.fillRect(e+1,t-2,3,2)}function bs(i,e,t,s){i.fillStyle=s.fill,i.beginPath(),i.arc(e,t+4,12,Math.PI*1.15,Math.PI*1.85),i.lineTo(e+8,t-8),i.arc(e,t+4,8,Math.PI*1.85,Math.PI*1.15,!0),i.closePath(),i.fill(),i.fillRect(e-13,t-8,4,6),i.fillRect(e+9,t-8,4,6),i.fillStyle=s.accent,i.fillRect(e-3,t+8,6,5),i.shadowBlur=0,i.fillStyle="#ffffff",i.fillRect(e-2,t-2,4,3),i.fillStyle="#ff00ff",i.fillRect(e-1,t-1,2,1)}function Is(i,e,t,s){i.fillStyle=s.fill,i.beginPath(),i.moveTo(e,t+8),i.lineTo(e-18,t-6),i.lineTo(e-14,t-10),i.lineTo(e-4,t-2),i.lineTo(e,t-6),i.lineTo(e+4,t-2),i.lineTo(e+14,t-10),i.lineTo(e+18,t-6),i.closePath(),i.fill(),i.fillStyle=s.accent,i.fillRect(e-8,t-5,3,3),i.fillRect(e+5,t-5,3,3),i.shadowBlur=0,i.fillStyle="#ff4444",i.fillRect(e-3,t+2,6,2),i.fillStyle=s.accent,i.fillRect(e-17,t-8,3,2),i.fillRect(e+14,t-8,3,2)}function ks(i,e,t,s){i.fillStyle=s.fill,i.beginPath(),i.moveTo(e,t+10),i.lineTo(e-20,t-8),i.lineTo(e-16,t-12),i.lineTo(e-6,t-4),i.lineTo(e,t-8),i.lineTo(e+6,t-4),i.lineTo(e+16,t-12),i.lineTo(e+20,t-8),i.closePath(),i.fill(),i.fillStyle=s.accent,i.fillRect(e-10,t-6,4,4),i.fillRect(e+6,t-6,4,4),i.fillStyle="#006644",i.fillRect(e-3,t+2,6,4),i.shadowBlur=0,i.fillStyle="#ff2222",i.fillRect(e-4,t-1,8,2),i.fillStyle=s.accent,i.fillRect(e-19,t-10,3,2),i.fillRect(e+16,t-10,3,2)}const yi=[.35,.2,.1,.04],Os=8;function vi(i,e,t,s){for(const o of e){if(!o.isActive)continue;const n=t.get(o.id),l=n?Se(n.position,o.position,s):o.position,a=o.velocity.x,r=o.velocity.y,f=Math.sqrt(a*a+r*r),h=f>0?a/f:0,c=f>0?r/f:-1;if(o.type==="laser")Y(i,l.x,l.y,h,c,"#00ffff",4,12);else if(o.type==="plasma")Y(i,l.x,l.y,h,c,"#ff00ff",6,10);else if(o.type==="rocket")Y(i,l.x,l.y,h,c,"#aa44ff",5,10);else if(o.type==="missile")Y(i,l.x,l.y,h,c,"#44ff44",3,6);else if(o.type==="snake")Y(i,l.x,l.y,h,c,"#00ffff",8,14);else{const g=o.owner.type==="player"?"#ff4444":"#ff8800";Y(i,l.x,l.y,h,c,g,4,6)}if(i.save(),o.type==="laser")i.shadowBlur=8,i.shadowColor="#00ffff",i.fillStyle="#00ffff",i.fillRect(l.x-2,l.y-6,4,12),i.shadowBlur=0,i.fillStyle="#ffffff",i.fillRect(l.x-1,l.y-5,2,10);else if(o.type==="plasma")i.shadowBlur=12,i.shadowColor="#ff00ff",i.fillStyle="#ff00ff",i.fillRect(l.x-3,l.y-5,6,10),i.shadowBlur=0,i.fillStyle="#ffffff",i.fillRect(l.x-1,l.y-3,2,6);else if(o.type==="rocket")i.shadowBlur=10,i.shadowColor="#8800ff",i.fillStyle="#aa44ff",i.fillRect(l.x-2.5,l.y-5,5,10),i.shadowBlur=0,i.fillStyle="#ffffff",i.fillRect(l.x-1,l.y-5,2,3),i.fillStyle="#cc88ff",i.fillRect(l.x-2,l.y+3,4,4);else if(o.type==="missile")i.shadowBlur=4,i.shadowColor="#44ff44",i.fillStyle="#44ff44",i.fillRect(l.x-1.5,l.y-4,3,8),i.shadowBlur=0,i.fillStyle="#88ffaa",i.fillRect(l.x-1,l.y+2,2,3);else if(o.type==="snake")i.shadowBlur=16,i.shadowColor="#00ffff",i.fillStyle="#00ffff",i.fillRect(l.x-4,l.y-7,8,14),i.shadowBlur=0,i.fillStyle="#ffffff",i.fillRect(l.x-2,l.y-5,4,10);else{const u=o.owner.type==="player",g=u?"#ff4444":"#ffff00",y=u?"#ff4444":"#ff8800";i.shadowBlur=6,i.shadowColor=y,i.fillStyle=g,i.fillRect(l.x-2,l.y-3,4,6),i.shadowBlur=0,i.fillStyle="#ffffff",i.fillRect(l.x-1,l.y-2,2,4)}i.restore()}}function Y(i,e,t,s,o,n,l,a){i.save(),i.globalCompositeOperation="lighter";for(let r=0;r<yi.length;r++){const f=(r+1)*Os,h=e-s*f,c=t-o*f,u=1-(r+1)*.15;i.globalAlpha=yi[r],i.fillStyle=n;const g=l*u,y=a*u;i.fillRect(h-g/2,c-y/2,g,y)}i.restore()}function _s(i,e){if(!e.isAlive&&!e.deathSequence)return;const{x:t,y:s}=e.position,o=e.width/2,n=e.height/2;i.save(),i.globalAlpha=.5,i.fillStyle="#1a2233",i.beginPath(),i.moveTo(t-o,s-n*.3),i.lineTo(t-o*.7,s-n),i.lineTo(t+o*.7,s-n),i.lineTo(t+o,s-n*.3),i.lineTo(t+o*.9,s+n),i.lineTo(t-o*.9,s+n),i.closePath(),i.fill(),i.strokeStyle="#2a3344",i.lineWidth=1,i.beginPath(),i.moveTo(t-o*.5,s-n*.5),i.lineTo(t-o*.5,s+n*.8),i.moveTo(t+o*.5,s-n*.5),i.lineTo(t+o*.5,s+n*.8),i.moveTo(t-o*.8,s),i.lineTo(t+o*.8,s),i.stroke(),i.restore()}function Ds(i,e){if(!e.isAlive&&!e.deathSequence)return;const{x:t,y:s}=e.position;for(const r of e.turrets){if(i.save(),r.isAlive){const f=r.fireType==="rocket"?{glow:"#ff3300",base:"#882200",barrel:"#aa3300",cap:"#ff5533"}:r.fireType==="homing"?{glow:"#00ff66",base:"#005522",barrel:"#00aa44",cap:"#33ff88"}:{glow:"#ff8800",base:"#885500",barrel:"#aa6600",cap:"#ffaa44"};i.shadowBlur=12,i.shadowColor=f.glow,i.fillStyle=f.base,i.fillRect(r.position.x-14,r.position.y-10,28,20),i.fillStyle=f.barrel,i.fillRect(r.position.x-4,r.position.y+8,8,14),i.fillStyle=f.cap,i.beginPath(),i.arc(r.position.x,r.position.y,10,0,Math.PI*2),i.fill(),i.shadowBlur=0;const h=r.health/r.maxHealth,c=20;i.fillStyle="#333333",i.fillRect(r.position.x-c/2,r.position.y-16,c,3),i.fillStyle=h>.5?"#44ff44":"#ff4444",i.fillRect(r.position.x-c/2,r.position.y-16,c*h,3)}else i.fillStyle="#332211",i.fillRect(r.position.x-12,r.position.y-8,24,16),i.fillStyle="#221100",i.beginPath(),i.arc(r.position.x,r.position.y,8,0,Math.PI*2),i.fill();i.restore()}const o=e.turrets.every(r=>!r.isAlive);i.save(),o&&e.health>0?(i.shadowBlur=15,i.shadowColor="#ff0000",i.fillStyle="#882222"):(i.shadowBlur=6,i.shadowColor="#4466aa",i.fillStyle="#334466");const n=e.width*.2,l=e.height*.25;i.fillRect(t-n/2,s+e.height*.15,n,l),i.shadowBlur=0;const a=o?"#ff4444":"#4488ff";if(i.fillStyle=a,i.fillRect(t-n*.3,s+e.height*.2,n*.6,l*.4),o&&e.health>0){const r=n,f=e.health/e.maxHealth;i.fillStyle="#333333",i.fillRect(t-r/2,s+e.height*.1,r,4),i.fillStyle=f>.3?"#ff4444":"#ff0000",i.fillRect(t-r/2,s+e.height*.1,r*f,4)}i.restore()}function Ns(i,e,t){for(const s of e){if(!s.isActive)continue;const{x:o,y:n}=s.position,a=8*(.8+.2*Math.sin(t*.005));i.save(),i.shadowBlur=10,i.shadowColor="#ff4466",i.fillStyle="#ff2244",i.beginPath(),i.moveTo(o,n+a*.4),i.bezierCurveTo(o-a,n-a*.3,o-a*.5,n-a,o,n-a*.4),i.bezierCurveTo(o+a*.5,n-a,o+a,n-a*.3,o,n+a*.4),i.fill(),i.restore()}}function gi(i,e,t,s){i.save(),i.font="16px monospace";const o=e.players.find(l=>l.id==="player1");if(o){const l=e.gameMode==="co-op"?"P1 ":"";i.fillStyle="#ffffff",i.textAlign="right",i.fillText(`${l}Score: ${o.score}`,p-10,24),i.fillText(`${l}Lives: ${o.lives}`,p-10,44)}const n=e.players.find(l=>l.id==="player2");if(n&&(i.fillStyle="#4488ff",i.textAlign="right",i.fillText(`P2 Score: ${n.score}`,p-10,68),i.fillText(`P2 Lives: ${n.lives}`,p-10,88)),i.font="14px monospace",i.fillStyle="#aaaaaa",i.textAlign="center",i.fillText(`Level ${e.currentLevel} - Wave ${e.currentWave}`,p/2,24),i.font="12px monospace",i.fillStyle="#88ff88",i.textAlign="left",i.fillText(`Engine: ${t} | Render: ${s}`,10,20),o){i.font="10px monospace",i.fillStyle="#aaaaaa",i.textAlign="left";const l=o.primaryWeapon==="laser"?"#4488ff":"#ff4444",a="".repeat(o.primaryLevel)+"".repeat(4-o.primaryLevel);i.fillStyle=l,i.fillText(`${o.primaryWeapon.toUpperCase()} ${a}`,10,780)}if(o?.secondaryWeapon){const r=p/2-50,f=780,h=Math.max(0,o.secondaryTimer/ze),u={rocket:"#aa44ff",missile:"#44ff44"}[o.secondaryWeapon]??"#ffffff";i.fillStyle="#333333",i.fillRect(r,f,100,6),i.fillStyle=u,i.fillRect(r,f,100*h,6),i.font="10px monospace",i.fillStyle="#ffffff",i.textAlign="center",i.fillText(o.secondaryWeapon.toUpperCase(),p/2,f-4)}if(o){const r=p-80-10,f=780,h=Math.max(0,o.health/o.maxHealth);let c;h>.6?c="#44ff44":h>.3?c="#ffff44":c="#ff4444",i.fillStyle="#333333",i.fillRect(r,f,80,6),i.fillStyle=c,i.fillRect(r,f,80*h,6),i.font="10px monospace",i.fillStyle="#aaaaaa",i.textAlign="right",i.fillText("SHIELD",p-10,f-4)}i.restore()}const le={A:["#00ff44","#66ff88","#ffffff"],B:["#00ccff","#55ddff","#ffffff"],C:["#ff5500","#ff9933","#ffffff"],D:["#ff00ff","#ff66ff","#ffffff"],E:["#ffff00","#ffff66","#ffffff"],F:["#00ff88","#44ffaa","#ffffff"],player:["#ff3344","#ff7755","#ffffff"],asteroid:["#886644","#aa8855","#ccaa77"],bossTurret:["#ff8800","#ffaa44","#ffffff"],bossBridge:["#ff4400","#ff6622","#ffaa44","#ffffff"],default:["#ffcc00","#ff5500","#ffffff"]};class Bs{constructor(){this.particles=[],this.flashes=[],this.explodedEntities=new Set,this.impactedProjectiles=new Set,this.shakeOffsetX=0,this.shakeOffsetY=0,this.shakeTimer=0,this.shakeDuration=0,this.shakeIntensity=0}emit(e,t,s,o){if(this.explodedEntities.has(s))return;this.explodedEntities.add(s);const n=le[o]||le.default,l=o==="player",a=l?35:20,r=l?200:150,f=l?600:400;for(let h=0;h<a;h++){const c=Math.random()*Math.PI*2,u=30+Math.random()*r,g=n[Math.floor(Math.random()*n.length)];this.particles.push({x:e,y:t,vx:Math.cos(c)*u,vy:Math.sin(c)*u,color:g,life:f,maxLife:f,size:2+Math.random()*3})}l&&(this.shakeTimer=0,this.shakeDuration=150,this.shakeIntensity=4)}emitLargeExplosion(e,t,s,o){if(this.explodedEntities.has(s))return;this.explodedEntities.add(s);const n=o==="bossBridge",l=le[o]||le.default,a=n?150:50,r=n?450:250,f=n?1500:800;for(let h=0;h<a;h++){const c=Math.random()*Math.PI*2,u=40+Math.random()*r,g=l[Math.floor(Math.random()*l.length)];this.particles.push({x:e,y:t,vx:Math.cos(c)*u,vy:Math.sin(c)*u,color:g,life:f,maxLife:f,size:n?4+Math.random()*6:3+Math.random()*4})}this.shakeTimer=0,this.shakeDuration=n?600:200,this.shakeIntensity=n?15:5}emitImpactFlash(e,t,s,o="#ffffff"){this.impactedProjectiles.has(s)||(this.impactedProjectiles.add(s),this.flashes.push({x:e,y:t,radius:20,color:o,life:60,maxLife:60,isScreenFlash:!1}))}update(e){for(let t=this.particles.length-1;t>=0;t--){const s=this.particles[t],o=e/1e3;s.x+=s.vx*o,s.y+=s.vy*o,s.vy+=50*o,s.vx*=.99,s.vy*=.99,s.life-=e,s.life<=0&&this.particles.splice(t,1)}for(let t=this.flashes.length-1;t>=0;t--)this.flashes[t].life-=e,this.flashes[t].life<=0&&this.flashes.splice(t,1);if(this.shakeTimer<this.shakeDuration){this.shakeTimer+=e;const t=1-this.shakeTimer/this.shakeDuration;this.shakeOffsetX=(Math.random()-.5)*2*this.shakeIntensity*t,this.shakeOffsetY=(Math.random()-.5)*2*this.shakeIntensity*t}else this.shakeOffsetX=0,this.shakeOffsetY=0}draw(e){for(const t of this.flashes){const s=Math.max(0,t.life/t.maxLife);if(e.save(),t.isScreenFlash)e.globalCompositeOperation="lighter",e.globalAlpha=s*.12,e.fillStyle=t.color,e.fillRect(0,0,p,v);else{e.globalCompositeOperation="lighter";const o=e.createRadialGradient(t.x,t.y,0,t.x,t.y,t.radius);o.addColorStop(0,t.color),o.addColorStop(1,"transparent"),e.globalAlpha=s*.6,e.fillStyle=o,e.beginPath(),e.arc(t.x,t.y,t.radius,0,Math.PI*2),e.fill()}e.restore()}for(const t of this.particles){const s=Math.max(0,t.life/t.maxLife);e.save(),e.globalAlpha=s,e.fillStyle=t.color,s>.5&&(e.shadowBlur=6,e.shadowColor=t.color),e.fillRect(Math.floor(t.x-t.size/2),Math.floor(t.y-t.size/2),Math.ceil(t.size),Math.ceil(t.size)),e.restore()}}clearTracking(){this.explodedEntities.clear(),this.impactedProjectiles.clear(),this.particles=[],this.flashes=[],this.shakeTimer=0,this.shakeDuration=0,this.shakeOffsetX=0,this.shakeOffsetY=0}get activeCount(){return this.particles.length}get flashCount(){return this.flashes.length}}const Hs=""+new URL("earth-rcJ1oaF5.png",document.currentScript&&document.currentScript.tagName.toUpperCase()==="SCRIPT"&&document.currentScript.src||document.baseURI).href,Fs=""+new URL("moon-ID8Sgcb2.png",document.currentScript&&document.currentScript.tagName.toUpperCase()==="SCRIPT"&&document.currentScript.src||document.baseURI).href,Si=""+new URL("moon-small-Ct-oRMeY.png",document.currentScript&&document.currentScript.tagName.toUpperCase()==="SCRIPT"&&document.currentScript.src||document.baseURI).href,Us=""+new URL("asteroids-brown-Clkmp3V-.png",document.currentScript&&document.currentScript.tagName.toUpperCase()==="SCRIPT"&&document.currentScript.src||document.baseURI).href,Ws=""+new URL("asteroids-blue-Cm4PGCFG.png",document.currentScript&&document.currentScript.tagName.toUpperCase()==="SCRIPT"&&document.currentScript.src||document.baseURI).href,Ys=""+new URL("asteroids-purple-D8-1SGlL.png",document.currentScript&&document.currentScript.tagName.toUpperCase()==="SCRIPT"&&document.currentScript.src||document.baseURI).href,Xs=""+new URL("mars-De7HTeuz.png",document.currentScript&&document.currentScript.tagName.toUpperCase()==="SCRIPT"&&document.currentScript.src||document.baseURI).href,wi={1:[],2:[{url:Hs,x:400,y:100,scale:1.8,alpha:.15,scrollSpeed:12}],3:[{url:Fs,x:300,y:50,scale:1.4,alpha:.2,scrollSpeed:15},{url:Si,x:600,y:400,scale:.6,alpha:.12,scrollSpeed:10}],4:[{url:Us,x:200,y:0,scale:1,alpha:.18,scrollSpeed:18},{url:Ws,x:550,y:300,scale:.8,alpha:.14,scrollSpeed:14},{url:Ys,x:650,y:600,scale:.7,alpha:.1,scrollSpeed:10}],5:[{url:Xs,x:350,y:80,scale:1.6,alpha:.18,scrollSpeed:8},{url:Si,x:620,y:500,scale:.5,alpha:.12,scrollSpeed:12}]};class Gs{constructor(e){this.engineFps=0,this.renderFps=0,this.lastRenderTime=0,this.lastGameStatus="",this.lastBossTurretAlive=[],this.lastBossHealth=0,this.bgImageCache=new Map,this.bgScrollOffsets=[],this.currentBgLevel=-1;const t=document.getElementById(e);if(!t)throw new Error(`Container #${e} not found`);t.style.position="relative",this.canvas=document.createElement("canvas"),this.canvas.width=p,this.canvas.height=v,this.canvas.style.display="block",t.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this.particleSystem=new Bs,this.menuOverlay=new Ps(t)}setFpsCounters(e,t){this.engineFps=e,this.renderFps=t}render(e,t,s){const o=this.ctx,n=performance.now(),l=this.lastRenderTime>0?n-this.lastRenderTime:16.667;this.lastRenderTime=n,e.gameStatus==="playing"&&this.lastGameStatus!=="playing"&&this.particleSystem.clearTracking(),this.lastGameStatus=e.gameStatus,o.fillStyle="#000",o.fillRect(0,0,p,v),e.currentLevel!==this.currentBgLevel&&this.loadBackgrounds(e.currentLevel);const a=e.gameStatus==="paused"?0:l;if(this.drawBackgrounds(o,e.currentLevel,a),this.particleSystem.update(l),e.gameStatus==="menu"||e.gameStatus==="gameover"||e.gameStatus==="levelcomplete"||e.gameStatus==="levelintro"){e.background&&ge(o,e.background.stars),this.particleSystem.draw(o),this.menuOverlay.update(e);return}if(e.gameStatus==="paused"){const c=new Map(t.players.map(y=>[y.id,y])),u=new Map(t.enemies.map(y=>[y.id,y])),g=new Map(t.projectiles.map(y=>[y.id,y]));e.background&&ge(o,e.background.stars),mi(o,e.enemies,u,1),vi(o,e.projectiles,g,1),this.drawAsteroids(o,e.asteroids),this.drawWeaponPickups(o,e.weaponPickups,e.currentTime),ui(o,e.players,c,1,e.currentTime),this.particleSystem.draw(o),gi(o,e,this.engineFps,this.renderFps),this.menuOverlay.update(e);return}o.save(),o.translate(this.particleSystem.shakeOffsetX,this.particleSystem.shakeOffsetY);const r=new Map(t.players.map(c=>[c.id,c])),f=new Map(t.enemies.map(c=>[c.id,c])),h=new Map(t.projectiles.map(c=>[c.id,c]));this.detectDeaths(e),e.background&&ge(o,e.background.stars),e.boss&&_s(o,e.boss),mi(o,e.enemies,f,s),vi(o,e.projectiles,h,s),this.drawAsteroids(o,e.asteroids),this.drawWeaponPickups(o,e.weaponPickups,e.currentTime),Ns(o,e.lifePickups,e.currentTime),ui(o,e.players,r,s,e.currentTime),e.boss&&Ds(o,e.boss),this.particleSystem.draw(o),o.restore(),gi(o,e,this.engineFps,this.renderFps),this.menuOverlay.update(e)}detectDeaths(e){for(const t of e.enemies)!t.isAlive&&t.collisionState==="destroyed"&&this.particleSystem.emit(t.position.x,t.position.y,t.id,t.type);for(const t of e.players)t.isAlive||this.particleSystem.emit(t.position.x,t.position.y,t.id,"player");for(const t of e.asteroids)t.isAlive||this.particleSystem.emit(t.position.x,t.position.y,t.id,"asteroid");if(e.boss){for(let t=0;t<e.boss.turrets.length;t++){const s=e.boss.turrets[t];(this.lastBossTurretAlive[t]??!0)&&!s.isAlive&&this.particleSystem.emitLargeExplosion(s.position.x,s.position.y,s.id,"bossTurret")}if(this.lastBossTurretAlive=e.boss.turrets.map(t=>t.isAlive),this.lastBossHealth>0&&e.boss.health<=0&&e.boss.deathSequence&&this.particleSystem.emitLargeExplosion(e.boss.position.x,e.boss.position.y,"boss-bridge","bossBridge"),this.lastBossHealth=e.boss.health,e.boss.deathSequence){const t=e.boss.deathSequence.phase,s=e.boss.turrets.length;if(t<s){const o=e.boss.turrets[t];o&&this.particleSystem.emitLargeExplosion(o.position.x,o.position.y,`boss-death-phase-${t}`,"bossTurret")}else t===s&&this.particleSystem.emitLargeExplosion(e.boss.position.x,e.boss.position.y,"boss-death-final","bossBridge")}}for(const t of e.enemies)!t.isAlive&&t.collisionState==="destroyed"&&t.type==="F"&&this.particleSystem.emitLargeExplosion(t.position.x,t.position.y,`${t.id}-large`,"F");for(const t of e.projectiles)if(t.hasCollided&&!t.isActive){const s=t.owner.type==="player"?"#00ffff":"#ff8800";this.particleSystem.emitImpactFlash(t.position.x,t.position.y,t.id,s)}}loadBackgrounds(e){this.currentBgLevel=e;const t=wi[e]??[];this.bgScrollOffsets=t.map(()=>0);for(const s of t)if(!this.bgImageCache.has(s.url)){const o=new Image;o.src=s.url,this.bgImageCache.set(s.url,o)}}drawBackgrounds(e,t,s){const o=wi[t]??[];if(o.length!==0)for(let n=0;n<o.length;n++){const l=o[n],a=this.bgImageCache.get(l.url);if(!a||!a.complete)continue;this.bgScrollOffsets[n]+=l.scrollSpeed*s/1e3;const r=a.height*l.scale,f=a.width*l.scale,h=-(r/2)-l.y+this.bgScrollOffsets[n],c=l.x;h-r/2>v||h+r/2<0||(e.save(),e.globalAlpha=l.alpha,e.drawImage(a,c-f/2,h-r/2,f,r),e.restore())}}drawWeaponPickups(e,t,s){for(const o of t){if(!o.isActive)continue;const l={laser:"#4488ff",bullet:"#ff4444",rocket:"#aa44ff",missile:"#44ff44"}[o.currentWeapon]??"#ffffff",r=10*(.7+.3*Math.sin(s*.005));e.save(),e.shadowBlur=12,e.shadowColor=l,e.globalAlpha=.9,e.fillStyle=l,e.beginPath(),e.arc(o.position.x,o.position.y,r,0,Math.PI*2),e.fill(),e.shadowBlur=0,e.fillStyle="#ffffff",e.globalAlpha=.8,e.beginPath(),e.arc(o.position.x,o.position.y,r*.4,0,Math.PI*2),e.fill(),e.restore()}}drawAsteroids(e,t){for(const s of t){if(!s.isAlive)continue;const o=s.collisionRadius,n=s.size==="large"?8:6,l=s.size==="large"?"#887766":"#998877";e.save(),e.translate(s.position.x,s.position.y),e.rotate(s.rotation),e.shadowBlur=4,e.shadowColor="#665544",e.fillStyle=l,e.beginPath();for(let a=0;a<n;a++){const r=a/n*Math.PI*2,f=.8+.2*Math.sin(a*2.5),h=Math.cos(r)*o*f,c=Math.sin(r)*o*f;a===0?e.moveTo(h,c):e.lineTo(h,c)}e.closePath(),e.fill(),e.shadowBlur=0,e.fillStyle="#554433",e.beginPath(),e.arc(o*.2,-o*.2,o*.15,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(-o*.3,o*.1,o*.1,0,Math.PI*2),e.fill(),e.restore()}}destroy(){this.menuOverlay.destroy(),this.canvas.remove()}}function Ei(){const i=new Gs("game-container"),e=new Ms({renderer:i}),t=i.render.bind(i);i.render=(s,o,n)=>{i.setFpsCounters(e.gameLoop.engineFps,e.gameLoop.renderFps),t(s,o,n)},e.start(),window.__game=e}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ei):Ei()})();
//# sourceMappingURL=index-DSXynPZg.js.map
